Task 009 — Enable HTTP Access for ClickHouse in Docker Network
Цель
Сделать так, чтобы ClickHouse внутри docker-compose принимал HTTP‑подключения от других контейнеров (порт 8123), после чего подтвердить, что боевой запуск qtickets_api проходит без ошибок connection refused и данные попадают в staging.

Подробные шаги
1. Актуальная база и бэкап конфигурации
cd /opt/zakaz_dashboard/Zakaz_Dashboard/dashboard-mvp/infra/clickhouse
cp config.d/20-security.xml config.d/20-security.xml.bak.$(date +%Y%m%d%H%M%S)
2. Исправить конфигурацию прослушивания
Конфиг должен содержать строку <listen_host>0.0.0.0</listen_host> и не содержать IPv6, чтобы исключить ошибки EAI: Address family for hostname not supported. Полный вариант (ничего не менять внутри, просто вставьте командой):

cat <<'EOF' > config.d/20-security.xml
<clickhouse>
  <listen_host>0.0.0.0</listen_host>

  <logger>
    <level>information</level>
    <console>true</console>
    <query_log>
      <database>system</database>
      <table>query_log</table>
      <partition_by>toYYYYMM(event_date)</partition_by>
      <flush_interval_milliseconds>7500</flush_interval_milliseconds>
    </query_log>
    <query_thread_log>
      <database>system</database>
      <table>query_thread_log</table>
      <partition_by>toYYYYMM(event_date)</partition_by>
      <flush_interval_milliseconds>7500</flush_interval_milliseconds>
    </query_thread_log>
    <text_log>
      <database>system</database>
      <table>text_log</table>
      <partition_by>toYYYYMM(event_date)</partition_by>
      <flush_interval_milliseconds>7500</flush_interval_milliseconds>
    </text_log>
    <trace_log>
      <database>system</database>
      <table>trace_log</table>
      <partition_by>toYYYYMM(event_date)</partition_by>
      <flush_interval_milliseconds>7500</flush_interval_milliseconds>
    </trace_log>
  </logger>

  <merge_tree>
    <old_parts_lifetime>30</old_parts_lifetime>
  </merge_tree>

  <disable_internal_dns_cache>1</disable_internal_dns_cache>
  <remote_servers></remote_servers>

  <password_complexity>
    <min_length>12</min_length>
    <require_uppercase>1</require_uppercase>
    <require_lowercase>1</require_lowercase>
    <require_digits>1</require_digits>
    <require_special_characters>1</require_special_characters>
  </password_complexity>

  <default_session_timeout>3600</default_session_timeout>
  <max_session_timeout>86400</max_session_timeout>
  <max_concurrent_queries>100</max_concurrent_queries>

  <profiles>
    <default>
      <max_concurrent_queries_for_user>10</max_concurrent_queries_for_user>
    </default>
  </profiles>
</clickhouse>
EOF
Проверить:

cat config.d/20-security.xml
3. Перезапустить ClickHouse
docker compose down
docker compose up -d
docker ps --filter name=ch-zakaz
4. Проверить HTTP и сетевой доступ
curl http://127.0.0.1:8123/?query=SELECT%201
# должен вывести: 1

docker run --rm --network clickhouse_default curlimages/curl:8.4.0 \
  curl -sS http://ch-zakaz:8123/?query=SELECT%201
# тоже должен вернуть 1 изнутри сети
Если обе команды успешны, HTTP доступ исправен.

5. Прогнать боевой ingestion
Убедитесь, что dashboard-mvp/secrets/.env.qtickets_api заполнен боевыми значениями (DRY_RUN=false, реальный токен, организация, CLICKHOUSE_USER=admin, CLICKHOUSE_PASSWORD=admin_pass и т.д.).
Запустить:
docker run --rm \
  --network clickhouse_default \
  --env-file /opt/zakaz_dashboard/secrets/.env.qtickets_api \
  --name qtickets_api_run_$(date +%Y%m%d%H%M%S) \
  qtickets_api:prod
Убедиться по логам, что нет ошибок Unexpected ClickHouse error: 1. Ожидается завершение без stack trace.
6. Проверить данные
docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT max(sale_ts) AS last_order_ts,
           count() AS orders_loaded
    FROM zakaz.stg_qtickets_api_orders_raw;
"

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT job, status, started_at, finished_at, rows_processed
    FROM zakaz.meta_job_runs
    WHERE job = 'qtickets_api'
    ORDER BY started_at DESC
    LIMIT 5;
"
Должны увидеть:

свежий last_order_ts и >0 строк в stg_qtickets_api_orders_raw;
в meta_job_runs последняя запись status = 'ok' с реальным числом обработанных строк.
Definition of Done
Из контейнера интеграции запрос http://ch-zakaz:8123 возвращает 1.
Контейнер qtickets_api:prod завершает прогон без connection refused и error: 1.
В ClickHouse появляются новые данные в таблицах stg_qtickets_api_*, а meta_job_runs фиксирует успешное выполнение.
Подготовлены и приложены выводы команд curl, docker run … qtickets_api:prod, запросов проверки таблиц, плюс краткое описание изменений и результатов (в CHANGELOG-009 или аналогичном документе).
Изменения закоммичены.
После выполнения доложите с логами и выводами; если всё ок, можно переходить к e2e smoke для целого пайплайна.


Боевые данныве для Qtickets
Адрес персональной страницы https://irs-prod.qtickets.ru
Ваш уникальный код в Qtickets: irs-prod
Токен API: 4sUsl5DFJA8DTUlXa3ZOANcILE0g1TKZ
