Task 014 — Подготовка репозитория к интеграции с Яндекс DataLens

Цель: полностью автоматизировать создание пользователя datalens_reader в ClickHouse, назначение ему прав, конфиг по умолчанию и документацию, чтобы при любом развёртывании (docker compose up) DataLens уже мог подключаться без ручных действий.

Шаги
1. Добавить конфигурацию пользователя в репозиторий
Создай файл
dashboard-mvp/infra/clickhouse/users.d/datalens-user.xml

Содержимое:

<clickhouse>
  <users>
    <datalens_reader>
      <password><![CDATA[ChangeMe123!]]></password>
      <profile>readonly</profile>
      <quota>default</quota>
      <networks>
        <ip>::/0</ip>
      </networks>
      <grants>
        <grant>SELECT ON zakaz.*</grant>
      </grants>
    </datalens_reader>
  </users>
</clickhouse>
(пароль должен быть заметен как placeholder с пометкой oб необходимости сменить в продакшн-окружении, можно добавить комментарий).

2. Убедиться, что admin имеет access_management
В файле dashboard-mvp/infra/clickhouse/users.d/default-user.xml убедиться, что внутри блока <admin> есть:

<access_management>1</access_management>
Если отсутствует — добавить.

3. Обновить README по инфраструктуре ClickHouse
Файл dashboard-mvp/infra/clickhouse/README.md дополнить разделом, где указано:
После docker compose up -d автоматически поднимаются пользователи admin и datalens_reader (вставить пароли и доступные сети).
Чтобы изменить пароль для DataLens, нужно поправить users.d/datalens-user.xml и перезапустить сервис.
Как проверить подключение: curl -u datalens_reader:... http://<host>:8123/?query=SELECT%201.
4. Обновить основной гайд по развёртыванию
В корневом README.md или отдельном прод-документе добавить пункт «Подключение Яндекс DataLens», где:
Указан публичный порт (8123).
Прописан пользователь datalens_reader и права.
Есть 3 шага: открыть порт, подтвердить curl, указать параметры в интерфейсе DataLens. Ссылку дать на обновлённый README из шага 3.
5. Проверка
Локально запустить docker compose up -d из dashboard-mvp/infra/clickhouse.
Убедиться, что:
docker exec ch-zakaz clickhouse-client --user=datalens_reader --password=ChangeMe123! -q "SELECT count() FROM system.tables WHERE database='zakaz';"
работает без ошибок (вернёт число таблиц).
6. Документация и коммит
Добавить информацию в docs/changelog/CHANGELOG-014.md: что сделано для DataLens.
Обновить ZAKAZ_DASHBOARD_AUDIT_REPORT.md.
Коммит:
git add dashboard-mvp/infra/clickhouse/users.d/datalens-user.xml \
        dashboard-mvp/infra/clickhouse/users.d/default-user.xml \
        dashboard-mvp/infra/clickhouse/README.md \
        docs/changelog/CHANGELOG-014.md \
        ZAKAZ_DASHBOARD_AUDIT_REPORT.md
git commit -m "Task 014: prepare ClickHouse for DataLens integration"
7. Чтобы заказчик мог переиспользовать
В changelog и/или README пометить: при реальном развёртывании пароль ChangeMe123! нужно сменить (например, инструкцией sed -i или через docker exec команду ALTER USER datalens_reader IDENTIFIED WITH plaintext_password BY ...).
Предусмотреть, что если используют HTTPS или прокси — документировать отдельно (не реализовано кодом, но важно упомянуть).
Definition of Done

users.d/datalens-user.xml присутствует, выдаёт права автоматически.
README в infra/clickhouse описывает DataLens подключение и смену пароля.
Появилась запись в changelog + audit report.
После docker compose up -d пользователь datalens_reader доступен без ручного GRANT.
Версия с коммитом готова к git push.