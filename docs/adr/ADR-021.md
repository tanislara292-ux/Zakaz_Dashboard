# ADR-021: Убрать авто-создание дефолтного пользователя в ClickHouse

**Дата:** 2025-11-03
**Контекст:** При запуске образа clickhouse/clickhouse-server entrypoint создаёт default-user.xml, если в переменных окружения присутствуют CLICKHOUSE_USER/CLICKHOUSE_PASSWORD/CLICKHOUSE_DB. Это ломает нашу конфигурацию из users.d/00-admin.xml и вызывает «Authentication failed». Задача — навсегда исключить повторное создание дефолтного пользователя.

**Решение:** Удалить из docker-compose.yml переменные окружения CLICKHOUSE_USER, CLICKHOUSE_PASSWORD, CLICKHOUSE_DB, которые передаются контейнеру ClickHouse. Администратор должен создаваться исключительно через users.d/00-admin.xml. Переменные должны использоваться только скриптами bootstrap для подключения к ClickHouse.

**Контракты данных:** Изменений в схемах данных нет, это чисто инфраструктурное изменение.

**Риски:**
- Может сломаться healthcheck в docker-compose.yml, если он использует переменные окружения
- Скрипты bootstrap могут перестать работать, если они ожидают переменные окружения в контейнере

**Тест-план:**
- Проверить запуск ClickHouse после изменений (должен быть healthy)
- Проверить отсутствие default-user.xml в контейнере
- Проверить доступность admin пользователя
- Проверить работу smoke_qtickets_dryrun.sh

**Критерии приёмки (DoD):**
- Контейнер стартует в статусе healthy
- В каталоге users.d внутри контейнера отсутствует default-user.xml
- Команда SHOW USERS показывает admin, etl_writer, datalens_reader, backup_user; дефолтного пользователя нет
- README и .env.example отражают новый порядок работы
- scripts/bootstrap_clickhouse.sh падает, если убрать 00-admin.xml