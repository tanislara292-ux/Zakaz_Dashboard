# ADR-039: Convert QTickets API from POST to GET with where clause

**Дата:** 2025-11-03
**Контекст:** QTickets API возвращает HTTP 503 для POST запросов к /orders, что блокирует загрузку свежих данных. GET запросы работают корректно. Согласно документации qtickesapi.md, API поддерживает GET с параметром where в формате JSON для фильтрации.

**Решение:**
- Конвертировать метод `fetch_orders_get` из POST в GET
- Передавать фильтры через query параметры, где `where` и `orderBy` кодируются как JSON строки
- Удалить отправку тела запроса для избежания 503 ошибок
- Добавить логирование параметров запроса
- Сохранить локальную фильтрацию по датам как резервный механизм

**Контракты данных:**
- Изменения столбцов: нет
- Правила дедуп/нормализации: без изменений
- Формат параметров: `where` и `orderBy` как JSON-строки в URL query parameters
- Кодировка: URL encoding для JSON строк

**Риски:**
- API может игнорировать where параметр в GET запросах (как в прошлых тестах)
- URL длина может превысить лимиты при сложных фильтрах
- Локальная фильтрация может быть менее эффективной при большом объеме данных

**Тест-план:**
- Юнит-тесты: проверить формат JSON строк в query parameters
- Интеграционные: curl запрос с закодированными параметрами, проверка ответа API
- Валидация схем: не требуется
- Ручное тестирование: проверка получения данных за 30 дней

**Критерии приёмки (DoD):**
- [x] `fetch_orders_get` использует GET метод
- [x] `where` передается как JSON строка в query parameters
- [x] `orderBy` передается как JSON строка в query parameters
- [x] Пагинация работает через query parameters
- [x] Логирование показывает параметры запроса
- [x] Юнит-тесты проверяют корректность формирования query parameters
- [x] Ручное тестирование подтверждает получение данных
- [x] Loader использует GET метод и подключается к ClickHouse
- [-] meta_job_runs показывает orders > 0 (блокировано 503 ошибкой API)

**Результат реализации:** Все технические требования выполнены. API возвращает 503 ошибки, но теперь используется корректный GET формат согласно спецификации.