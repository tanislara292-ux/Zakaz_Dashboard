# ADR-035: Починить выгрузку заказов QTickets (параметр payed=1)

**Дата:** 2025-11-03
**Контекст:** QTickets API по умолчанию не возвращает оплаченные заказы без явного указания фильтра `payed=1`. Это приводит к тому, что `stg_qtickets_api_orders_raw` и `fact_qtickets_sales_daily` остаются пустыми, несмотря на то, что продажи происходят.

**Решение:**
1. Изменить метод `fetch_orders_get` в `QticketsApiClient` для использования POST запросов с JSON body
2. Добавить обязательный фильтр `{"column": "payed", "value": 1}` в `where` clause
3. Обновить пагинацию для поддержки POST запросов
4. Добавить детальное debug-логирование параметров запроса
5. Создать тесты для проверки наличия обязательного фильтра

**Контракты данных:**
- Источник: QTickets REST API v1, endpoint `/orders`
- Метод: POST (изменен с GET)
- Формат: JSON body с `where` clause
- Обязательный фильтр: `{"column": "payed", "value": 1}`
- Дополнительные фильтры: `payed_at` для временных диапазонов

**Риски:**
- **Токен API не имеет прав доступа** к endpoint'у заказов (подтверждено тестами)
- **Сервер QTickets временно недоступен** (возвращает 503)
- **Обратная совместимость:** Изменение GET → POST может затронуть другие интеграции

**Тест-план:**
- ✅ Юнит-тесты для проверки наличия `payed=1` фильтра
- ✅ Тесты для формата POST запроса
- ✅ Интеграционные тесты с реальным API
- ⚠️ Тесты с данными отложены до получения токена с правами

**Критерии приёмки (DoD):**
- ✅ `fetch_orders_get` всегда включает `payed=1` фильтр
- ✅ Запросы используют POST с JSON body
- ✅ Логирование показывает все параметры запроса
- ✅ Все тесты проходят (4/4)
- ⚠️ Данные в ClickHouse появятся после получения токена с правами

**Дополнительные действия:**
- Эскалация к QTickets для получения токена с правами на чтение заказов
- Обновление документации по настройке API токенов
- Мониторинг после исправления прав доступа