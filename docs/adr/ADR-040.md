# ADR-040: Full QTickets Stack Reset and Verification

**Дата:** 2025-11-05
**Контекст:** Необходимо восстановить "чистое" состояние инфраструктуры QTickets-стека (ClickHouse + Docker образ qtickets_api) и подтвердить, что dry-run и ручной запуск loader'а работают без ошибок. Требуется полная перезагрузка контура для исключения накопленных проблем и подтверждения работы свежего кода из main.

**Решение:**
- Полная очистка и удаление всех Docker контейнеров и образов QTickets
- Удаление данных ClickHouse и пересоздание с нуля
- Пересборка образа qtickets_api:latest из свежего кода
- Выполнение bootstrap-скрипта ClickHouse для создания схемы
- Прогон smoke-скрипта для проверки dry-run функциональности
- Ручной тест контейнера для полной верификации
- Запуск unit-тестов для проверки GET пути и fallback

**Контракты данных:**
- Изменения столбцов: нет (используется существующая схема)
- Правила дедуп/нормализации: без изменений
- ClickHouse таблицы: bootstrap_schema.sql с полным набором витрин
- Environment variables: DRY_RUN=true для тестовых запусков

**Риски:**
- Потеря существующих данных в ClickHouse при очистке (допустимо для dev-среды)
- Проблемы с правами доступа при создании каталогов данных
- Отсутствие зависимостей для pytest/юнит-тестов
- Сетевые проблемы при запуске Docker контейнеров

**Тест-план:**
- Smoke-скрипт: ./scripts/smoke_qtickets_dryrun.sh (exit code 0)
- Ручной запуск: docker run --rm ... qtickets_api:latest (без исключений)
- Unit-тесты: pytest integrations/qtickets_api/tests/test_client.py (4/4 pass)
- SQL-проверки: SELECT count() FROM meta_job_runs (ожидаем 0 для dry-run)

**Критерии приёмки (DoD):**
- [x] Git репозиторий чистый, main ветка обновлена
- [ ] ClickHouse контейнер поднят и работает
- [ ] Все требуемые таблицы созданы через bootstrap
- [ ] Образ qtickets_api:latest пересобран
- [ ] Smoke-скрипт выполнен успешно (exit code 0)
- [ ] Dry-run не оставляет записей в ClickHouse
- [ ] Ручной запуск завершается без исключений
- [ ] Unit-тесты проходят (4/4)
- [ ] Отчёт с логами и результатами создан