Task 011 — Расшифровать ошибку Unexpected ClickHouse error: 1
Цель
Получить точный текст ошибки ClickHouse во время боевого прогона qtickets_api, понять причину отказа INSERT и зафиксировать всё в отчёте.

Последовательность шагов (выполнять строго по пунктам)
1. Подготовка рабочих каталогов
Перейди в корень репозитория:
cd /opt/zakaz_dashboard/Zakaz_Dashboard
Создай папку для артефактов задачи:
mkdir -p logs/task011
2. Убедись, что ClickHouse исправно работает
Проверка контейнера:
docker ps --filter name=ch-zakaz
Статус должен быть Up ... (healthy).
Проверь HTTP-доступ из хоста:
curl -s -u admin:admin_pass "http://127.0.0.1:8123/?query=SELECT%201"
Ожидаем вывод 1.
Убедись, что ClickHouse конфиг слушает 0.0.0.0 (в файле dashboard-mvp/infra/clickhouse/config.d/20-security.xml есть <listen_host>0.0.0.0</listen_host>). Если конфиг меняешь, сделай бэкап и перезапусти ClickHouse (docker compose down → up -d).
3. Включи подробное логирование запросов
Запусти команду одной строкой (без обратных слэшей):
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "SET GLOBAL log_queries = 1"
Убедись, что нет ошибки синтаксиса.
Сбрасываем накопленные логи:
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "SYSTEM FLUSH LOGS"
4. Сохрани текущие системные логи (до запуска)
Это поможет сравнить “до” и “после”.

Серверные логи:
docker exec ch-zakaz tail -n 200 /var/log/clickhouse-server/clickhouse-server.log \
  > logs/task011/before_clickhouse-server.log

docker exec ch-zakaz tail -n 100 /var/log/clickhouse-server/clickhouse-server.err.log \
  > logs/task011/before_clickhouse-server.err.log
Query log:
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "
  SELECT event_time, type, query, exception_code, exception
  FROM system.query_log
  WHERE event_time >= now() - INTERVAL 15 MINUTE
  ORDER BY event_time DESC
  LIMIT 50
  FORMAT Vertical;
" > logs/task011/before_query_log.txt
Text log:
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "
  SELECT event_time, logger_name, level, message
  FROM system.text_log
  WHERE event_time >= now() - INTERVAL 15 MINUTE
  ORDER BY event_time DESC
  LIMIT 200
  FORMAT Vertical;
" > logs/task011/before_text_log.txt
5. Запусти ingestion в боевом режиме
Проверь, что dashboard-mvp/secrets/.env.qtickets_api содержит реальные значения:
DRY_RUN=false
QTICKETS_TOKEN=...
ORG_NAME=...
CLICKHOUSE_USER=admin, CLICKHOUSE_PASSWORD=admin_pass, CLICKHOUSE_HOST=ch-zakaz, CLICKHOUSE_PORT=8123
Запусти контейнер, сохранив весь вывод через tee:
docker run --rm \
  --network clickhouse_default \
  --env-file dashboard-mvp/secrets/.env.qtickets_api \
  --name qtickets_api_run_$(date +%Y%m%d%H%M%S) \
  qtickets_api:prod | tee logs/task011/qtickets_run.log
Дождись завершения процесса (он должен либо упасть, либо завершиться; нам важен полный вывод).
Запомни время начала/окончания прогона (будет удобно сверять с логами).
6. Сразу после прогона снова сбрось логи
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "SYSTEM FLUSH LOGS"
7. Сними последние записи логов
Серверные логи (после прогона):
docker exec ch-zakaz tail -n 200 /var/log/clickhouse-server/clickhouse-server.log \
  > logs/task011/after_clickhouse-server.log

docker exec ch-zakaz tail -n 100 /var/log/clickhouse-server/clickhouse-server.err.log \
  > logs/task011/after_clickhouse-server.err.log
system.text_log (только ошибки/фатальные):
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "
  SELECT event_time, logger_name, level, message
  FROM system.text_log
  WHERE event_time >= now() - INTERVAL 10 MINUTE
    AND level IN ('Error', 'Fatal')
  ORDER BY event_time DESC
  LIMIT 200
  FORMAT Vertical;
" > logs/task011/after_text_log.txt
system.query_log — только записи с ошибками:
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "
  SELECT event_time, type, query, exception_code, exception
  FROM system.query_log
  WHERE event_time >= now() - INTERVAL 10 MINUTE
    AND exception_code != 0
  ORDER BY event_time DESC
  LIMIT 200
  FORMAT Vertical;
" > logs/task011/after_query_log.txt
8. Попробуй выполнить ручной INSERT (важно!)
Нужно понять, падает ли запрос даже при простом примере.

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    INSERT INTO zakaz.stg_qtickets_api_orders_raw
    VALUES ('debug_order','debug_event','moscow', now(), 1, 10.0, 'RUB', 1, '12345678901234567890123456789012');
  " > logs/task011/manual_insert.log 2>&1
Если команда вернула ошибку — запиши точный текст (он будет в manual_insert.log).
Если вставка успешна, это тоже зафиксируй (файл будет пустой или без ошибок). Потом удалим строку вручную, если нужно.
9. Собери контрольные SELECT
Проверить, появились ли строки:

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT max(sale_ts) AS last_order_ts,
           count() AS orders_loaded
    FROM zakaz.stg_qtickets_api_orders_raw;
  " > logs/task011/orders_check.txt
Проверить job runs:

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT job, status, started_at, finished_at, rows_processed, message
    FROM zakaz.meta_job_runs
    WHERE job = 'qtickets_api'
    ORDER BY started_at DESC
    LIMIT 10;
  " > logs/task011/meta_job_runs.txt
Проверить инвентарь:

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT max(snapshot_ts) AS last_inventory_ts,
           count() AS inventory_rows
    FROM zakaz.stg_qtickets_api_inventory_raw;
  " > logs/task011/inventory_check.txt
10. Заархивируй все артефакты задачи
tar -czf logs/task011_bundle.tgz logs/task011
11. Документация и отчёт
Создай docs/changelog/CHANGELOG-011.md (или обнови текущий changelog) с описанием:
что делали (включили логирование, запустили ingestion, собрали логи);
какие ошибки поймали (цитата из after_query_log.txt / after_text_log.txt);
результат ручного INSERT;
статус таблиц (orders_check.txt, meta_job_runs.txt, inventory_check.txt).
Обнови ZAKAZ_DASHBOARD_AUDIT_REPORT.md:
добавь раздел про Task 011 и перечисли команды + ссылку на каталоги.
Проверь git status, добавь файлы (logs/task011, архив, changelog, отчёт), закоммить:
git add logs/task011 logs/task011_bundle.tgz docs/changelog/CHANGELOG-011.md ZAKAZ_DASHBOARD_AUDIT_REPORT.md
git commit -m "Task 011: capture ClickHouse insert error details"
12. Что предоставить в итоговом ответе
Упоминание, что все шаги выполнены.
Мирно поставить ссылки на ключевые файлы:
logs/task011/qtickets_run.log
logs/task011/after_query_log.txt
logs/task011/manual_insert.log
logs/task011/orders_check.txt, meta_job_runs.txt
CHANGELOG-011.md, ZAKAZ_DASHBOARD_AUDIT_REPORT.md
Коротко сформулировать, какой точно текст ошибки теперь видим (например: “Code: 53, DB::Exception: Type mismatch for column ...”), чтобы следующий инженер мог сразу переходить к исправлению.
Definition of Done
Собраны и сохранены все логи до и после запуска.
В qtickets_run.log зафиксирован полный вывод контейнера.
В after_query_log.txt/after_text_log.txt видно подробный текст конкретной ошибки.
Ручной INSERT либо подтверждён, либо даёт ошибку — и она зафиксирована.
SELECT-ы показывают текущий статус таблиц (пустые/не пустые).
Все материалы лежат в logs/task011/, есть архив logs/task011_bundle.tgz.
Changelog и audit report обновлены, изменения закоммичены.
После этого у нас на руках будет точная причина, и можно будет заводить следующую задачу на конкретное исправление.