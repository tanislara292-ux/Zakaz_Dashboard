Task 013 — ClickHouse Inserts: Поддержка списков словарей

Цель: устранить KeyError(1) при client.insert(...), из‑за того что в ClickHouseClient.insert() мы передаем список словарей без column_names. Нужно автоматически преобразовывать такие данные в табличный вид, чтобы драйвер clickhouse_connect принимал их без ошибок.

0. Подготовка
Перейти в корень репозитория:
cd /opt/zakaz_dashboard/Zakaz_Dashboard
Создать папку для артефактов задачи:
mkdir -p logs/task013
1. Исправление в ClickHouseClient.insert
Файл: dashboard-mvp/integrations/common/ch.py

Открой метод insert() (объявлен примерно на строке 163).
Перед вызовом _call_with_retry добавь логику:
Если data непустой и первый элемент — dict.
Если column_names не задан.
То:
Определи column_names = list(data[0].keys()).
Убедись, что все словари содержат одинаковые ключи; иначе логируй понятную ошибку и подними ValueError.
Сконвертируй data в список списков:
data = [[row.get(col) for col in column_names] for row in data]
Сохрани column_names и продолжай обычный вызов.
Добавь debug-лог, фиксирующий таблицу, количество строк и колонок:
logger.debug(
    "Insert into %s rows=%s columns=%s",
    table,
    len(data) if hasattr(data, '__len__') else 'unknown',
    column_names,
)
2. Сборка и тестирование
Собери обновлённый образ:
docker build \
  -f dashboard-mvp/integrations/qtickets_api/Dockerfile \
  -t qtickets_api:prod \
  dashboard-mvp
Проверь, что ClickHouse поднят и отвечает:
docker ps --filter name=ch-zakaz
curl -s -u admin:admin_pass "http://127.0.0.1:8123/?query=SELECT%201"
3. Боевой прогон Qtickets API
Убедись, что dashboard-mvp/secrets/.env.qtickets_api содержит боевые значения
(DRY_RUN=false, реальные QTICKETS_TOKEN, ORG_NAME, host/port/user/password).
Перезапусти ingestion c логированием:
docker run --rm \
  --network clickhouse_default \
  --env-file dashboard-mvp/secrets/.env.qtickets_api \
  --name qtickets_api_run_$(date +%Y%m%d%H%M%S) \
  qtickets_api:prod | tee logs/task013/qtickets_run.log
4. Верификация результатов
Проверить, что ошибок в логах нет:

В qtickets_run.log не должно быть KeyError.
По желанию: grep -i "error" logs/task013/qtickets_run.log.
Проверить таблицы:

docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "
  SELECT max(sale_ts) AS last_order_ts,
         count() AS orders_loaded
  FROM zakaz.stg_qtickets_api_orders_raw;
" > logs/task013/orders_check.txt

docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "
  SELECT max(snapshot_ts) AS last_inventory_ts,
         count() AS inventory_rows
  FROM zakaz.stg_qtickets_api_inventory_raw;
" > logs/task013/inventory_check.txt

docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "
  SELECT job, status, started_at, finished_at, rows_processed, message
  FROM zakaz.meta_job_runs
  WHERE job = 'qtickets_api'
  ORDER BY started_at DESC
  LIMIT 5;
" > logs/task013/meta_job_runs.txt
Если ingestion всё ещё падает, повтори SYSTEM FLUSH LOGS и собери system.query_log/system.text_log (по аналогии с Task 012), сохрани в logs/task013.

5. Архивация артефактов
tar -czf logs/task013_bundle.tgz logs/task013
6. Документация
Создай docs/changelog/CHANGELOG-013.md с описанием:
Какие изменения внесены в ClickHouseClient.insert.
Результат боевого прогона (успешный/ошибка + ссылки на логи, тексты ошибок).
Состояние таблиц (привести результаты из orders_check.txt и т.д.).
Обнови ZAKAZ_DASHBOARD_AUDIT_REPORT.md — добавь раздел про Task 013 (команды, выводы, путь к логам).
Проверка git и commit:
git status
git add dashboard-mvp/integrations/common/ch.py logs/task013 logs/task013_bundle.tgz docs/changelog/CHANGELOG-013.md ZAKAZ_DASHBOARD_AUDIT_REPORT.md
git commit -m "Task 013: convert dict rows before ClickHouse insert"
Definition of Done
ClickHouseClient.insert автоматически обрабатывает список словарей и передаёт корректный табличный формат в драйвер.
Лог qtickets_run.log показывает отсутствие KeyError(1) и других неожиданных исключений.
Таблицы stg_qtickets_api_orders_raw и stg_qtickets_api_inventory_raw содержат новые данные (см. orders_check.txt, inventory_check.txt).
meta_job_runs фиксирует успешный прогон.
Все артефакты лежат в logs/task013, архив создан.
Changelog и аудит‑репорт обновлены, изменения закоммичены.
После этого можно переходить к финальной проверке и развёртыванию.