PS C:\Users\79184> ssh root@83.136.235.26
root@83.136.235.26's password:
Welcome to Ubuntu 24.04.3 LTS (GNU/Linux 6.8.0-71-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro
Last login: Thu Oct 30 16:38:41 2025 from 172.16.5.34
root@museshow:~# cd /opt/zakaz_dashboard
root@museshow:/opt/zakaz_dashboard# git status            # убеждаемся, что рабочее дерево чистое
fatal: detected dubious ownership in repository at '/opt/zakaz_dashboard'
To add an exception for this directory, call:

        git config --global --add safe.directory /opt/zakaz_dashboard
root@museshow:/opt/zakaz_dashboard# cd /opt/zakaz_dashboard
root@museshow:/opt/zakaz_dashboard# git fetch --all
fatal: detected dubious ownership in repository at '/opt/zakaz_dashboard'
To add an exception for this directory, call:

        git config --global --add safe.directory /opt/zakaz_dashboard
root@museshow:/opt/zakaz_dashboard# git checkout main
fatal: detected dubious ownership in repository at '/opt/zakaz_dashboard'
To add an exception for this directory, call:

        git config --global --add safe.directory /opt/zakaz_dashboard
root@museshow:/opt/zakaz_dashboard# git pull --rebase origin main
fatal: detected dubious ownership in repository at '/opt/zakaz_dashboard'
To add an exception for this directory, call:

        git config --global --add safe.directory /opt/zakaz_dashboard
root@museshow:/opt/zakaz_dashboard# ls -ld /opt/zakaz_dashboard /opt/zakaz_dashboard/.git /opt/zakaz_dashboard/.git/config
drwxr-xr-x 7 etl  etl  4096 Oct 28 10:17 /opt/zakaz_dashboard
drwxr-xr-x 8 root root 4096 Oct 27 10:27 /opt/zakaz_dashboard/.git
-rw-r--r-- 1 root root  271 Oct 27 10:27 /opt/zakaz_dashboard/.git/config
root@museshow:/opt/zakaz_dashboard# # 1) Выравниваем владельца .git под etl
root@museshow:/opt/zakaz_dashboard# chown -R etl:etl /opt/zakaz_dashboard/.git
 выравниваем корень проекта
chown -R etl:etl /opt/zakaz_dashboard

# 3) Переходим под etl и проверяем
su - etl
cd /opt/zakaz_dashboard
git status
git fetch --all
git checkout main
git pull --rebase origin main
root@museshow:/opt/zakaz_dashboard#
root@museshow:/opt/zakaz_dashboard# # 2) (на всякий случай) выравниваем корень проекта
root@museshow:/opt/zakaz_dashboard# chown -R etl:etl /opt/zakaz_dashboard
root@museshow:/opt/zakaz_dashboard#
root@museshow:/opt/zakaz_dashboard# # 3) Переходим под etl и проверяем
root@museshow:/opt/zakaz_dashboard# su - etl
etl@museshow:~$ cd /opt/zakaz_dashboard
etl@museshow:/opt/zakaz_dashboard$ git status
On branch main
Your branch is up to date with 'origin/main'.

Changes not staged for commit:
  (use "git add/rm <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
        modified:   .env
        deleted:    dashboard-mvp/.editorconfig
        modified:   dashboard-mvp/.env.sample
        deleted:    dashboard-mvp/.github/workflows/etl_dispatch.yml
        modified:   dashboard-mvp/.gitignore
        deleted:    dashboard-mvp/.pre-commit-config.yaml
        deleted:    dashboard-mvp/CHANGELOG.md
        deleted:    dashboard-mvp/CHANGELOG_QTICKETS_SHEETS.md
        deleted:    dashboard-mvp/CHECKLIST_MAIL_DASHBOARD.md
        deleted:    dashboard-mvp/EPIC-CH-01-REPORT.md
        deleted:    dashboard-mvp/EPIC-CH-02-REPORT.md
        deleted:    dashboard-mvp/EPIC-CH-03-REPORT.md
        deleted:    dashboard-mvp/EPIC-CH-04-REPORT.md
        deleted:    dashboard-mvp/EPIC-CH-05-REPORT.md
        deleted:    dashboard-mvp/LICENSE
        deleted:    dashboard-mvp/PROTOCOL.md
        deleted:    dashboard-mvp/README.md
        deleted:    dashboard-mvp/README_MAIL_DASHBOARD.md
        deleted:    dashboard-mvp/TASK-DELIVERY-01-REPORT.md
        deleted:    dashboard-mvp/TASK-QT-SHEETS-ONLY-REPORT.md
        deleted:    dashboard-mvp/archive/README.md
        deleted:    dashboard-mvp/archive/appscript/README.md
        deleted:    dashboard-mvp/archive/appscript/qtickets_api_ingest.gs
        deleted:    dashboard-mvp/archive/sheets/logs.yaml
        deleted:    dashboard-mvp/archive/sheets/plans.yaml
        deleted:    dashboard-mvp/archive/sheets/qtickets.yaml
        deleted:    dashboard-mvp/archive/sheets/ref_utm.yaml
        deleted:    dashboard-mvp/archive/sheets/vk_ads.yaml
        deleted:    dashboard-mvp/archive/sheets_init.py
        deleted:    dashboard-mvp/archive/sheets_validate.py
        deleted:    dashboard-mvp/bi/README.md
        deleted:    dashboard-mvp/bi/dashboards/city_performance.md
        deleted:    dashboard-mvp/bi/dashboards/marketing_roi.md
        deleted:    dashboard-mvp/bi/dashboards/ops_data_quality.md
        deleted:    dashboard-mvp/bi/dashboards/sales_overview.md
        deleted:    dashboard-mvp/bi/datasets/ds_ops_freshness.yaml
        deleted:    dashboard-mvp/bi/datasets/ds_roi_daily.yaml
        deleted:    dashboard-mvp/bi/datasets/ds_sales_daily.yaml
        deleted:    dashboard-mvp/bi/datasets/ds_vk_ads_daily.yaml
        deleted:    dashboard-mvp/bi/exports/README.md
        deleted:    dashboard-mvp/ch-python/README.md
        deleted:    dashboard-mvp/ch-python/cli.py
        deleted:    dashboard-mvp/ch-python/loader/__init__.py
        deleted:    dashboard-mvp/ch-python/loader/build_dm_sales.py
        deleted:    dashboard-mvp/ch-python/loader/build_dm_sales_incr.py
        deleted:    dashboard-mvp/ch-python/loader/build_dm_vk_ads.py
        deleted:    dashboard-mvp/ch-python/loader/build_dm_vk_incr.py
        deleted:    dashboard-mvp/ch-python/loader/qtickets_cdc.py
        deleted:    dashboard-mvp/ch-python/loader/vk_ads_cdc.py
        deleted:    dashboard-mvp/ch-python/requirements.txt
        deleted:    dashboard-mvp/configs/.env.alerts.sample
        deleted:    dashboard-mvp/configs/.env.ch.sample
        deleted:    dashboard-mvp/configs/.env.direct.sample
        deleted:    dashboard-mvp/configs/.env.gmail.sample
        deleted:    dashboard-mvp/configs/.env.qtickets.sample
        deleted:    dashboard-mvp/configs/.env.vk.sample
        deleted:    dashboard-mvp/deploy_mail_dashboard.sh
        deleted:    dashboard-mvp/docs/ACCESS_HANDBOOK.md
        deleted:    dashboard-mvp/docs/ARCHITECTURE.md
        deleted:    dashboard-mvp/docs/COMMUNICATION_PLAN.md
        deleted:    dashboard-mvp/docs/CURRENT_STATUS_AND_DEPLOYMENT.md
        deleted:    dashboard-mvp/docs/CUSTOMER_GUIDE.md
        deleted:    dashboard-mvp/docs/DATALENS_CONNECTION_PLAN.md
        deleted:    dashboard-mvp/docs/DATALENS_IMPLEMENTATION_SUMMARY.md
        deleted:    dashboard-mvp/docs/DATALENS_MAIL_SETUP.md
        deleted:    dashboard-mvp/docs/DATALENS_TECHNICAL_SPEC.md
        deleted:    dashboard-mvp/docs/DECOMMISSION_SHEETS.md
        deleted:    dashboard-mvp/docs/DELIVERY_REPORT.md
        deleted:    dashboard-mvp/docs/DEMO_AND_HANDOVER_GUIDE.md
        deleted:    dashboard-mvp/docs/DISASTER_RUNBOOK.md
        deleted:    dashboard-mvp/docs/DOD_CHECKLIST_A0.md
        deleted:    dashboard-mvp/docs/DOR_CHECKLIST_A0.md
        deleted:    dashboard-mvp/docs/E2E_TESTING_RESULTS_REPORT.md
        deleted:    dashboard-mvp/docs/E2E_TESTING_SCRIPT.md
        deleted:    dashboard-mvp/docs/FINAL_INTEGRATIONS_AND_DATALENS_READINESS_REPORT.md
        deleted:    dashboard-mvp/docs/FINAL_REAL_DATA_READINESS_REPORT.md
        deleted:    dashboard-mvp/docs/FINAL_STATUS_REPORT.md
        deleted:    dashboard-mvp/docs/GOOGLE_SHEETS_SETUP_GUIDE.md
        deleted:    dashboard-mvp/docs/INFRASTRUCTURE_DEPLOYMENT_REPORT.md
        deleted:    dashboard-mvp/docs/INTEGRATIONS_STATUS_AND_GUIDE.md
        deleted:    dashboard-mvp/docs/PROJECT_DETAILED_OVERVIEW.md
        deleted:    dashboard-mvp/docs/PROJECT_OVERVIEW.md
        deleted:    dashboard-mvp/docs/REAL_DATA_E2E_TEST_PLAN.md
        deleted:    dashboard-mvp/docs/REAL_DATA_SETUP_GUIDE.md
        deleted:    dashboard-mvp/docs/REAL_DATA_TESTING_INSTRUCTIONS.md
        deleted:    dashboard-mvp/docs/REAL_DATA_TESTING_RESULTS_REPORT.md
        deleted:    dashboard-mvp/docs/RISK_LOG.md
        deleted:    dashboard-mvp/docs/RUNBOOK_BACKUP_RESTORE.md
        deleted:    dashboard-mvp/docs/RUNBOOK_CDC_NRT.md
        deleted:    dashboard-mvp/docs/RUNBOOK_DATALENS.md
        deleted:    dashboard-mvp/docs/RUNBOOK_ETL.md
        deleted:    dashboard-mvp/docs/RUNBOOK_HARDENING.md
        deleted:    dashboard-mvp/docs/RUNBOOK_INTEGRATIONS.md
        deleted:    dashboard-mvp/docs/SCOPE_AND_CONTRACT.md
        deleted:    dashboard-mvp/docs/TEMPLATES/ISSUE_TEMPLATE.md
        deleted:    dashboard-mvp/docs/TEMPLATES/MEETING_NOTES_TEMPLATE.md
        deleted:    dashboard-mvp/docs/TEMPLATES/postmortem.md
        deleted:    dashboard-mvp/docs/TIMEZONE_AND_NAMING.md
        deleted:    dashboard-mvp/docs/WORKFLOW_ANALYSIS_REPORT.md
        deleted:    dashboard-mvp/docs/adr/ADR-0001-clickhouse-base.md
        deleted:    dashboard-mvp/docs/adr/ADR-0002-datalens-connection.md
        deleted:    dashboard-mvp/e2e_test_real_data.sh
        deleted:    dashboard-mvp/e2e_test_simple.sh
        modified:   dashboard-mvp/infra/clickhouse/Caddyfile
        modified:   dashboard-mvp/infra/clickhouse/README.md
        modified:   dashboard-mvp/infra/clickhouse/config.d/20-security.xml
        deleted:    dashboard-mvp/infra/clickhouse/datalens_checks.sql
        modified:   dashboard-mvp/infra/clickhouse/docker-compose.yml
        deleted:    dashboard-mvp/infra/clickhouse/init.sql
        deleted:    dashboard-mvp/infra/clickhouse/init_integrations.sql
        deleted:    dashboard-mvp/infra/clickhouse/init_mail.sql
        deleted:    dashboard-mvp/infra/clickhouse/init_qtickets_sheets.sql
        deleted:    dashboard-mvp/infra/clickhouse/smoke_checks.sql
        deleted:    dashboard-mvp/infra/clickhouse/smoke_checks_integrations.sql
        deleted:    dashboard-mvp/infra/clickhouse/smoke_checks_qtickets_sheets.sql
        modified:   dashboard-mvp/infra/clickhouse/users.d/10-users.xml
        deleted:    dashboard-mvp/infra/systemd/backup@.service
        deleted:    dashboard-mvp/infra/systemd/backup@full.timer
        deleted:    dashboard-mvp/infra/systemd/backup@incr.timer
        deleted:    dashboard-mvp/infra/systemd/backup@prune.service
        deleted:    dashboard-mvp/infra/systemd/backup@prune.timer
        deleted:    dashboard-mvp/infra/systemd/etl@.service
        deleted:    dashboard-mvp/infra/systemd/etl@.timer
        deleted:    dashboard-mvp/infra/systemd/etl@build_dm_sales_incr.service
        deleted:    dashboard-mvp/infra/systemd/etl@build_dm_sales_incr.timer
        deleted:    dashboard-mvp/infra/systemd/etl@build_dm_vk_incr.service
        deleted:    dashboard-mvp/infra/systemd/etl@build_dm_vk_incr.timer
        deleted:    dashboard-mvp/infra/systemd/etl@cdc_qtickets.service
        deleted:    dashboard-mvp/infra/systemd/etl@cdc_qtickets.timer
        deleted:    dashboard-mvp/infra/systemd/etl@cdc_vk.service
        deleted:    dashboard-mvp/infra/systemd/etl@cdc_vk.timer
        deleted:    dashboard-mvp/infra/systemd/gmail-ingest.service
        deleted:    dashboard-mvp/infra/systemd/gmail-ingest.timer
        deleted:    dashboard-mvp/integrations/README.md
        deleted:    dashboard-mvp/integrations/__init__.py
        modified:   dashboard-mvp/integrations/common/__init__.py
        modified:   dashboard-mvp/integrations/common/ch.py
        modified:   dashboard-mvp/integrations/common/logging.py
        modified:   dashboard-mvp/integrations/common/time.py
        deleted:    dashboard-mvp/integrations/common/utm.py
        deleted:    dashboard-mvp/integrations/direct/README.md
        deleted:    dashboard-mvp/integrations/direct/__init__.py
        deleted:    dashboard-mvp/integrations/direct/loader.py
        deleted:    dashboard-mvp/integrations/gmail/README.md
        deleted:    dashboard-mvp/integrations/gmail/__init__.py
        deleted:    dashboard-mvp/integrations/gmail/loader.py
        deleted:    dashboard-mvp/integrations/qtickets/README.md
        deleted:    dashboard-mvp/integrations/qtickets/__init__.py
        deleted:    dashboard-mvp/integrations/qtickets/loader.py
        deleted:    dashboard-mvp/integrations/qtickets_sheets/README.md
        deleted:    dashboard-mvp/integrations/qtickets_sheets/__init__.py
        deleted:    dashboard-mvp/integrations/qtickets_sheets/gsheets_client.py
        deleted:    dashboard-mvp/integrations/qtickets_sheets/loader.py
        deleted:    dashboard-mvp/integrations/qtickets_sheets/transform.py
        deleted:    dashboard-mvp/integrations/qtickets_sheets/upsert.py
        deleted:    dashboard-mvp/integrations/vk_ads/README.md
        deleted:    dashboard-mvp/integrations/vk_ads/__init__.py
        deleted:    dashboard-mvp/integrations/vk_ads/loader.py
        deleted:    dashboard-mvp/mail-python/.env.sample
        deleted:    dashboard-mvp/mail-python/README.md
        deleted:    dashboard-mvp/mail-python/gmail_ingest.py
        deleted:    dashboard-mvp/mail-python/init_clickhouse.sh
        deleted:    dashboard-mvp/mail-python/requirements.txt
        deleted:    dashboard-mvp/ops/BACKUP_TEST_CHECKLIST.md
        deleted:    dashboard-mvp/ops/CHECKLIST_KICKOFF.md
        deleted:    dashboard-mvp/ops/DATALENS_HANDOVER_CHECKLIST.md
        deleted:    dashboard-mvp/ops/DATALENS_HANDOVER_SCRIPT.md
        deleted:    dashboard-mvp/ops/DATALENS_SETUP.md
        deleted:    dashboard-mvp/ops/EMAIL_TEMPLATES.md
        deleted:    dashboard-mvp/ops/HANDOVER_PACKAGE.md
        deleted:    dashboard-mvp/ops/README_BACKUP.md
        deleted:    dashboard-mvp/ops/SMOKE_TEST.md
        deleted:    dashboard-mvp/ops/TOKEN_GUIDE.md
        deleted:    dashboard-mvp/ops/VPS_DEPLOYMENT_INSTRUCTIONS.md
        deleted:    dashboard-mvp/ops/alert_notify.py
        deleted:    dashboard-mvp/ops/alerts/README.md
        deleted:    dashboard-mvp/ops/alerts/notify.py
        deleted:    dashboard-mvp/ops/backfill.py
        deleted:    dashboard-mvp/ops/backfill_data.sh
        deleted:    dashboard-mvp/ops/backup_full.sh
        deleted:    dashboard-mvp/ops/backup_incr.sh
        deleted:    dashboard-mvp/ops/backup_prune.sh
        deleted:    dashboard-mvp/ops/backup_verify.py
        deleted:    dashboard-mvp/ops/deploy_infrastructure.sh
        deleted:    dashboard-mvp/ops/full_deployment.sh
        deleted:    dashboard-mvp/ops/healthcheck.py
        deleted:    dashboard-mvp/ops/healthcheck_integrations.py
        deleted:    dashboard-mvp/ops/init_clickhouse_for_datalens.sh
        deleted:    dashboard-mvp/ops/quality_sli.py
        deleted:    dashboard-mvp/ops/quick_setup_datalens.sh
        deleted:    dashboard-mvp/ops/restore_test.sh
        deleted:    dashboard-mvp/ops/run_job.sh
        deleted:    dashboard-mvp/ops/run_smoke_test.sh
        deleted:    dashboard-mvp/ops/setup_timers.sh
        deleted:    dashboard-mvp/ops/simple_connectivity_test.sh
        deleted:    dashboard-mvp/ops/slo_guard.py
        deleted:    dashboard-mvp/ops/smoke_test_integrations.py
        deleted:    dashboard-mvp/ops/system_check.sh
        deleted:    dashboard-mvp/ops/systemd/README.md
        deleted:    dashboard-mvp/ops/systemd/alerts.service
        deleted:    dashboard-mvp/ops/systemd/alerts.timer
        deleted:    dashboard-mvp/ops/systemd/direct.service
        deleted:    dashboard-mvp/ops/systemd/direct.timer
        deleted:    dashboard-mvp/ops/systemd/gmail_ingest.service
        deleted:    dashboard-mvp/ops/systemd/gmail_ingest.timer
        deleted:    dashboard-mvp/ops/systemd/healthcheck.service
        deleted:    dashboard-mvp/ops/systemd/manage_timers.sh
        deleted:    dashboard-mvp/ops/systemd/qtickets.service
        deleted:    dashboard-mvp/ops/systemd/qtickets.timer
        deleted:    dashboard-mvp/ops/systemd/qtickets_sheets.service
        deleted:    dashboard-mvp/ops/systemd/qtickets_sheets.timer
        deleted:    dashboard-mvp/ops/systemd/smoke_test_integrations.service
        deleted:    dashboard-mvp/ops/systemd/vk_ads.service
        deleted:    dashboard-mvp/ops/systemd/vk_ads.timer
        deleted:    dashboard-mvp/ops/test_current_state.py
        deleted:    dashboard-mvp/ops/update_tokens.sh
        deleted:    dashboard-mvp/test_clickhouse_setup.py
        deleted:    dashboard-mvp/test_google_sheets.py
        deleted:    dashboard-mvp/test_qtickets_sheets.py
        deleted:    dashboard-mvp/test_system.sh
        deleted:    dashboard-mvp/tools/init.sh
        deleted:    dashboard-mvp/tools/new_project.py
        deleted:    dashboard-mvp/vk-python/.env.sample
        deleted:    dashboard-mvp/vk-python/README.md
        deleted:    dashboard-mvp/vk-python/pyproject.toml
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline.egg-info/PKG-INFO
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline.egg-info/SOURCES.txt
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline.egg-info/dependency_links.txt
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline.egg-info/requires.txt
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline.egg-info/top_level.txt
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline/__init__.py
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline/client.py
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline/config.py
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline/main.py
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline/pipeline.py
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline/sink/__init__.py
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline/sink/clickhouse_sink.py
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline/transform/__init__.py
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline/transform/normalize.py
        deleted:    dashboard-mvp/vk-python/src/vk_ads_pipeline/transforms.py
        deleted:    dashboard-mvp/vk-python/tests/test_config.py
        deleted:    dashboard-mvp/vk-python/tests/test_transforms.py

Untracked files:
  (use "git add <file>..." to include in what will be committed)
        Zakaz_Dashboard/
        dashboard-mvp.bak.202510271525/
        dashboard-mvp/README_DEPLOY_QTICKETS_API.md
        dashboard-mvp/configs/.env.qtickets_api.sample
        dashboard-mvp/infra/clickhouse/.env.example
        dashboard-mvp/infra/clickhouse/bootstrap_all.sql
        dashboard-mvp/infra/clickhouse/migrations/
        dashboard-mvp/integrations/qtickets_api/
        dashboard-mvp/manual_qtickets_smoke.py
        dashboard-mvp/qtickets_debug/
        dashboard-mvp/test_env/
        secrets/

no changes added to commit (use "git add" and/or "git commit -a")
etl@museshow:/opt/zakaz_dashboard$ git fetch --all
remote: Enumerating objects: 822, done.
remote: Counting objects: 100% (822/822), done.
remote: Compressing objects: 100% (454/454), done.
remote: Total 772 (delta 415), reused 655 (delta 298), pack-reused 0 (from 0)
Receiving objects: 100% (772/772), 524.12 KiB | 2.69 MiB/s, done.
Resolving deltas: 100% (415/415), completed with 39 local objects.
From https://github.com/tanislara292-ux/Zakaz_Dashboard
   51d1e12..094b3dc  main                                     -> origin/main
 * [new branch]      feature/task-006-full-schema-lockdown    -> origin/feature/task-006-full-schema-lockdown
 * [new branch]      feature/task-007-schema-canonicalization -> origin/feature/task-007-schema-canonicalization
etl@museshow:/opt/zakaz_dashboard$ git checkout main
M       .env
D       dashboard-mvp/.editorconfig
M       dashboard-mvp/.env.sample
D       dashboard-mvp/.github/workflows/etl_dispatch.yml
M       dashboard-mvp/.gitignore
D       dashboard-mvp/.pre-commit-config.yaml
D       dashboard-mvp/CHANGELOG.md
D       dashboard-mvp/CHANGELOG_QTICKETS_SHEETS.md
D       dashboard-mvp/CHECKLIST_MAIL_DASHBOARD.md
D       dashboard-mvp/EPIC-CH-01-REPORT.md
D       dashboard-mvp/EPIC-CH-02-REPORT.md
D       dashboard-mvp/EPIC-CH-03-REPORT.md
D       dashboard-mvp/EPIC-CH-04-REPORT.md
D       dashboard-mvp/EPIC-CH-05-REPORT.md
D       dashboard-mvp/LICENSE
D       dashboard-mvp/PROTOCOL.md
D       dashboard-mvp/README.md
D       dashboard-mvp/README_MAIL_DASHBOARD.md
D       dashboard-mvp/TASK-DELIVERY-01-REPORT.md
D       dashboard-mvp/TASK-QT-SHEETS-ONLY-REPORT.md
D       dashboard-mvp/archive/README.md
D       dashboard-mvp/archive/appscript/README.md
D       dashboard-mvp/archive/appscript/qtickets_api_ingest.gs
D       dashboard-mvp/archive/sheets/logs.yaml
D       dashboard-mvp/archive/sheets/plans.yaml
D       dashboard-mvp/archive/sheets/qtickets.yaml
D       dashboard-mvp/archive/sheets/ref_utm.yaml
D       dashboard-mvp/archive/sheets/vk_ads.yaml
D       dashboard-mvp/archive/sheets_init.py
D       dashboard-mvp/archive/sheets_validate.py
D       dashboard-mvp/bi/README.md
D       dashboard-mvp/bi/dashboards/city_performance.md
D       dashboard-mvp/bi/dashboards/marketing_roi.md
D       dashboard-mvp/bi/dashboards/ops_data_quality.md
D       dashboard-mvp/bi/dashboards/sales_overview.md
D       dashboard-mvp/bi/datasets/ds_ops_freshness.yaml
D       dashboard-mvp/bi/datasets/ds_roi_daily.yaml
D       dashboard-mvp/bi/datasets/ds_sales_daily.yaml
D       dashboard-mvp/bi/datasets/ds_vk_ads_daily.yaml
D       dashboard-mvp/bi/exports/README.md
D       dashboard-mvp/ch-python/README.md
D       dashboard-mvp/ch-python/cli.py
D       dashboard-mvp/ch-python/loader/__init__.py
D       dashboard-mvp/ch-python/loader/build_dm_sales.py
D       dashboard-mvp/ch-python/loader/build_dm_sales_incr.py
D       dashboard-mvp/ch-python/loader/build_dm_vk_ads.py
D       dashboard-mvp/ch-python/loader/build_dm_vk_incr.py
D       dashboard-mvp/ch-python/loader/qtickets_cdc.py
D       dashboard-mvp/ch-python/loader/vk_ads_cdc.py
D       dashboard-mvp/ch-python/requirements.txt
D       dashboard-mvp/configs/.env.alerts.sample
D       dashboard-mvp/configs/.env.ch.sample
D       dashboard-mvp/configs/.env.direct.sample
D       dashboard-mvp/configs/.env.gmail.sample
D       dashboard-mvp/configs/.env.qtickets.sample
D       dashboard-mvp/configs/.env.vk.sample
D       dashboard-mvp/deploy_mail_dashboard.sh
D       dashboard-mvp/docs/ACCESS_HANDBOOK.md
D       dashboard-mvp/docs/ARCHITECTURE.md
D       dashboard-mvp/docs/COMMUNICATION_PLAN.md
D       dashboard-mvp/docs/CURRENT_STATUS_AND_DEPLOYMENT.md
D       dashboard-mvp/docs/CUSTOMER_GUIDE.md
D       dashboard-mvp/docs/DATALENS_CONNECTION_PLAN.md
D       dashboard-mvp/docs/DATALENS_IMPLEMENTATION_SUMMARY.md
D       dashboard-mvp/docs/DATALENS_MAIL_SETUP.md
D       dashboard-mvp/docs/DATALENS_TECHNICAL_SPEC.md
D       dashboard-mvp/docs/DECOMMISSION_SHEETS.md
D       dashboard-mvp/docs/DELIVERY_REPORT.md
D       dashboard-mvp/docs/DEMO_AND_HANDOVER_GUIDE.md
D       dashboard-mvp/docs/DISASTER_RUNBOOK.md
D       dashboard-mvp/docs/DOD_CHECKLIST_A0.md
D       dashboard-mvp/docs/DOR_CHECKLIST_A0.md
D       dashboard-mvp/docs/E2E_TESTING_RESULTS_REPORT.md
D       dashboard-mvp/docs/E2E_TESTING_SCRIPT.md
D       dashboard-mvp/docs/FINAL_INTEGRATIONS_AND_DATALENS_READINESS_REPORT.md
D       dashboard-mvp/docs/FINAL_REAL_DATA_READINESS_REPORT.md
D       dashboard-mvp/docs/FINAL_STATUS_REPORT.md
D       dashboard-mvp/docs/GOOGLE_SHEETS_SETUP_GUIDE.md
D       dashboard-mvp/docs/INFRASTRUCTURE_DEPLOYMENT_REPORT.md
D       dashboard-mvp/docs/INTEGRATIONS_STATUS_AND_GUIDE.md
D       dashboard-mvp/docs/PROJECT_DETAILED_OVERVIEW.md
D       dashboard-mvp/docs/PROJECT_OVERVIEW.md
D       dashboard-mvp/docs/REAL_DATA_E2E_TEST_PLAN.md
D       dashboard-mvp/docs/REAL_DATA_SETUP_GUIDE.md
D       dashboard-mvp/docs/REAL_DATA_TESTING_INSTRUCTIONS.md
D       dashboard-mvp/docs/REAL_DATA_TESTING_RESULTS_REPORT.md
D       dashboard-mvp/docs/RISK_LOG.md
D       dashboard-mvp/docs/RUNBOOK_BACKUP_RESTORE.md
D       dashboard-mvp/docs/RUNBOOK_CDC_NRT.md
D       dashboard-mvp/docs/RUNBOOK_DATALENS.md
D       dashboard-mvp/docs/RUNBOOK_ETL.md
D       dashboard-mvp/docs/RUNBOOK_HARDENING.md
D       dashboard-mvp/docs/RUNBOOK_INTEGRATIONS.md
D       dashboard-mvp/docs/SCOPE_AND_CONTRACT.md
D       dashboard-mvp/docs/TEMPLATES/ISSUE_TEMPLATE.md
D       dashboard-mvp/docs/TEMPLATES/MEETING_NOTES_TEMPLATE.md
D       dashboard-mvp/docs/TEMPLATES/postmortem.md
D       dashboard-mvp/docs/TIMEZONE_AND_NAMING.md
D       dashboard-mvp/docs/WORKFLOW_ANALYSIS_REPORT.md
D       dashboard-mvp/docs/adr/ADR-0001-clickhouse-base.md
D       dashboard-mvp/docs/adr/ADR-0002-datalens-connection.md
D       dashboard-mvp/e2e_test_real_data.sh
D       dashboard-mvp/e2e_test_simple.sh
M       dashboard-mvp/infra/clickhouse/Caddyfile
M       dashboard-mvp/infra/clickhouse/README.md
M       dashboard-mvp/infra/clickhouse/config.d/20-security.xml
D       dashboard-mvp/infra/clickhouse/datalens_checks.sql
M       dashboard-mvp/infra/clickhouse/docker-compose.yml
D       dashboard-mvp/infra/clickhouse/init.sql
D       dashboard-mvp/infra/clickhouse/init_integrations.sql
D       dashboard-mvp/infra/clickhouse/init_mail.sql
D       dashboard-mvp/infra/clickhouse/init_qtickets_sheets.sql
D       dashboard-mvp/infra/clickhouse/smoke_checks.sql
D       dashboard-mvp/infra/clickhouse/smoke_checks_integrations.sql
D       dashboard-mvp/infra/clickhouse/smoke_checks_qtickets_sheets.sql
M       dashboard-mvp/infra/clickhouse/users.d/10-users.xml
D       dashboard-mvp/infra/systemd/backup@.service
D       dashboard-mvp/infra/systemd/backup@full.timer
D       dashboard-mvp/infra/systemd/backup@incr.timer
D       dashboard-mvp/infra/systemd/backup@prune.service
D       dashboard-mvp/infra/systemd/backup@prune.timer
D       dashboard-mvp/infra/systemd/etl@.service
D       dashboard-mvp/infra/systemd/etl@.timer
D       dashboard-mvp/infra/systemd/etl@build_dm_sales_incr.service
D       dashboard-mvp/infra/systemd/etl@build_dm_sales_incr.timer
D       dashboard-mvp/infra/systemd/etl@build_dm_vk_incr.service
D       dashboard-mvp/infra/systemd/etl@build_dm_vk_incr.timer
D       dashboard-mvp/infra/systemd/etl@cdc_qtickets.service
D       dashboard-mvp/infra/systemd/etl@cdc_qtickets.timer
D       dashboard-mvp/infra/systemd/etl@cdc_vk.service
D       dashboard-mvp/infra/systemd/etl@cdc_vk.timer
D       dashboard-mvp/infra/systemd/gmail-ingest.service
D       dashboard-mvp/infra/systemd/gmail-ingest.timer
D       dashboard-mvp/integrations/README.md
D       dashboard-mvp/integrations/__init__.py
M       dashboard-mvp/integrations/common/__init__.py
M       dashboard-mvp/integrations/common/ch.py
M       dashboard-mvp/integrations/common/logging.py
M       dashboard-mvp/integrations/common/time.py
D       dashboard-mvp/integrations/common/utm.py
D       dashboard-mvp/integrations/direct/README.md
D       dashboard-mvp/integrations/direct/__init__.py
D       dashboard-mvp/integrations/direct/loader.py
D       dashboard-mvp/integrations/gmail/README.md
D       dashboard-mvp/integrations/gmail/__init__.py
D       dashboard-mvp/integrations/gmail/loader.py
D       dashboard-mvp/integrations/qtickets/README.md
D       dashboard-mvp/integrations/qtickets/__init__.py
D       dashboard-mvp/integrations/qtickets/loader.py
D       dashboard-mvp/integrations/qtickets_sheets/README.md
D       dashboard-mvp/integrations/qtickets_sheets/__init__.py
D       dashboard-mvp/integrations/qtickets_sheets/gsheets_client.py
D       dashboard-mvp/integrations/qtickets_sheets/loader.py
D       dashboard-mvp/integrations/qtickets_sheets/transform.py
D       dashboard-mvp/integrations/qtickets_sheets/upsert.py
D       dashboard-mvp/integrations/vk_ads/README.md
D       dashboard-mvp/integrations/vk_ads/__init__.py
D       dashboard-mvp/integrations/vk_ads/loader.py
D       dashboard-mvp/mail-python/.env.sample
D       dashboard-mvp/mail-python/README.md
D       dashboard-mvp/mail-python/gmail_ingest.py
D       dashboard-mvp/mail-python/init_clickhouse.sh
D       dashboard-mvp/mail-python/requirements.txt
D       dashboard-mvp/ops/BACKUP_TEST_CHECKLIST.md
D       dashboard-mvp/ops/CHECKLIST_KICKOFF.md
D       dashboard-mvp/ops/DATALENS_HANDOVER_CHECKLIST.md
D       dashboard-mvp/ops/DATALENS_HANDOVER_SCRIPT.md
D       dashboard-mvp/ops/DATALENS_SETUP.md
D       dashboard-mvp/ops/EMAIL_TEMPLATES.md
D       dashboard-mvp/ops/HANDOVER_PACKAGE.md
D       dashboard-mvp/ops/README_BACKUP.md
D       dashboard-mvp/ops/SMOKE_TEST.md
D       dashboard-mvp/ops/TOKEN_GUIDE.md
D       dashboard-mvp/ops/VPS_DEPLOYMENT_INSTRUCTIONS.md
D       dashboard-mvp/ops/alert_notify.py
D       dashboard-mvp/ops/alerts/README.md
D       dashboard-mvp/ops/alerts/notify.py
D       dashboard-mvp/ops/backfill.py
D       dashboard-mvp/ops/backfill_data.sh
D       dashboard-mvp/ops/backup_full.sh
D       dashboard-mvp/ops/backup_incr.sh
D       dashboard-mvp/ops/backup_prune.sh
D       dashboard-mvp/ops/backup_verify.py
D       dashboard-mvp/ops/deploy_infrastructure.sh
D       dashboard-mvp/ops/full_deployment.sh
D       dashboard-mvp/ops/healthcheck.py
D       dashboard-mvp/ops/healthcheck_integrations.py
D       dashboard-mvp/ops/init_clickhouse_for_datalens.sh
D       dashboard-mvp/ops/quality_sli.py
D       dashboard-mvp/ops/quick_setup_datalens.sh
D       dashboard-mvp/ops/restore_test.sh
D       dashboard-mvp/ops/run_job.sh
D       dashboard-mvp/ops/run_smoke_test.sh
D       dashboard-mvp/ops/setup_timers.sh
D       dashboard-mvp/ops/simple_connectivity_test.sh
D       dashboard-mvp/ops/slo_guard.py
D       dashboard-mvp/ops/smoke_test_integrations.py
D       dashboard-mvp/ops/system_check.sh
D       dashboard-mvp/ops/systemd/README.md
D       dashboard-mvp/ops/systemd/alerts.service
D       dashboard-mvp/ops/systemd/alerts.timer
D       dashboard-mvp/ops/systemd/direct.service
D       dashboard-mvp/ops/systemd/direct.timer
D       dashboard-mvp/ops/systemd/gmail_ingest.service
D       dashboard-mvp/ops/systemd/gmail_ingest.timer
D       dashboard-mvp/ops/systemd/healthcheck.service
D       dashboard-mvp/ops/systemd/manage_timers.sh
D       dashboard-mvp/ops/systemd/qtickets.service
D       dashboard-mvp/ops/systemd/qtickets.timer
D       dashboard-mvp/ops/systemd/qtickets_sheets.service
D       dashboard-mvp/ops/systemd/qtickets_sheets.timer
D       dashboard-mvp/ops/systemd/smoke_test_integrations.service
D       dashboard-mvp/ops/systemd/vk_ads.service
D       dashboard-mvp/ops/systemd/vk_ads.timer
D       dashboard-mvp/ops/test_current_state.py
D       dashboard-mvp/ops/update_tokens.sh
D       dashboard-mvp/test_clickhouse_setup.py
D       dashboard-mvp/test_google_sheets.py
D       dashboard-mvp/test_qtickets_sheets.py
D       dashboard-mvp/test_system.sh
D       dashboard-mvp/tools/init.sh
D       dashboard-mvp/tools/new_project.py
D       dashboard-mvp/vk-python/.env.sample
D       dashboard-mvp/vk-python/README.md
D       dashboard-mvp/vk-python/pyproject.toml
D       dashboard-mvp/vk-python/src/vk_ads_pipeline.egg-info/PKG-INFO
D       dashboard-mvp/vk-python/src/vk_ads_pipeline.egg-info/SOURCES.txt
D       dashboard-mvp/vk-python/src/vk_ads_pipeline.egg-info/dependency_links.txt
D       dashboard-mvp/vk-python/src/vk_ads_pipeline.egg-info/requires.txt
D       dashboard-mvp/vk-python/src/vk_ads_pipeline.egg-info/top_level.txt
D       dashboard-mvp/vk-python/src/vk_ads_pipeline/__init__.py
D       dashboard-mvp/vk-python/src/vk_ads_pipeline/client.py
D       dashboard-mvp/vk-python/src/vk_ads_pipeline/config.py
D       dashboard-mvp/vk-python/src/vk_ads_pipeline/main.py
D       dashboard-mvp/vk-python/src/vk_ads_pipeline/pipeline.py
D       dashboard-mvp/vk-python/src/vk_ads_pipeline/sink/__init__.py
D       dashboard-mvp/vk-python/src/vk_ads_pipeline/sink/clickhouse_sink.py
D       dashboard-mvp/vk-python/src/vk_ads_pipeline/transform/__init__.py
D       dashboard-mvp/vk-python/src/vk_ads_pipeline/transform/normalize.py
D       dashboard-mvp/vk-python/src/vk_ads_pipeline/transforms.py
D       dashboard-mvp/vk-python/tests/test_config.py
D       dashboard-mvp/vk-python/tests/test_transforms.py
Already on 'main'
Your branch is behind 'origin/main' by 65 commits, and can be fast-forwarded.
  (use "git pull" to update your local branch)
etl@museshow:/opt/zakaz_dashboard$ git pull --rebase origin main
error: cannot pull with rebase: You have unstaged changes.
error: Please commit or stash them.
etl@museshow:/opt/zakaz_dashboard$ # под etl
 systemctl stop qtickets_api.timer vk_ads.timeetl@museshow:/opt/zakaz_dashboard$ whoami
.timer || true
sudo systemctl stop qtickets_api.service vk_ads.service direct.service || true
etl
etl@museshow:/opt/zakaz_dashboard$ cd /opt/zakaz_dashboard
etl@museshow:/opt/zakaz_dashboard$
etl@museshow:/opt/zakaz_dashboard$ # Остановить таймеры/сервисы (если их нет — не упадёт)
etl@museshow:/opt/zakaz_dashboard$ sudo systemctl stop qtickets_api.timer vk_ads.timer direct.timer || true
[sudo] password for etl:
Sorry, try again.
[sudo] password for etl:




Sorry, try again.
[sudo] password for etl:



sudo: 3 incorrect password attempts
etl@museshow:/opt/zakaz_dashboard$
etl@museshow:/opt/zakaz_dashboard$
etl@museshow:/opt/zakaz_dashboard$
etl@museshow:/opt/zakaz_dashboard$
etl@museshow:/opt/zakaz_dashboard$
etl@museshow:/opt/zakaz_dashboard$ # ты сейчас под etl
etl@museshow:/opt/zakaz_dashboard$ exit                                 # вернёт в root (root@museshow#)
logout
op qtickets_api.timer vk_ads.timer direct.timer || true
systemctl stop qtickets_api.service vk_ads.service direct.service || true
systemctl list-timers | grep -E 'qtickets|vk_ads|direct' || true
root@museshow:/opt/zakaz_dashboard# systemctl stop qtickets_api.timer vk_ads.timer direct.timer || true
Failed to stop qtickets_api.timer: Unit qtickets_api.timer not loaded.
Failed to stop vk_ads.timer: Unit vk_ads.timer not loaded.
Failed to stop direct.timer: Unit direct.timer not loaded.
root@museshow:/opt/zakaz_dashboard# systemctl stop qtickets_api.service vk_ads.service direct.service || true
Failed to stop qtickets_api.service: Unit qtickets_api.service not loaded.
Failed to stop vk_ads.service: Unit vk_ads.service not loaded.
Failed to stop direct.service: Unit direct.service not loaded.
root@museshow:/opt/zakaz_dashboard# systemctl list-timers | grep -E 'qtickets|vk_ads|direct' || true
root@museshow:/opt/zakaz_dashboard# usermod -aG sudo etl
ALL) NOPASSWD:ALL\n' > /etc/sudoers.d/90-etl-nopasswd
chmod 440 /etc/sudoers.d/90-etl-nopasswd
root@museshow:/opt/zakaz_dashboard# usermod -aG docker etl
root@museshow:/opt/zakaz_dashboard# printf 'etl ALL=(ALL) NOPASSWD:ALL\n' > /etc/sudoers.d/90-etl-nopasswd
root@museshow:/opt/zakaz_dashboard# chmod 440 /etc/sudoers.d/90-etl-nopasswd
root@museshow:/opt/zakaz_dashboard# su - etl
To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.

etl@museshow:~$ cd /opt/zakaz_dashboard
etl@museshow:/opt/zakaz_dashboard$ whoami && pwd
etl
/opt/zakaz_dashboard
etl@museshow:/opt/zakaz_dashboard$ # Сохранить ВСЁ (включая untracked) в stash
etl@museshow:/opt/zakaz_dashboard$ git stash push -u -m "server-local before update $(date +'%F %T')"
конфликте — жёсткий ресет на origin/main
git pull --rebase origin main || { git rebase --abort || true; git reset --hard origin/main; }
# Удалим мусор, но оставим secrets/ и бэкапы
git clean -fd -e secrets -e 'dashboard-mvp.bak.*' -e backups -e logIgnoring path Zakaz_Dashboard/
s
git status
Saved working directory and index state On main: server-local before update 2025-10-30 18:40:22
etl@museshow:/opt/zakaz_dashboard$
etl@museshow:/opt/zakaz_dashboard$ git fetch --all
etl@museshow:/opt/zakaz_dashboard$ # Пытаемся rebase, при конфликте — жёсткий ресет на origin/main
etl@museshow:/opt/zakaz_dashboard$ git pull --rebase origin main || { git rebase --abort || true; git reset --hard origin/main; }
From https://github.com/tanislara292-ux/Zakaz_Dashboard
 * branch            main       -> FETCH_HEAD
Updating 51d1e12..094b3dc
Fast-forward
 .claude/claude_code_zai_env.sh                                             |  205 +++
 .claude/settings.json                                                      |    7 +
 .github/workflows/ci.yml                                                   |   39 +
 001.md                                                                     |  202 +++
 002.md                                                                     |   81 +
 003.md                                                                     |   48 +
 004.md                                                                     |   77 +
 005.md                                                                     |   66 +
 006.md                                                                     |   93 +
 007.md                                                                     |  155 ++
 008.md                                                                     |  165 ++
 009.md                                                                     |  130 ++
 010.md                                                                     |  124 ++
 011.md                                                                     |  166 ++
 012.md                                                                     |  140 ++
 013.md                                                                     |   95 +
 014.md                                                                     |   69 +
 015.md                                                                     |   66 +
 016.md                                                                     |   96 +
 017.md                                                                     |   99 +
 018.md                                                                     |  118 ++
 018_TEST_REPORT.md                                                         |  197 ++
 019_FINAL_VERIFICATION_REPORT.md                                           |  149 ++
 019_PRODUCTION_TESTING_PLAN.md                                             |  420 +++++
 019_PRODUCTION_TESTING_REPORT.md                                           |  442 +++++
 019_QUICK_TASK.md                                                          |   81 +
 019_VERIFICATION_TASK.md                                                   |  215 +++
 020_QTICKETS_PRODUCTION_TESTING.md                                         |  298 ++++
 021_UBUNTU_DEPLOYMENT_GUIDE.md                                             |  778 ++++++++
 022_MIGRATION_GUIDE.md                                                     |  600 +++++++
 023_DATALENS_SETUP_GUIDE.md                                                |  544 ++++++
 024_COMPREHENSIVE_TROUBLESHOOTING_GUIDE.md                                 |  922 ++++++++++
 025_COMPLETE_DEPLOYMENT_PACKAGE.md                                         |  440 +++++
 CI_RECOMMENDATIONS.md                                                      |  138 ++
 ZAKAZ_DASHBOARD_AUDIT_REPORT.md                                            |  748 ++++++++
 dashboard-mvp/.env.sample                                                  |   26 +-
 dashboard-mvp/.gitignore                                                   |   19 +-
 dashboard-mvp/CHANGELOG.md                                                 |    2 +-
 dashboard-mvp/CONTRIBUTING.md                                              |  107 ++
 dashboard-mvp/PROD_DEPLOY_CHECKLIST_QTICKETS_API.md                        |  439 +++++
 dashboard-mvp/README.md                                                    |  142 +-
 dashboard-mvp/README_E2E_QTICKETS_API.md                                   |  148 ++
 dashboard-mvp/TASK-DELIVERY-01-REPORT.md                                   |    4 +-
 dashboard-mvp/TASK-QT-API-E2E-LOCAL-REPORT.md                              |  223 +++
 dashboard-mvp/TASK-QT-API-E2E-REPORT.md                                    |   81 +
 dashboard-mvp/TASK-QT-API-LIVE-SMOKE-REPORT.md                             |  176 ++
 dashboard-mvp/TASK-QT-API-PRIMARY-REPORT.md                                |   44 +
 dashboard-mvp/TASK-QT-API-PROD-READY-REPORT.md                             |  256 +++
 dashboard-mvp/ZAKAZ_DASHBOARD_AUDIT_REPORT.md                              |   83 +
 dashboard-mvp/archive/outdated/DEPLOYMENT_INSTRUCTIONS.md                  |  118 ++
 dashboard-mvp/archive/outdated/E2E_QTICKETS_API_INSTRUCTIONS.md            |  282 +++
 dashboard-mvp/{ => archive/outdated}/test_clickhouse_setup.py              |    0
 dashboard-mvp/{ => archive/outdated}/test_system.sh                        |    0
 dashboard-mvp/ch-python/loader/build_dm_sales_incr.py                      |    2 +-
 dashboard-mvp/configs/.env.qtickets_api.sample                             |   28 +
 dashboard-mvp/docs/ARCHITECTURE.md                                         |   23 +-
 dashboard-mvp/docs/DATALENS_CONNECTION_PLAN.md                             |    2 +
 dashboard-mvp/docs/DATALENS_IMPLEMENTATION_SUMMARY.md                      |    1 +
 dashboard-mvp/docs/DEPLOYMENT.md                                           |  149 ++
 dashboard-mvp/docs/RUNBOOK_HARDENING.md                                    |   20 +-
 dashboard-mvp/docs/RUNBOOK_INTEGRATIONS.md                                 |   13 +
 dashboard-mvp/e2e_qtickets_api_test.sh                                     |  482 +++++
 dashboard-mvp/infra/clickhouse/.env.example                                |    6 +
 dashboard-mvp/infra/clickhouse/Caddyfile                                   |   23 +-
 dashboard-mvp/infra/clickhouse/README.md                                   |  210 ++-
 dashboard-mvp/infra/clickhouse/bootstrap_all.sql                           |   11 +
 dashboard-mvp/infra/clickhouse/bootstrap_roles_grants.sql                  |   46 +
 dashboard-mvp/infra/clickhouse/bootstrap_schema.sql                        | 1168 ++++++++++++
 dashboard-mvp/infra/clickhouse/caddy_data/.gitignore                       |    3 +
 dashboard-mvp/infra/clickhouse/caddy_data/.gitkeep                         |    1 +
 dashboard-mvp/infra/clickhouse/config.d/20-security.xml                    |   32 +-
 dashboard-mvp/infra/clickhouse/config.d/20-security.xml.bak.20251029115029 |   66 +
 dashboard-mvp/infra/clickhouse/config.d/config.d.backup/20-security.xml    |   66 +
 dashboard-mvp/infra/clickhouse/docker-compose.yml                          |   50 +-
 dashboard-mvp/infra/clickhouse/init.sql                                    |  227 +--
 dashboard-mvp/infra/clickhouse/init_integrations.sql                       |   40 +-
 dashboard-mvp/infra/clickhouse/init_qtickets_sheets.sql                    |   62 +-
 dashboard-mvp/infra/clickhouse/migrations/2025-qtickets-api-final.sql      |  191 ++
 dashboard-mvp/infra/clickhouse/migrations/2025-qtickets-api-grants.sql     |   16 +
 dashboard-mvp/infra/clickhouse/migrations/2025-qtickets-api.LOCAL.sql      |  143 ++
 dashboard-mvp/infra/clickhouse/migrations/2025-qtickets-api.sql            |  169 ++
 dashboard-mvp/infra/clickhouse/smoke_checks_qtickets_api.LOCAL.sql         |   54 +
 dashboard-mvp/infra/clickhouse/smoke_checks_qtickets_api.sql               |  103 ++
 dashboard-mvp/infra/clickhouse/smoke_checks_qtickets_sheets.sql            |    8 +-
 dashboard-mvp/infra/clickhouse/users.d/00-admin.xml                        |  Bin 0 -> 1054 bytes
 dashboard-mvp/infra/clickhouse/users.d/10-service-users.xml                |  100 ++
 dashboard-mvp/infra/clickhouse/users.d/10-users.xml                        |  238 ---
 dashboard-mvp/infra/clickhouse/users.d/default-user.xml.disabled           |   18 +
 dashboard-mvp/infra/systemd/qtickets_api.service                           |   12 +
 dashboard-mvp/infra/systemd/qtickets_api.timer                             |   11 +
 dashboard-mvp/integrations/common/__init__.py                              |   87 +-
 dashboard-mvp/integrations/common/ch.py                                    |  381 ++--
 dashboard-mvp/integrations/common/logging.py                               |  462 ++---
 dashboard-mvp/integrations/common/time.py                                  |  372 ++--
 dashboard-mvp/integrations/common/utm.py                                   |  873 ++++-----
 dashboard-mvp/integrations/qtickets_api/Dockerfile                         |   37 +
 dashboard-mvp/integrations/qtickets_api/README.md                          |  118 ++
 dashboard-mvp/integrations/qtickets_api/__init__.py                        |   14 +
 dashboard-mvp/integrations/qtickets_api/client.py                          |  750 ++++++++
 dashboard-mvp/integrations/qtickets_api/config.py                          |  224 +++
 dashboard-mvp/integrations/qtickets_api/inventory_agg.py                   |  172 ++
 dashboard-mvp/integrations/qtickets_api/loader.py                          |  578 ++++++
 dashboard-mvp/integrations/qtickets_api/requirements.txt                   |    9 +
 dashboard-mvp/integrations/qtickets_api/tests/__init__.py                  |    1 +
 dashboard-mvp/integrations/qtickets_api/tests/test_client.py               |   69 +
 dashboard-mvp/integrations/qtickets_api/tests/test_inventory_agg.py        |  185 ++
 dashboard-mvp/integrations/qtickets_api/tests/test_transform.py            |  127 ++
 dashboard-mvp/integrations/qtickets_api/transform.py                       |  299 ++++
 dashboard-mvp/local_test/ch/docker-compose.yml                             |   25 +
 dashboard-mvp/local_test/run_e2e_test.sh                                   |   65 +
 dashboard-mvp/manual_qtickets_smoke.py                                     |  411 +++++
 dashboard-mvp/ops/alerts/notify.py                                         |    4 +-
 dashboard-mvp/ops/healthcheck_integrations.py                              |   88 +-
 dashboard-mvp/ops/systemd/README.md                                        |   52 +-
 dashboard-mvp/ops/systemd/manage_timers.sh                                 |   13 +-
 dashboard-mvp/ops/systemd/qtickets_api.service                             |   33 +
 dashboard-mvp/ops/systemd/qtickets_api.timer                               |   10 +
 dashboard-mvp/qtickets_debug/TASK-QT-API-PROD-FINAL-RUN.log                |   42 +
 dashboard-mvp/qtickets_debug/TASK-QT-API-PROD-HARDEN-LOCAL-RUN.log         |  Bin 0 -> 2666 bytes
 dashboard-mvp/qtickets_debug/orders_only_test.py                           |  171 ++
 dashboard-mvp/qtickets_debug/orders_probe.py                               |  334 ++++
 dashboard-mvp/qtickets_debug/orders_probe_final.py                         |  270 +++
 dashboard-mvp/qtickets_debug/orders_probe_simple.py                        |  121 ++
 dashboard-mvp/scripts/bootstrap_clickhouse.sh                              |  136 ++
 dashboard-mvp/scripts/bootstrap_datalens.sh                                |   86 +
 dashboard-mvp/scripts/smoke_qtickets_dryrun.sh                             |  192 ++
 dashboard-mvp/test_env/.env.qtickets_api                                   |   20 +
 dashboard-mvp/test_env/.env.qtickets_api.bad                               |   20 +
 dashboard-mvp/test_env/.env.template                                       |    9 +
 dashboard-mvp/vk-python/src/vk_ads_pipeline.egg-info/SOURCES.txt           |    5 +-
 docs/adr/ADR-003-clickhouse-schema-fix.md                                  |   38 +
 docs/adr/ADR-004-clickhouse-schema-consistency.md                          |   63 +
 docs/adr/ADR-005-clickhouse-production-hardening.md                        |   83 +
 docs/adr/ADR-006-clickhouse-schema-lockdown.md                             |  156 ++
 docs/adr/ADR-007-clickhouse-schema-canonicalization.md                     |  236 +++
 docs/changelog/CHANGELOG-003.md                                            |  202 +++
 docs/changelog/CHANGELOG-005.md                                            |  138 ++
 docs/changelog/CHANGELOG-006.md                                            |  192 ++
 docs/changelog/CHANGELOG-007.md                                            |  309 ++++
 docs/changelog/CHANGELOG-008.md                                            |  172 ++
 docs/changelog/CHANGELOG-009.md                                            |  215 +++
 docs/changelog/CHANGELOG-010.md                                            |  163 ++
 docs/changelog/CHANGELOG-011.md                                            |  184 ++
 docs/changelog/CHANGELOG-012.md                                            |  206 +++
 docs/changelog/CHANGELOG-013.md                                            |  215 +++
 docs/changelog/CHANGELOG-014.md                                            |  233 +++
 docs/changelog/CHANGELOG-015.md                                            |   41 +
 logs/canonical_schemas.md                                                  |  125 ++
 logs/compileall.log                                                        |  273 +++
 logs/create_table_inventory.log                                            |   80 +
 logs/docker_build.log                                                      |   47 +
 logs/pytest.log                                                            |    2 +
 logs/schema_validation.log                                                 |    1 +
 logs/schema_validation_after_full_fix.log                                  |    1 +
 logs/schema_validation_after_migration_fix.log                             |    8 +
 logs/schema_validation_before.log                                          |    1 +
 logs/schema_validation_failure_test.log                                    |   10 +
 logs/schema_validation_final.log                                           |    1 +
 logs/schema_validation_with_mail.log                                       |    1 +
 logs/smoke_qtickets.log                                                    |   74 +
 logs/task-008/qtickets_api_second_run.log                                  |  111 ++
 logs/task-009/qtickets_api_production.log                                  |   47 +
 logs/task010/clickhouse-server.err.log                                     |  200 +++
 logs/task010/clickhouse-server.log                                         |  500 ++++++
 logs/task010/clickhouse_query_log.txt                                      | 3475 ++++++++++++++++++++++++++++++++++++
 logs/task010/clickhouse_text_log.txt                                       | 1485 +++++++++++++++
 logs/task010/http_check_docker.txt                                         |    1 +
 logs/task010/http_check_host.txt                                           |    1 +
 logs/task010/inventory_check.txt                                           |    1 +
 logs/task010/meta_job_runs.txt                                             |    0
 logs/task010/orders_check.txt                                              |    1 +
 logs/task010/qtickets_run.log                                              |    6 +
 logs/task010_bundle.tgz                                                    |  Bin 0 -> 32544 bytes
 logs/task011/after_clickhouse-server.err.log                               |  100 ++
 logs/task011/after_clickhouse-server.log                                   |  200 +++
 logs/task011/after_query_log.txt                                           |    0
 logs/task011/after_text_log.txt                                            |    0
 logs/task011/before_clickhouse-server.err.log                              |  100 ++
 logs/task011/before_clickhouse-server.log                                  |  200 +++
 logs/task011/before_query_log.txt                                          |  399 +++++
 logs/task011/before_text_log.txt                                           |    0
 logs/task011/inventory_check.txt                                           |    1 +
 logs/task011/manual_insert.log                                             |    0
 logs/task011/meta_job_runs.txt                                             |    0
 logs/task011/orders_check.txt                                              |    1 +
 logs/task011/qtickets_run.log                                              |    6 +
 logs/task011_bundle.tgz                                                    |  Bin 0 -> 6882 bytes
 logs/task012/after_query_log.txt                                           |    0
 logs/task012/after_text_log.txt                                            |    0
 logs/task012/clickhouse-server.err.log                                     |  100 ++
 logs/task012/clickhouse-server.log                                         |  200 +++
 logs/task012/inventory_check.txt                                           |    1 +
 logs/task012/manual_insert.log                                             |    0
 logs/task012/meta_job_runs.txt                                             |    0
 logs/task012/orders_check.txt                                              |    1 +
 logs/task012/qtickets_run.log                                              |   57 +
 logs/task012_bundle.tgz                                                    |  Bin 0 -> 6178 bytes
 logs/task013/inventory_check.txt                                           |    1 +
 logs/task013/meta_job_runs.txt                                             |    1 +
 logs/task013/orders_check.txt                                              |    1 +
 logs/task013/qtickets_run.log                                              |    5 +
 logs/task013_bundle.tgz                                                    |  Bin 0 -> 483 bytes
 python_compile.log                                                         |  225 +++
 python_compile_fixed.log                                                   |  214 +++
 schema_validation.log                                                      |    1 +
 scripts/validate_clickhouse_schema.py                                      |  212 +++
 secrets/.env.qtickets_api                                                  |   25 +
 secrets/.env.qtickets_api.bad                                              |   25 +
 208 files changed, 30592 insertions(+), 1804 deletions(-)
 create mode 100644 .claude/claude_code_zai_env.sh
 create mode 100644 .claude/settings.json
 create mode 100644 .github/workflows/ci.yml
 create mode 100644 001.md
 create mode 100644 002.md
 create mode 100644 003.md
 create mode 100644 004.md
 create mode 100644 005.md
 create mode 100644 006.md
 create mode 100644 007.md
 create mode 100644 008.md
 create mode 100644 009.md
 create mode 100644 010.md
 create mode 100644 011.md
 create mode 100644 012.md
 create mode 100644 013.md
 create mode 100644 014.md
 create mode 100644 015.md
 create mode 100644 016.md
 create mode 100644 017.md
 create mode 100644 018.md
 create mode 100644 018_TEST_REPORT.md
 create mode 100644 019_FINAL_VERIFICATION_REPORT.md
 create mode 100644 019_PRODUCTION_TESTING_PLAN.md
 create mode 100644 019_PRODUCTION_TESTING_REPORT.md
 create mode 100644 019_QUICK_TASK.md
 create mode 100644 019_VERIFICATION_TASK.md
 create mode 100644 020_QTICKETS_PRODUCTION_TESTING.md
 create mode 100644 021_UBUNTU_DEPLOYMENT_GUIDE.md
 create mode 100644 022_MIGRATION_GUIDE.md
 create mode 100644 023_DATALENS_SETUP_GUIDE.md
 create mode 100644 024_COMPREHENSIVE_TROUBLESHOOTING_GUIDE.md
 create mode 100644 025_COMPLETE_DEPLOYMENT_PACKAGE.md
 create mode 100644 CI_RECOMMENDATIONS.md
 create mode 100644 ZAKAZ_DASHBOARD_AUDIT_REPORT.md
 create mode 100644 dashboard-mvp/CONTRIBUTING.md
 create mode 100644 dashboard-mvp/PROD_DEPLOY_CHECKLIST_QTICKETS_API.md
 create mode 100644 dashboard-mvp/README_E2E_QTICKETS_API.md
 create mode 100644 dashboard-mvp/TASK-QT-API-E2E-LOCAL-REPORT.md
 create mode 100644 dashboard-mvp/TASK-QT-API-E2E-REPORT.md
 create mode 100644 dashboard-mvp/TASK-QT-API-LIVE-SMOKE-REPORT.md
 create mode 100644 dashboard-mvp/TASK-QT-API-PRIMARY-REPORT.md
 create mode 100644 dashboard-mvp/TASK-QT-API-PROD-READY-REPORT.md
 create mode 100644 dashboard-mvp/ZAKAZ_DASHBOARD_AUDIT_REPORT.md
 create mode 100644 dashboard-mvp/archive/outdated/DEPLOYMENT_INSTRUCTIONS.md
 create mode 100644 dashboard-mvp/archive/outdated/E2E_QTICKETS_API_INSTRUCTIONS.md
 rename dashboard-mvp/{ => archive/outdated}/test_clickhouse_setup.py (100%)
 rename dashboard-mvp/{ => archive/outdated}/test_system.sh (100%)
 create mode 100644 dashboard-mvp/configs/.env.qtickets_api.sample
 create mode 100644 dashboard-mvp/docs/DEPLOYMENT.md
 create mode 100644 dashboard-mvp/e2e_qtickets_api_test.sh
 create mode 100644 dashboard-mvp/infra/clickhouse/.env.example
 create mode 100644 dashboard-mvp/infra/clickhouse/bootstrap_all.sql
 create mode 100644 dashboard-mvp/infra/clickhouse/bootstrap_roles_grants.sql
 create mode 100644 dashboard-mvp/infra/clickhouse/bootstrap_schema.sql
 create mode 100644 dashboard-mvp/infra/clickhouse/caddy_data/.gitignore
 create mode 100644 dashboard-mvp/infra/clickhouse/caddy_data/.gitkeep
 create mode 100644 dashboard-mvp/infra/clickhouse/config.d/20-security.xml.bak.20251029115029
 create mode 100644 dashboard-mvp/infra/clickhouse/config.d/config.d.backup/20-security.xml
 create mode 100644 dashboard-mvp/infra/clickhouse/migrations/2025-qtickets-api-final.sql
 create mode 100644 dashboard-mvp/infra/clickhouse/migrations/2025-qtickets-api-grants.sql
 create mode 100644 dashboard-mvp/infra/clickhouse/migrations/2025-qtickets-api.LOCAL.sql
 create mode 100644 dashboard-mvp/infra/clickhouse/migrations/2025-qtickets-api.sql
 create mode 100644 dashboard-mvp/infra/clickhouse/smoke_checks_qtickets_api.LOCAL.sql
 create mode 100644 dashboard-mvp/infra/clickhouse/smoke_checks_qtickets_api.sql
 create mode 100644 dashboard-mvp/infra/clickhouse/users.d/00-admin.xml
 create mode 100644 dashboard-mvp/infra/clickhouse/users.d/10-service-users.xml
 delete mode 100644 dashboard-mvp/infra/clickhouse/users.d/10-users.xml
 create mode 100644 dashboard-mvp/infra/clickhouse/users.d/default-user.xml.disabled
 create mode 100644 dashboard-mvp/infra/systemd/qtickets_api.service
 create mode 100644 dashboard-mvp/infra/systemd/qtickets_api.timer
 create mode 100644 dashboard-mvp/integrations/qtickets_api/Dockerfile
 create mode 100644 dashboard-mvp/integrations/qtickets_api/README.md
 create mode 100644 dashboard-mvp/integrations/qtickets_api/__init__.py
 create mode 100644 dashboard-mvp/integrations/qtickets_api/client.py
 create mode 100644 dashboard-mvp/integrations/qtickets_api/config.py
 create mode 100644 dashboard-mvp/integrations/qtickets_api/inventory_agg.py
 create mode 100644 dashboard-mvp/integrations/qtickets_api/loader.py
 create mode 100644 dashboard-mvp/integrations/qtickets_api/requirements.txt
 create mode 100644 dashboard-mvp/integrations/qtickets_api/tests/__init__.py
 create mode 100644 dashboard-mvp/integrations/qtickets_api/tests/test_client.py
 create mode 100644 dashboard-mvp/integrations/qtickets_api/tests/test_inventory_agg.py
 create mode 100644 dashboard-mvp/integrations/qtickets_api/tests/test_transform.py
 create mode 100644 dashboard-mvp/integrations/qtickets_api/transform.py
 create mode 100644 dashboard-mvp/local_test/ch/docker-compose.yml
 create mode 100644 dashboard-mvp/local_test/run_e2e_test.sh
 create mode 100644 dashboard-mvp/manual_qtickets_smoke.py
 create mode 100644 dashboard-mvp/ops/systemd/qtickets_api.service
 create mode 100644 dashboard-mvp/ops/systemd/qtickets_api.timer
 create mode 100644 dashboard-mvp/qtickets_debug/TASK-QT-API-PROD-FINAL-RUN.log
 create mode 100644 dashboard-mvp/qtickets_debug/TASK-QT-API-PROD-HARDEN-LOCAL-RUN.log
 create mode 100644 dashboard-mvp/qtickets_debug/orders_only_test.py
 create mode 100644 dashboard-mvp/qtickets_debug/orders_probe.py
 create mode 100644 dashboard-mvp/qtickets_debug/orders_probe_final.py
 create mode 100644 dashboard-mvp/qtickets_debug/orders_probe_simple.py
 create mode 100755 dashboard-mvp/scripts/bootstrap_clickhouse.sh
 create mode 100644 dashboard-mvp/scripts/bootstrap_datalens.sh
 create mode 100755 dashboard-mvp/scripts/smoke_qtickets_dryrun.sh
 create mode 100644 dashboard-mvp/test_env/.env.qtickets_api
 create mode 100644 dashboard-mvp/test_env/.env.qtickets_api.bad
 create mode 100644 dashboard-mvp/test_env/.env.template
 create mode 100644 docs/adr/ADR-003-clickhouse-schema-fix.md
 create mode 100644 docs/adr/ADR-004-clickhouse-schema-consistency.md
 create mode 100644 docs/adr/ADR-005-clickhouse-production-hardening.md
 create mode 100644 docs/adr/ADR-006-clickhouse-schema-lockdown.md
 create mode 100644 docs/adr/ADR-007-clickhouse-schema-canonicalization.md
 create mode 100644 docs/changelog/CHANGELOG-003.md
 create mode 100644 docs/changelog/CHANGELOG-005.md
 create mode 100644 docs/changelog/CHANGELOG-006.md
 create mode 100644 docs/changelog/CHANGELOG-007.md
 create mode 100644 docs/changelog/CHANGELOG-008.md
 create mode 100644 docs/changelog/CHANGELOG-009.md
 create mode 100644 docs/changelog/CHANGELOG-010.md
 create mode 100644 docs/changelog/CHANGELOG-011.md
 create mode 100644 docs/changelog/CHANGELOG-012.md
 create mode 100644 docs/changelog/CHANGELOG-013.md
 create mode 100644 docs/changelog/CHANGELOG-014.md
 create mode 100644 docs/changelog/CHANGELOG-015.md
 create mode 100644 logs/canonical_schemas.md
 create mode 100644 logs/compileall.log
 create mode 100644 logs/create_table_inventory.log
 create mode 100644 logs/docker_build.log
 create mode 100644 logs/pytest.log
 create mode 100644 logs/schema_validation.log
 create mode 100644 logs/schema_validation_after_full_fix.log
 create mode 100644 logs/schema_validation_after_migration_fix.log
 create mode 100644 logs/schema_validation_before.log
 create mode 100644 logs/schema_validation_failure_test.log
 create mode 100644 logs/schema_validation_final.log
 create mode 100644 logs/schema_validation_with_mail.log
 create mode 100644 logs/smoke_qtickets.log
 create mode 100644 logs/task-008/qtickets_api_second_run.log
 create mode 100644 logs/task-009/qtickets_api_production.log
 create mode 100644 logs/task010/clickhouse-server.err.log
 create mode 100644 logs/task010/clickhouse-server.log
 create mode 100644 logs/task010/clickhouse_query_log.txt
 create mode 100644 logs/task010/clickhouse_text_log.txt
 create mode 100644 logs/task010/http_check_docker.txt
 create mode 100644 logs/task010/http_check_host.txt
 create mode 100644 logs/task010/inventory_check.txt
 create mode 100644 logs/task010/meta_job_runs.txt
 create mode 100644 logs/task010/orders_check.txt
 create mode 100644 logs/task010/qtickets_run.log
 create mode 100644 logs/task010_bundle.tgz
 create mode 100644 logs/task011/after_clickhouse-server.err.log
 create mode 100644 logs/task011/after_clickhouse-server.log
 create mode 100644 logs/task011/after_query_log.txt
 create mode 100644 logs/task011/after_text_log.txt
 create mode 100644 logs/task011/before_clickhouse-server.err.log
 create mode 100644 logs/task011/before_clickhouse-server.log
 create mode 100644 logs/task011/before_query_log.txt
 create mode 100644 logs/task011/before_text_log.txt
 create mode 100644 logs/task011/inventory_check.txt
 create mode 100644 logs/task011/manual_insert.log
 create mode 100644 logs/task011/meta_job_runs.txt
 create mode 100644 logs/task011/orders_check.txt
 create mode 100644 logs/task011/qtickets_run.log
 create mode 100644 logs/task011_bundle.tgz
 create mode 100644 logs/task012/after_query_log.txt
 create mode 100644 logs/task012/after_text_log.txt
 create mode 100644 logs/task012/clickhouse-server.err.log
 create mode 100644 logs/task012/clickhouse-server.log
 create mode 100644 logs/task012/inventory_check.txt
 create mode 100644 logs/task012/manual_insert.log
 create mode 100644 logs/task012/meta_job_runs.txt
 create mode 100644 logs/task012/orders_check.txt
 create mode 100644 logs/task012/qtickets_run.log
 create mode 100644 logs/task012_bundle.tgz
 create mode 100644 logs/task013/inventory_check.txt
 create mode 100644 logs/task013/meta_job_runs.txt
 create mode 100644 logs/task013/orders_check.txt
 create mode 100644 logs/task013/qtickets_run.log
 create mode 100644 logs/task013_bundle.tgz
 create mode 100644 python_compile.log
 create mode 100644 python_compile_fixed.log
 create mode 100644 schema_validation.log
 create mode 100644 scripts/validate_clickhouse_schema.py
 create mode 100644 secrets/.env.qtickets_api
 create mode 100644 secrets/.env.qtickets_api.bad
etl@museshow:/opt/zakaz_dashboard$ # Удалим мусор, но оставим secrets/ и бэкапы
etl@museshow:/opt/zakaz_dashboard$ git clean -fd -e secrets -e 'dashboard-mvp.bak.*' -e backups -e logs
etl@museshow:/opt/zakaz_dashboard$ git status
On branch main
Your branch is up to date with 'origin/main'.

Untracked files:
  (use "git add <file>..." to include in what will be committed)
        Zakaz_Dashboard/
        dashboard-mvp.bak.202510271525/

nothing added to commit but untracked files present (use "git add" to track)
etl@museshow:/opt/zakaz_dashboard$ cd /opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ [ -f .env ] || cp .env.example .env
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ # проверь значения (логин/пароль/БД)
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ sed -n '1,120p' .env
иса compose)
docker compose up -d --build || docker-compose up -d --build
docker compose ps || docker-compose ps

# Переменные для удобства следующих коCLICKHOUSE_ADMIN_USER=admin
CLICKHOUSE_ADMIN_PASSWORD=admin_pass
CLICKHOUSE_DB=zakaz
CLICKHOUSE_TZ=Europe/Moscow
CLICKHOUSE_HTTP_PORT=8123
CLICKHOUSE_NATIVE_PORT=9000
манд
set -a; source .env; set +a

# Healthcheck
docetl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ # запустить/пересобрать CH (поддержим оба синтаксиса compose)
ker exec ch-zakaz clickhouse-client -u "${CLICKHOUetl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ docker compose up -d --build || docker-compose up -d --build
SE_ADMIN_USER}" --password "${CLICKHOUSE_ADMIN_PASSWORD}" -q "SELECT 'CH OK' ok"
WARN[0000] /opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion
[+] Running 1/1
 ✔ Container ch-zakaz  Started                                                                                     0.8s
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ docker compose ps || docker-compose ps
WARN[0000] /opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion
NAME       IMAGE                               COMMAND            SERVICE      CREATED        STATUS                                     PORTS
ch-zakaz   clickhouse/clickhouse-server:24.8   "/entrypoint.sh"   clickhouse   1 second ago   Up Less than a second (health: starting)   0.0.0.0:8123->8123/tcp, [::]:8123->8123/tcp, 0.0.0.0:9000->9000/tcp, [::]:9000->9000/tcp, 9009/tcp
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ # Переменные для удобства следующих команд
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ set -a; source .env; set +a
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ # Healthcheck
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ docker exec ch-zakaz clickhouse-client -u "${CLICKHOUSE_ADMIN_USER}" --password "${CLICKHOUSE_ADMIN_PASSWORD}" -q "SELECT 'CH OK' ok"
Code: 210. DB::NetException: Connection refused (localhost:9000). (NETWORK_ERROR)

etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ cd /opt/zakaz_dashboard
etl@museshow:/opt/zakaz_dashboard$
etl@museshow:/opt/zakaz_dashboard$ if [ -f dashboard-mvp/scripts/bootstrap_clickhouse.sh ]; then
>   bash dashboard-mvp/scripts/bootstrap_clickhouse.sh
> elif [ -f dashboard-mvp/infra/clickhouse/bootstrap_all.sql ]; then
>   docker exec -i ch-zakaz clickhouse-client -u "${CLICKHOUSE_ADMIN_USER}" --password "${CLICKHOUSE_ADMIN_PASSWORD}" -n < dashboard-mvp/infra/clickhouse/bootstrap_all.sql
> elif [ -d dashboard-mvp/infra/clickhouse/migrations ]; then
>   for f in $(ls -1 dashboard-mvp/infra/clickhouse/migrations/*.sql | sort); do
>     echo ">> applying $f"
>     docker exec -i ch-zakaz clickhouse-client -u "${CLICKHOUSE_ADMIN_USER}" --password "${CLICKHOUSE_ADMIN_PASSWORD}" -n < "$f"
>   done
> fi

docker exec ch-zakaz clickhouse-client -u "${CLICKHOUSE_ADMIN_USER}" --password "${CLICKHOUSE_ADMIN_PASSWORD}" -q "
  SELECT database, name FROM system.tables WHERE database='${CLICKHOUSE_D[bootstrap] Preparing ClickHouse data directories...
[bootstrap] WARNING: Unable to chown directories to 101:101. Run the script with sufficient privileges if ClickHouse fails to start.
B}' ORDER BY name LIMIT 20"
[bootstrap] Starting ClickHouse via docker compose...
WARN[0000] /opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse/docker-compose.yml: the attribute `version` is obsolete, it will be ignored, please remove it to avoid potential confusion
[+] Running 1/1
 ✔ Container ch-zakaz  Running                                                                                     0.0s
[bootstrap] Waiting for container ch-zakaz to become healthy...

^[^[^[^[


ERROR: ClickHouse container health status is 'unhealthy'. Check docker logs ch-zakaz for details.
etl@museshow:/opt/zakaz_dashboard$
etl@museshow:/opt/zakaz_dashboard$ docker exec ch-zakaz clickhouse-client -u "${CLICKHOUSE_ADMIN_USER}" --password "${CLICKHOUSE_ADMIN_PASSWORD}" -q "
>   SELECT database, name FROM system.tables WHERE database='${CLICKHOUSE_DB}' ORDER BY name LIMIT 20"
Error response from daemon: Container 08cf20764faddb3c2287881e88533e47c01a6c540305c3d423d9319e37399385 is restarting, wait until the container is running
etl@museshow:/opt/zakaz_dashboard$
etl@museshow:/opt/zakaz_dashboard$
etl@museshow:/opt/zakaz_dashboard$
etl@museshow:/opt/zakaz_dashboard$
etl@museshow:/opt/zakaz_dashboard$ # работать из-под etl
etl@museshow:/opt/zakaz_dashboard$ whoami
oard-mvp/infra/clickhouse

# 1) Сохраним битый .enetl
etl@museshow:/opt/zakaz_dashboard$ cd /opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ # 1) Сохраним битый .env и восстановим из примера
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ mv .env ".env.broken.$(date +%F-%H%M%S)"
крой и ЗАПОЛНИ только ключи формата KEY=VALUE (никаких команд/комментариев!):
# CLICKHOUSE_ADMIN_USER=admin
# CLICKHOUSE_ADMIN_PASSWORD=<твой_пароль>
# CLICKHOUSE_DB=zakaz
# CLICKHOUSE_TZ=Europe/Moscow
# CLICKHOUSE_HTTP_PORT=8123
# CLICKHOUSE_NATIVE_PORT=9000
sudo -E nano .env

# 3) Экспортируем переменные в текущую сессию
set -a; source .env; etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ cp .env.example .env
set +a

# 4) Узнаём, какие пути примонтированы в контейнер (где нужны права 101:101)
docker compose up -d --build || docker-compose up -d --build
sleep 2
docker inspect ch-zakaz --format '{{range .Mounts}}{{println .Source "->" .Destination}}{{end}}'

# 5) Выставим права 101:101 на ХОСТЕ для ВСЕХ примонтированных директорий данных/логов/польз.файлов
# (ниже — типичныеetl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ # 2) Открой и ЗАПОЛНИ только ключи формата KEY=VALUE (никаких команд/комментариев!):
 каталоги в нашем репо; если inspect показал другие путetl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ # CLICKHOUSE_ADMIN_USER=admin
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ # CLICKHOUSE_ADMIN_PASSWORD=<твой_пароль>
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ # CLICKHOUSE_DB=zakaz
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ # CLICKHOUSE_TZ=Europe/Moscow
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ # CLICKHOUSE_HTTP_PORT=8123
r_filesetl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ # CLICKHOUSE_NATIVE_PORT=9000
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$ sudo -E nano .env


# 6) Полный перезапуск контейнера
docker compose down || docker-compose down
docker compose up -d --build || docker-compose up -d --build

# 7) Ждём health=healthy и проверяем подключения
watch -n 1 'docker inspect -f "{{.State.Health.Status}}" ch-zakaz'

# как только станет healthy — проверяем нативный и HTTP интерфейсы:
docker exec ch-zakaz clickhouse-client -u "${CLICKHOUSE_ADMIN_USER}" --password "${CLICKHOUSE_ADMIN_PASSWORD}" -q "SELECT 1"
curl -s "http://localhost:${CLICKHOUSE_HTTP_PORT}/?query=SELECT%201"

# 3) Экспортируем переменные в текущую сессию
set -a; source .env; set +a

# 4) Узнаём, какие пути примонтированы в контейнер (где нужны права 101:101)
docker compose up -d --build || docker-compose up -d --build
sleep 2
docker inspect ch-zakaz --format '{{range .Mounts}}{{println .Source "->" .Destination}}{{end}}'

# 5) Выставим права 101:101 на ХОСТЕ для ВСЕХ примонтированных директорий данных/логов/польз.файлов
# (ниже — типичные каталоги в нашем репо; если inspect показал другие пути — применяй их)
sudo mkdir -p data logs user_files || true
sudo chown -R 101:101 data logs user_files

# 6) Полный перезапуск контейнера
docker compose down || docker-compose down
docker compose up -d --build || docker-compose up -d --build

# 7) Ждём health=healthy и проверяем подключения
watch -n 1 'docker inspect -f "{{.State.Health.Status}}" ch-zakaz'

# как только станет healthy — проверяем нативный и HTTP интерфейсы:
docker exec ch-zakaz clickhouse-client -u "${CLICKHOUSE_ADMIN_USER}" --password "${CLICKHOUSE_ADMIN_PASSWORD}" -q "SELECT 1"
curl -s "http://localhost:${CLICKHOUSE_HTTP_PORT}/?query=SELECT%201"
etl@museshow:/opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse$