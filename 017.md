Задание: Полное сквозное тестирование готовности проекта к сдаче и подключению Yandex DataLens

Цель
Подтвердить, что репозиторий в текущем состоянии разворачивается «из коробки», успешно выполняет загрузку QTickets с боевыми ключами, и готов к подключению BI-витрин через DataLens. В ходе проверки собрать полный лог всех действий.

Шаги

Подготовка окружения

git pull в рабочем каталоге, убедиться, что git status чистый.
Зафиксировать версии: docker --version, docker compose version, python3 --version.
Если ClickHouse-контейнер запущен — остановить: cd dashboard-mvp/infra/clickhouse && docker compose down.
Очистить данные для чистого прогона: rm -rf data logs (или удалить volume при необходимости).
Бутстрап ClickHouse

cp .env.example .env.
Запустить ../../scripts/bootstrap_clickhouse.sh, сохранить полный вывод (stdout/ stderr).
Проверить здоровье: docker inspect -f '{{.State.Health.Status}}' ch-zakaz → ожидается healthy.
Убедиться, что таблицы созданы:
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "SHOW TABLES FROM zakaz;".
Сделать дамп списка таблиц в лог отчета.
Проверка прав и GRANT-ов

Применить bootstrap_grants.sql:
docker exec -i ch-zakaz clickhouse-client --user=admin --password=admin_pass < bootstrap_grants.sql (ожидание: без ошибок).
Проверить доступ DataLens:
docker exec ch-zakaz clickhouse-client --user=datalens_reader --password=ChangeMe123\! -q "SELECT count() FROM system.tables WHERE database='zakaz';".
curl -u datalens_reader:ChangeMe123! http://localhost:8123/?query=SELECT%201.
Если внешний доступ планируется: открыть порт (если закрыт) sudo ufw allow 8123/tcp, проверить curl по публичному IP.
Smoke-тест DRY_RUN

Подготовить env: cp configs/.env.qtickets_api.sample secrets/.env.qtickets_api.
Убедиться, что в файле DRY_RUN=true, заполнены параметры ClickHouse (host ch-zakaz, порт 8123, пользователь admin, пароль admin_pass) и фиктивные токены.
Запустить cd dashboard-mvp && scripts/smoke_qtickets_dryrun.sh --env-file secrets/.env.qtickets_api.
Зафиксировать вывод скрипта. Ожидается:
Exit code 0.
meta_job_runs не изменился (скрипт сам проверяет).
Логи контейнера содержат stub-сообщения, без Traceback.
Боевой прогон (DRY_RUN=false)

Отредактировать secrets/.env.qtickets_api:
DRY_RUN=false, проставить реальные QTICKETS_TOKEN, ORG_NAME, при необходимости обновить таймауты.
Собрать прод-образ:
docker build -f integrations/qtickets_api/Dockerfile -t qtickets_api:prod .
Запустить ingestion:
docker run --rm \
  --network clickhouse_default \
  --env-file secrets/.env.qtickets_api \
  --name qtickets_api_run_$(date +%Y%m%d%H%M%S) \
  qtickets_api:prod
Сохранить весь вывод контейнера.
Проверки после запуска:
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "SELECT max(snapshot_ts) AS last_inventory_ts, count() FROM zakaz.stg_qtickets_api_inventory_raw;".
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "SELECT job, status, started_at, finished_at, rows_processed, message FROM zakaz.meta_job_runs WHERE job='qtickets_api' ORDER BY started_at DESC LIMIT 1;".
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "SELECT count() FROM zakaz.fact_qtickets_sales_daily WHERE event_date >= today()-1;".
Сделать повторный запуск (через несколько минут) и убедиться, что загрузчик отрабатывает без дублей и ошибок.
DataLens подключение

Из DataLens:
Создать подключение по HTTP с параметрами: Host — публичный IP сервера, Port — 8123, Database — zakaz, User — datalens_reader, Password — (при необходимости сменить заранее через ALTER USER).
Проверить успешность подключения (скриншот/лог).
Создать датасет из zakaz.v_qtickets_sales_dashboard, включить превью данных.
Построить один график (например, продажи по дню) и сделать скриншот.
Зафиксировать, что DataLens получает данные без ошибок.
Регрессионные проверки

Проверить поведение при отключенном ClickHouse: docker stop ch-zakaz, запустить загрузчик — убедиться, что инструмент корректно падает с ошибкой подключения, затем docker start ch-zakaz.
Проверить поведение при неверном токене Qtickets — ожидать понятное сообщение об ошибке/код выхода ≠ 0.
Запустить python scripts/validate_clickhouse_schema.py (из корня) — должно завершиться без ошибок.
Сбор артефактов

Сохранить:
Все команды и их вывод (желательно в одном текстовом файле или MD).
Логи запуска bootstrap_clickhouse.sh и smoke_qtickets_dryrun.sh.
Логи боевого контейнера Qtickets.
Вывод ClickHouse запросов (до/после).
Скриншоты/описание подключения DataLens и визуализации.
Сделать сводку: какое время занял запуск, сколько строк загрузилось, какие таблицы обновились.
Definition of Done (DoD)

ClickHouse после bootstrap_clickhouse.sh имеет статус healthy, схема содержит все требуемые таблицы.
Команда GRANT SELECT ON zakaz.* TO datalens_reader выполняется успешно без ручных правок.
datalens_reader авторизуется через HTTP, видит 31 таблицу, DataLens подключается и строит датасет.
Smoke-тест (DRY_RUN=true) завершается без записей в ClickHouse и без ошибок.
Боевой прогон (DRY_RUN=false) вставляет новые данные в stg_qtickets_api_*, fact_qtickets_*, meta_job_runs отражает успешный запуск, повторный запуск не создаёт дублей.
Все проверки собраны в отчёт: список команд, логи, результаты запросов, подтверждение подключения DataLens, описание любых обнаруженных проблем и их решений.
Репозиторий остаётся без незапланированных изменений (git status чистый).
Отчёт

По завершении предоставить markdown-файл или документ со следующими разделами:

Среда и версии (docker, compose, python, ОС).
Шаги и команды (каждый пункт с копией консольного вывода).
Результаты ClickHouse-запросов (таблицы, counts).
Информация о запуске загрузчика (логи, статус).
Подключение DataLens (описание действий + скриншоты).
Проблемы/ошибки (если возникали) и как были решены.
Вывод: подтверждение, что все критические сценарии выполнены, и система готова к сдаче.
Только после получения полного отчёта с подтверждением DoD задача считается закрытой.