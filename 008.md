Task 008 — End‑to‑End Qtickets Production Run Verification
Цель
Проверить, что боевой ingest qtickets_api полностью отрабатывает на реальных эндпоинтах и данных, без ошибок Unexpected ClickHouse error: 1, и данные попадают в нужные таблицы. Нужна отладка причины сбоя + подтверждение готовности пайплайна к продакшн‑использованию.

Подготовка среды
Убедитесь, что используете актуальную ветку main (свежий Pull).

git fetch origin
git checkout main
git reset --hard origin/main
Убедитесь, что тестовая среда имеет доступ к реальному API Qtickets (боевой токен и организация).

Скопируйте .env.qtickets_api.sample в секреты и заполните боевыми значениями:

cp dashboard-mvp/configs/.env.qtickets_api.sample \
   dashboard-mvp/secrets/.env.qtickets_api

# отредактировать:
nano dashboard-mvp/secrets/.env.qtickets_api
  DRY_RUN=false
  QTICKETS_TOKEN=<БОЕВОЙ ТОКЕН>
  ORG_NAME=<БОЕВАЯ ОРГАНИЗАЦИЯ>
  ... (остальные параметры при необходимости)
chmod 600 dashboard-mvp/secrets/.env.qtickets_api
Шаги проверки
1. Переподнять ClickHouse с нуля
Очистить данные и поднять заново:

cd dashboard-mvp/infra/clickhouse
docker compose down
rm -rf data logs
docker compose up -d
Дождаться статуса healthy:

docker ps --filter name=ch-zakaz
Применить схему:

docker exec -i ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  < bootstrap_schema.sql
Проверить, что таблицы созданы (например DESCRIBE zakaz.dim_events).

2. Включить расширенное логирование
Включить глобальные флаги:

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "SET GLOBAL log_queries = 1"

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "SYSTEM FLUSH LOGS"
Убедиться, что HTTP‑порт отвечает:

curl -u admin:admin_pass "http://127.0.0.1:8123/?query=SELECT%201"
3. Запустить боевой ingest
Собрать образ (если нужно):

docker build \
  -f dashboard-mvp/integrations/qtickets_api/Dockerfile \
  -t qtickets_api:prod \
  dashboard-mvp
Запустить ingestion:

docker run --rm \
  --network clickhouse_default \
  --env-file dashboard-mvp/secrets/.env.qtickets_api \
  --name qtickets_api_run_$(date +%Y%m%d%H%M%S) \
  qtickets_api:prod
Логи контейнера должны показывать реальные запросы и завершение без ошибок.
Если видите Unexpected ClickHouse error: 1 — зафиксировать время возникновения.

4. Диагностика возникновения error: 1
Сразу после запуска сбросить логи:

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "SYSTEM FLUSH LOGS"
Снять подробный текст ошибок:

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT event_time,
           logger_name,
           level,
           message
    FROM system.text_log
    WHERE event_time >= now() - INTERVAL 5 MINUTE
      AND level IN ('Error','Fatal')
    ORDER BY event_time DESC
    LIMIT 200
    FORMAT Vertical;
  "
и/или:

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT event_time,
           type,
           exception_code,
           exception,
           query
    FROM system.query_log
    WHERE event_time >= now() - INTERVAL 5 MINUTE
      AND exception_code != 0
    ORDER BY event_time DESC
    LIMIT 20
    FORMAT Vertical;
  "
Выявить, какой SQL вызвал ошибку (например, INSERT INTO ...). Сохранить текст ошибки и запрос.

5. Исправить причину ошибки
Сверить структуру таблицы с INSERT-запросом (поле/тип/порядок).
Проверить наличие таблиц и колонок.
Убедиться, что user admin имеет необходимые права.
Исправить схемы или код загрузчика, если они расходятся.
Повторить ingestion и добиться отсутствия ошибок error: 1.
6. Проверить данные
После успешного прогона:

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT max(sale_ts) AS last_order_ts,
           count() AS orders_loaded
    FROM zakaz.stg_qtickets_api_orders_raw;
  "

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT max(snapshot_ts) AS last_inventory_ts,
           count() AS inventory_rows
    FROM zakaz.stg_qtickets_api_inventory_raw;
  "

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT job, status, started_at, finished_at, rows_processed
    FROM zakaz.meta_job_runs
    WHERE job = 'qtickets_api'
    ORDER BY started_at DESC
    LIMIT 5;
  "
Убедиться, что:

meta_job_runs содержит запись со статусом ok и >0 строк.
В staging таблицах есть свежие записи.
При необходимости проверить агрегаты fact_qtickets_sales_daily, fact_qtickets_inventory_latest.
7. Очистить логирование (опционально)
docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "SET GLOBAL log_queries = 0"
docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "SYSTEM FLUSH LOGS"
Ожидаемые результаты
Контейнер qtickets_api:prod завершает работу без ошибок Unexpected ClickHouse error: 1.
В meta_job_runs появляется успешная запись с актуальным временем.
stg_qtickets_api_orders_raw и stg_qtickets_api_inventory_raw содержат свежие данные из боевого API.
Все ошибки (если возникали) задокументированы с текстом и корректирующими правками.
Отчет: зафиксируйте консольные выводы (копии логов) и опишите, какие изменения понадобились.