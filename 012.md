Task 012 — Продакшен‑ингест: подробный лог и фикc реальной ошибки
Цель: перестать видеть «Unexpected ClickHouse error: 1» и получить понятное сообщение об исключении (или сразу починить сбой), чтобы боевой запуск Qtickets API успешно писал данные в ClickHouse.

0. Подготовка окружения
Перейди в корень репозитория:
cd /opt/zakaz_dashboard/Zakaz_Dashboard
Создай каталог под артефакты задачи:
mkdir -p logs/task012
1. Усилить логирование ClickHouse-клиента
Файл: dashboard-mvp/integrations/common/ch.py

Открой файл, найди метод _call_with_retry (строки ~95–123).
Измени блоки обработки ошибок так, чтобы они логировали
тип исключения (exc.__class__.__name__),
строковое представление (repr(exc)),
и стек (используй logger.exception(...)).
Пример замены:
except ClickHouseError as exc:
    last_error = exc
    logger.warning(
        "ClickHouseError (%s): %r",
        exc.__class__.__name__,
        exc,
        exc_info=True,
    )
except Exception as exc:
    last_error = exc
    logger.error(
        "Unexpected ClickHouse error (%s): %r",
        exc.__class__.__name__,
        exc,
        exc_info=True,
    )
В insert() (ниже по файлу) перед вызовом _call_with_retry добавь логирование таблицы и количества строк:
logger.debug("Insert into %s rows=%s", table, len(data) if hasattr(data, '__len__') else 'unknown')
и, если есть column_names, тоже логируй их.
Сохрани файл.
2. Собери и задокументируй приложение
Собери новый образ:
docker build \
  -f dashboard-mvp/integrations/qtickets_api/Dockerfile \
  -t qtickets_api:prod \
  dashboard-mvp
Убедись, что файл dashboard-mvp/secrets/.env.qtickets_api содержит БОЕВЫЕ значения:
DRY_RUN=false
QTICKETS_TOKEN=… (боевой ключ)
ORG_NAME=… (боевой идентификатор)
CLICKHOUSE_HOST=ch-zakaz
CLICKHOUSE_PORT=8123
CLICKHOUSE_USER=admin
CLICKHOUSE_PASSWORD=admin_pass
CLICKHOUSE_DB=zakaz
Проверить, что ClickHouse поднят:
docker ps --filter name=ch-zakaz
curl -s -u admin:admin_pass "http://127.0.0.1:8123/?query=SELECT%201"
3. Подготовить ClickHouse к сбору логов
Включи глобальное логирование (убедись, нет синтаксической ошибки):
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "SET GLOBAL log_queries = 1"
Сбрось накопленные записи:
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "SYSTEM FLUSH LOGS"
4. Запусти продакшен-интеграцию и собери её лог
Запуск ingestion с фиксацией вывода:
docker run --rm \
  --network clickhouse_default \
  --env-file dashboard-mvp/secrets/.env.qtickets_api \
  --name qtickets_api_run_$(date +%Y%m%d%H%M%S) \
  qtickets_api:prod | tee logs/task012/qtickets_run.log
После завершения обязательно снова выполнить:
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "SYSTEM FLUSH LOGS"
5. Снять свежие логи ClickHouse
Серверные логи:
docker exec ch-zakaz tail -n 200 /var/log/clickhouse-server/clickhouse-server.log \
  > logs/task012/clickhouse-server.log

docker exec ch-zakaz tail -n 100 /var/log/clickhouse-server/clickhouse-server.err.log \
  > logs/task012/clickhouse-server.err.log
System text_log (ошибки/фатальные):
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "
  SELECT event_time, logger_name, level, message
  FROM system.text_log
  WHERE event_time >= now() - INTERVAL 10 MINUTE
    AND level IN ('Error', 'Fatal')
  ORDER BY event_time DESC
  LIMIT 200
  FORMAT Vertical;
" > logs/task012/after_text_log.txt
Query log с ошибками:
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "
  SELECT event_time, type, query, exception_code, exception
  FROM system.query_log
  WHERE event_time >= now() - INTERVAL 10 MINUTE
    AND exception_code != 0
  ORDER BY event_time DESC
  LIMIT 200
  FORMAT Vertical;
" > logs/task012/after_query_log.txt
6. Проверить таблицы и вручную подтвердить INSERT
Контроль данных:
docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "
  SELECT max(sale_ts) AS last_order_ts,
         count() AS orders_loaded
  FROM zakaz.stg_qtickets_api_orders_raw;
" > logs/task012/orders_check.txt

docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "
  SELECT job, status, started_at, finished_at, rows_processed, message
  FROM zakaz.meta_job_runs
  WHERE job = 'qtickets_api'
  ORDER BY started_at DESC
  LIMIT 10;
" > logs/task012/meta_job_runs.txt

docker exec ch-zakaz clickhouse-client --user=admin --password=admin_pass -q "
  SELECT max(snapshot_ts) AS last_inventory_ts,
         count() AS inventory_rows
  FROM zakaz.stg_qtickets_api_inventory_raw;
" > logs/task012/inventory_check.txt
Если ingestion снова упал — вручную вставь тестовую строку и дай её логам (как в Task 011). Результат сохрани в logs/task012/manual_insert.log.
7. Заархивируй артефакты
tar -czf logs/task012_bundle.tgz logs/task012
8. Подготовь документацию и отчёт
Создай docs/changelog/CHANGELOG-012.md с описанием:
какие изменения в логировании внесены;
как прошёл прогон;
что за ошибка теперь видна (цитата из логов);
статус вставки (успех/провал);
состояние staging-таблиц и meta_job_runs.
Обнови ZAKAZ_DASHBOARD_AUDIT_REPORT.md: раздел “Task 012”, ссылки на логи, краткий вывод.
Проверка Git:
git status
git add logs/task012 logs/task012_bundle.tgz docs/changelog/CHANGELOG-012.md ZAKAZ_DASHBOARD_AUDIT_REPORT.md dashboard-mvp/integrations/common/ch.py
git commit -m "Task 012: improve CH logging and capture insertion error details"
Definition of Done
В ch.py расширено логирование (видно имя класса и текст исключения, стек).
Прогон qtickets_api:prod выполнен с сохранением лога.
В logs/task012/after_text_log.txt или after_query_log.txt присутствует реальный текст ошибки (например, Code: 53. TypeMismatch ...).
orders_check.txt, inventory_check.txt, meta_job_runs.txt показывают актуальное состояние.
Все артефакты собраны в logs/task012, упакованы в logs/task012_bundle.tgz.
Changelog и аудит-репорт обновлены, изменения закоммичены.
После этого у нас будет чеканный текст исключения и запрос, из-за которого падают вставки — можно будет формулировать задачу на конкретное исправление (тип поля, порядок колонок, None в обязательном поле и т.п.).