# Task 004 – Довести ClickHouse DDL до единственной, согласованной схемы (dim_events + связанные объекты)

## Цель
Обеспечить продуктивную схему ClickHouse, в которой:
- таблица `zakaz.dim_events` и связанные объекты описаны ровно один раз;
- bootstrap (`bootstrap_schema.sql`, `bootstrap_all.sql`, `init.sql`, `init_qtickets_sheets.sql`) успешно выполняется дважды подряд на чистой БД;
- все представления (включая `zakaz.v_qtickets_freshness`) используют существующие поля;
- smoke-тесты и CI продолжают проходить.

## Контекст
В `bootstrap_schema.sql` (а также в других SQL-файлах) остаются старые определения `zakaz.dim_events` — рядом с актуальным вариантом (`start_date`, `end_date`, `_loaded_at`). При чтении файла ClickHouse натыкается на первую (устаревшую) версию, создает таблицу без новых полей, и любые вьюхи, ожидающие `start_date`, падают.

## План работ

### 1. Инвентаризация DDL
1. Найти все упоминания `CREATE TABLE IF NOT EXISTS zakaz.dim_events` и `ALTER TABLE … dim_events`.
   - файлы: `dashboard-mvp/infra/clickhouse/bootstrap_schema.sql`, `bootstrap_all.sql`, `init.sql`, `init_qtickets_sheets.sql`.
   - командой: `rg "CREATE TABLE IF NOT EXISTS zakaz.dim_events" dashboard-mvp/infra/clickhouse`.
2. Зафиксировать, какие варианты схемы встречаются (старый `event_date`, новый `start_date/end_date`, промежуточные).
3. Проверить связанные `DROP TABLE`, `ALTER` — убрать/обновить, если они ориентируются на старую схему.

### 2. Согласовать «истинную» схему dim_events
1. Принять за эталон новую структуру (`event_id`, `event_name`, `city`, `start_date`, `end_date`, `_loaded_at`, `_ver`).
2. Оставить **ровно один** `CREATE TABLE` блок с этой схемой в каждом SQL-файле.
3. Удалить (или закомментировать с пояснением) старые версии.
4. Аналогично поступить с `fact_qtickets_inventory` и другими таблицами, где при bootstrap встречаются старые версии без `_loaded_at`.

### 3. Проверить представления и smoke SQL
1. Просмотреть все `CREATE OR REPLACE VIEW … dim_events` или использующие `start_date/end_date`.
   - `zakaz.v_qtickets_freshness`
   - `zakaz.v_qtickets_sales_dashboard`
   - прочие, отсылающие к `dim_events`
2. Убедиться, что вьюхи используют поля, которые есть в новой таблице.
3. Проверить блоки вида `SELECT … FROM zakaz.dim_events` в smoke/sql-скриптах (например, `smoke_checks_qtickets_api.sql`) — чтобы агрегаты тоже обращались к верным полям.

### 4. Повторный bootstrap (двойной)
1. Запустить ClickHouse 24.8 (docker-compose либо отдельный контейнер).
2. `dashboard-mvp/scripts/bootstrap_clickhouse.sh` — **первый запуск** (на пустом инстансе).
3. `dashboard-mvp/scripts/bootstrap_clickhouse.sh` — **второй запуск** (без удаления данных).
4. Фиксировать любые ошибки; устранить (например, `CREATE VIEW` дважды подряд, при `CREATE OR REPLACE` — ok).

### 5. Smoke и тесты
1. Выполнить `dashboard-mvp/scripts/smoke_qtickets_dryrun.sh --env-file dashboard-mvp/test_env/.env.template`.
2. Выполнить `cd dashboard-mvp/vk-python && python -m pytest`.
3. Убедиться, что `python scripts/validate_clickhouse_schema.py` по-прежнему возвращает “Schema validation passed.”

### 6. Документация и отчёт
1. Обновить `ZAKAZ_DASHBOARD_AUDIT_REPORT.md` — зафиксировать успешный double-bootstrap и smoke.
2. При необходимости дополнить `docs/changelog/CHANGELOG-00X.md` / ADR с описанием изменений.
3. Убедиться, что `CI_RECOMMENDATIONS.md` и `CONTRIBUTING.md` не требуют адаптации (если поменялся workflow).

## Definition of Done
- Во всех SQL-файлах только одно определение `zakaz.dim_events` (с `start_date/end_date/_loaded_at`).
- Таблица `fact_qtickets_inventory` также имеет `_loaded_at` в `CREATE` и нет конфликтующих версий.
- `bootstrap_clickhouse.sh` проходит дважды без ошибок.
- `smoke_qtickets_dryrun.sh` завершается кодом 0.
- `python -m pytest` (в `vk-python`) зелёный.
- `python scripts/validate_clickhouse_schema.py` — “Schema validation passed.”
- Документация (README, аудиторский отчёт) обновлена.

## Контрольные команды

```bash
# поиск определений dim_events
rg "CREATE TABLE IF NOT EXISTS zakaz.dim_events" dashboard-mvp/infra/clickhouse

# очистка и двойной bootstrap
docker compose down -v      # при использовании compose
dashboard-mvp/scripts/bootstrap_clickhouse.sh
dashboard-mvp/scripts/bootstrap_clickhouse.sh

# smoke и тесты
dashboard-mvp/scripts/smoke_qtickets_dryrun.sh --env-file dashboard-mvp/test_env/.env.template
cd dashboard-mvp/vk-python && python -m pytest

# статический чекер
python scripts/validate_clickhouse_schema.py
