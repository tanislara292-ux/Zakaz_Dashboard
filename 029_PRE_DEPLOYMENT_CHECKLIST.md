# ЧЕК-ЛИСТ ПЕРЕД РАЗВЕРТЫВАНИЕМ ZAKAZ DASHBOARD

## Обзор

Данный чек-лист предназначен для полной проверки готовности сервера заказчика к развертыванию системы Zakaz Dashboard. Чек-лист основан на реальных проблемах, обнаруженных при развертывании на сервере заказчика.

---

## ИНФОРМАЦИЯ О СЕРВЕРЕ

### Основные параметры

- **IP адрес сервера**: `_________________`
- **Домен**: `_________________`
- **Операционная система**: `_________________`
- **Версия ОС**: `_________________`
- **Пользователь для развертывания**: `_________________`
- **Дата проверки**: `_________________`

### Требования к серверу

- [ ] **CPU**: Минимум 4 ядра (рекомендуется 8+)
- [ ] **RAM**: Минимум 8GB (рекомендуется 16GB+)
- [ ] **Диск**: Минимум 100GB SSD (рекомендуется 500GB+)
- [ ] **Сеть**: Стабильное интернет-соединение
- [ ] **Порты**: 80, 443, 8123, 9000 доступны

---

## ЭТАП 1: ПОДГОТОВКА СЕРВЕРА

### 1.1 Системные требования

- [ ] **Ubuntu 20.04+** установлена
  ```bash
  # Проверка команды:
  lsb_release -a
  # Ожидаемый результат: Ubuntu 20.04/22.04/24.04
  ```

- [ ] **Обновление системы** выполнено
  ```bash
  # Проверка команды:
  apt list --upgradable
  # Ожидаемый результат: нет доступных обновлений
  ```

- [ ] **Перезагрузка** выполнена после обновления

### 1.2 Установка Docker

- [ ] **Docker** установлен и работает
  ```bash
  # Проверка команды:
  docker --version
  # Ожидаемый результат: версия Docker 20.10+
  ```

- [ ] **Docker Compose** установлен
  ```bash
  # Проверка команды:
  docker-compose --version
  # или
  docker compose version
  # Ожидаемый результат: версия 2.0+
  ```

- [ ] **Docker сервис** запущен и добавлен в автозагрузку
  ```bash
  # Проверка команды:
  systemctl status docker
  # Ожидаемый результат: active (running)
  ```

### 1.3 Установка дополнительных пакетов

- [ ] **Git** установлен
  ```bash
  # Проверка команды:
  git --version
  # Ожидаемый результат: версия 2.25+
  ```

- [ ] **Python 3** и pip установлены
  ```bash
  # Проверка команды:
  python3 --version
  pip3 --version
  ```

- [ ] **Дополнительные утилиты** установлены
  ```bash
  # Проверка команд:
  curl --version
  wget --version
  htop --version
  ```

---

## ЭТАП 2: НАСТРОЙКА ПОЛЬЗОВАТЕЛЕЙ И ПРАВ

### 2.1 Пользователь ETL

- [ ] **Пользователь etl** создан
  ```bash
  # Проверка команды:
  id etl
  # Ожидаемый результат: информация о пользователе
  ```

- [ ] **Пользователь etl** добавлен в группы docker и sudo
  ```bash
  # Проверка команды:
  groups etl
  # Ожидаемый результат: etl docker sudo
  ```

- [ ] **Безпарольный sudo** настроен для etl
  ```bash
  # Проверка команды:
  sudo -u etl sudo -n true
  # Ожидаемый результат: нет запроса пароля
  ```

### 2.2 Директория проекта

- [ ] **Директория /opt/zakaz_dashboard** создана
  ```bash
  # Проверка команды:
  ls -la /opt/zakaz_dashboard
  # Ожидаемый результат: директория существует
  ```

- [ ] **Права на директорию** установлены правильно
  ```bash
  # Проверка команды:
  ls -ld /opt/zakaz_dashboard
  # Ожидаемый результат: владелец etl:etl
  ```

---

## ЭТАП 3: РЕПОЗИТОРИЙ И КОНФИГУРАЦИЯ

### 3.1 Клонирование репозитория

- [ ] **Репозиторий** склонирован
  ```bash
  # Проверка команды:
  cd /opt/zakaz_dashboard && git status
  # Ожидаемый результат: статус Git репозитория
  ```

- [ ] **Ветка main** выбрана
  ```bash
  # Проверка команды:
  cd /opt/zakaz_dashboard && git branch
  # Ожидаемый результат: * main
  ```

- [ ] **Последние обновления** получены
  ```bash
  # Проверка команды:
  cd /opt/zakaz_dashboard && git log --oneline -n 3
  # Ожидаемый результат: последние коммиты
  ```

### 3.2 Проблемы с правами Git

- [ ] **Проблема "dubious ownership"** решена
  ```bash
  # Проверка команды:
  cd /opt/zakaz_dashboard && sudo -u etl git status
  # Ожидаемый результат: нет ошибки "dubious ownership"
  ```

- [ ] **Safe directory** настроен (если необходимо)
  ```bash
  # Проверка команды:
  sudo -u etl git config --global --get safe.directory
  # Ожидаемый результат: /opt/zakaz_dashboard в списке
  ```

---

## ЭТАП 4: КОНФИГУРАЦИЯ CLICKHOUSE

### 4.1 Файлы конфигурации

- [ ] **Файл .env** создан из .env.example
  ```bash
  # Проверка команды:
  ls -la /opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse/.env
  # Ожидаемый результат: файл существует
  ```

- [ ] **Пароль администратора** изменен в .env
  ```bash
  # Проверка команды:
  grep CLICKHOUSE_ADMIN_PASSWORD /opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse/.env
  # Ожидаемый результат: пароль отличен от admin_pass
  ```

- [ ] **Файл 00-admin.xml** существует и корректен
  ```bash
  # Проверка команды:
  ls -la /opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse/users.d/00-admin.xml
  # Ожидаемый результат: файл существует
  ```

- [ ] **Файл 10-service-users.xml** существует
  ```bash
  # Проверка команды:
  ls -la /opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse/users.d/10-service-users.xml
  # Ожидаемый результат: файл существует
  ```

### 4.2 Права доступа к директориям ClickHouse

- [ ] **Директории data, logs, user_files** созданы
  ```bash
  # Проверка команды:
  ls -la /opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse/
  # Ожидаемый результат: директории существуют
  ```

- [ ] **Права 101:101** установлены на директории
  ```bash
  # Проверка команды:
  stat -c "%U:%G" /opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse/data
  # Ожидаемый результат: 101:101
  ```

### 4.3 Запуск и проверка ClickHouse

- [ ] **Контейнер ClickHouse** запущен
  ```bash
  # Проверка команды:
  docker ps | grep ch-zakaz
  # Ожидаемый результат: контейнер в списке
  ```

- [ ] **Healthcheck** проходит успешно
  ```bash
  # Проверка команды:
  docker inspect -f '{{.State.Health.Status}}' ch-zakaz
  # Ожидаемый результат: healthy
  ```

- [ ] **Подключение** к ClickHouse работает
  ```bash
  # Проверка команды:
  docker exec ch-zakaz clickhouse-client --user=admin --password='ВАШ_ПАРОЛЬ' -q "SELECT 1"
  # Ожидаемый результат: 1
  ```

---

## ЭТАП 5: СХЕМА БАЗЫ ДАННЫХ

### 5.1 Применение схемы

- [ ] **Файл bootstrap_schema.sql** существует
  ```bash
  # Проверка команды:
  ls -la /opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse/bootstrap_schema.sql
  # Ожидаемый результат: файл существует
  ```

- [ ] **Файл bootstrap_roles_grants.sql** существует
  ```bash
  # Проверка команды:
  ls -la /opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse/bootstrap_roles_grants.sql
  # Ожидаемый результат: файл существует
  ```

- [ ] **Схема** применена успешно
  ```bash
  # Проверка команды:
  docker exec ch-zakaz clickhouse-client --user=admin --password='ВАШ_ПАРОЛЬ' -q "SHOW TABLES FROM zakaz"
  # Ожидаемый результат: список таблиц
  ```

### 5.2 Пользователи и права

- [ ] **Пользователь datalens_reader** существует
  ```bash
  # Проверка команды:
  docker exec ch-zakaz clickhouse-client --user=admin --password='ВАШ_ПАРОЛЬ' -q "SHOW USERS LIKE 'datalens_reader'"
  # Ожидаемый результат: пользователь существует
  ```

- [ ] **Гранты для datalens_reader** применены
  ```bash
  # Проверка команды:
  docker exec ch-zakaz clickhouse-client --user=admin --password='ВАШ_ПАРОЛЬ' -q "SHOW GRANTS FOR datalens_reader"
  # Ожидаемый результат: список грантов
  ```

---

## ЭТАП 6: СЕКРЕТЫ И ТОКЕНЫ

### 6.1 Директория секретов

- [ ] **Директория secrets** создана
  ```bash
  # Проверка команды:
  ls -la /opt/zakaz_dashboard/secrets/
  # Ожидаемый результат: директория существует
  ```

- [ ] **Права доступа** к директории секретов установлены
  ```bash
  # Проверка команды:
  stat -c "%a" /opt/zakaz_dashboard/secrets/
  # Ожидаемый результат: 700
  ```

### 6.2 Файлы секретов

- [ ] **Файл .env.qtickets_api** создан
  ```bash
  # Проверка команды:
  ls -la /opt/zakaz_dashboard/secrets/.env.qtickets_api
  # Ожидаемый результат: файл существует
  ```

- [ ] **Токен QTickets** настроен
  ```bash
  # Проверка команды:
  grep QTICKETS_TOKEN /opt/zakaz_dashboard/secrets/.env.qtickets_api
  # Ожидаемый результат: токен отличен от пустого значения
  ```

- [ ] **Права доступа** к файлам секретов установлены
  ```bash
  # Проверка команды:
  stat -c "%a" /opt/zakaz_dashboard/secrets/.env.qtickets_api
  # Ожидаемый результат: 600
  ```

---

## ЭТАП 7: DOCKER ОБРАЗЫ И СЕРВИСЫ

### 7.1 Сборка образов

- [ ] **Dockerfile QTickets API** существует
  ```bash
  # Проверка команды:
  ls -la /opt/zakaz_dashboard/dashboard-mvp/integrations/qtickets_api/Dockerfile
  # Ожидаемый результат: файл существует
  ```

- [ ] **Образ qtickets_api** собран
  ```bash
  # Проверка команды:
  docker images | grep qtickets_api
  # Ожидаемый результат: образ в списке
  ```

### 7.2 Systemd сервисы

- [ ] **Файлы юнитов** скопированы в /etc/systemd/system/
  ```bash
  # Проверка команды:
  ls -la /etc/systemd/system/ | grep qtickets
  # Ожидаемый результат: файлы юнитов существуют
  ```

- [ ] **Systemd** перезагружен
  ```bash
  # Проверка команды:
  systemctl daemon-reload
  # Ожидаемый результат: нет ошибок
  ```

---

## ЭТАП 8: HTTPS И ДОСТУПНОСТЬ

### 8.1 Установка Caddy

- [ ] **Caddy** установлен
  ```bash
  # Проверка команды:
  caddy version
  # Ожидаемый результат: версия Caddy
  ```

- [ ] **Caddy сервис** запущен
  ```bash
  # Проверка команды:
  systemctl status caddy
  # Ожидаемый результат: active (running)
  ```

### 8.2 Конфигурация HTTPS

- [ ] **Caddyfile** настроен
  ```bash
  # Проверка команды:
  ls -la /etc/caddy/Caddyfile
  # Ожидаемый результат: файл существует
  ```

- [ ] **Домен** настроен в Caddyfile
  ```bash
  # Проверка команды:
  grep bi.zakaz-dashboard.ru /etc/caddy/Caddyfile
  # Ожидаемый результат: домен в файле
  ```

- [ ] **HTTPS доступ** работает
  ```bash
  # Проверка команды:
  curl -k https://bi.zakaz-dashboard.ru/?query=SELECT%201
  # Ожидаемый результат: 1
  ```

---

## ЭТАП 9: ФИНАЛЬНАЯ ПРОВЕРКА

### 9.1 Комплексная проверка

- [ ] **Все контейнеры** запущены и здоровы
  ```bash
  # Проверка команды:
  docker ps
  # Ожидаемый результат: все контейнеры в статусе Up
  ```

- [ ] **Все таймеры** активны
  ```bash
  # Проверка команды:
  systemctl list-timers | grep -E 'qtickets|vk_ads|direct'
  # Ожидаемый результат: таймеры активны
  ```

- [ ] **Данные загружаются** в ClickHouse
  ```bash
  # Проверка команды:
  docker exec ch-zakaz clickhouse-client --user=datalens_reader --password='ChangeMe123!' -q "SELECT count() FROM zakaz.stg_qtickets_api_orders_raw"
  # Ожидаемый результат: количество строк > 0
  ```

### 9.2 Безопасность

- [ ] **Пароли по умолчанию** изменены
  ```bash
  # Проверка команды:
  grep -r "admin_pass\|ChangeMe123\|EtL2024" /opt/zakaz_dashboard/secrets/
  # Ожидаемый результат: нет совпадений
  ```

- [ ] **Файрвол** настроен
  ```bash
  # Проверка команды:
  ufw status
  # Ожидаемый результат: Status: active
  ```

---

## РЕЗУЛЬТАТЫ ПРОВЕРКИ

### Итоговая оценка

- [ ] **Все критические пункты** выполнены
- [ ] **Все предупреждения** устранены
- [ ] **Система готова** к развертыванию

### Подпись ответственного

- **Имя**: `_________________`
- **Должность**: `_________________`
- **Дата**: `_________________`
- **Подпись**: `_________________`

---

## ДЕЙСТВИЯ ПРИ НЕУДАЧНЫХ ПРОВЕРКАХ

### Критические проблемы

1. **ClickHouse не запускается**:
   - Выполнить скрипт: `bash scripts/fix_clickhouse_container.sh`
   - Проверить логи: `docker logs ch-zakaz`

2. **Проблемы с правами доступа**:
   - Выполнить скрипт: `bash scripts/fix_all_deployment_issues.sh`
   - Проверить пользователя: `id etl`

3. **Проблемы с Git**:
   - Выполнить скрипт: `bash scripts/fix_git_permissions.sh`
   - Проверить статус: `git status`

### Предупреждения

1. **Пароли по умолчанию**:
   - Изменить все пароли в файлах секретов
   - Перезапустить сервисы

2. **Отсутствуют обновления**:
   - Выполнить: `apt update && apt upgrade -y`
   - Перезагрузить систему

---

## КОНТАКТЫ ПОДДЕРЖКИ

- **Техническая поддержка**: [контакт разработчика]
- **Экстренные случаи**: [экстренный контакт]
- **Документация**: [ссылка на документацию]

---

**Версия чек-листа**: 1.0.0  
**Дата создания**: 2025-10-30  
**Последнее обновление**: 2025-10-30