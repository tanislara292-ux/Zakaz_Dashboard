2025-10-29T11:38:16Z urllib3.connectionpool WARNING Retrying (Retry(total=0, connect=None, read=None, redirect=0, status=None)) after connection broken by 'NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e746d1d0>: Failed to establish a new connection: [Errno 111] Connection refused')': /?
2025-10-29T11:38:16Z clickhouse_connect.driver.httpclient WARNING Unexpected Http Driver Exception
2025-10-29T11:38:16Z integrations.common.ch WARNING ClickHouse connection attempt 1/3 failed: Error HTTPConnectionPool(host='ch-zakaz', port=8123): Max retries exceeded with url: /? (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e746ded0>: Failed to establish a new connection: [Errno 111] Connection refused')) executing HTTP request attempt 1 (http://ch-zakaz:8123)
2025-10-29T11:38:17Z urllib3.connectionpool WARNING Retrying (Retry(total=0, connect=None, read=None, redirect=0, status=None)) after connection broken by 'NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e746f810>: Failed to establish a new connection: [Errno 111] Connection refused')': /?
2025-10-29T11:38:17Z clickhouse_connect.driver.httpclient WARNING Unexpected Http Driver Exception
2025-10-29T11:38:17Z integrations.common.ch WARNING ClickHouse connection attempt 2/3 failed: Error HTTPConnectionPool(host='ch-zakaz', port=8123): Max retries exceeded with url: /? (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e72b8250>: Failed to establish a new connection: [Errno 111] Connection refused')) executing HTTP request attempt 1 (http://ch-zakaz:8123)
2025-10-29T11:38:19Z urllib3.connectionpool WARNING Retrying (Retry(total=0, connect=None, read=None, redirect=0, status=None)) after connection broken by 'NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e72bbed0>: Failed to establish a new connection: [Errno 111] Connection refused')': /?
2025-10-29T11:38:19Z clickhouse_connect.driver.httpclient WARNING Unexpected Http Driver Exception
2025-10-29T11:38:19Z integrations.common.ch WARNING ClickHouse connection attempt 3/3 failed: Error HTTPConnectionPool(host='ch-zakaz', port=8123): Max retries exceeded with url: /? (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e746e1d0>: Failed to establish a new connection: [Errno 111] Connection refused')) executing HTTP request attempt 1 (http://ch-zakaz:8123)
[qtickets_api] Unexpected failure during ingestion | metrics={"error": "Error HTTPConnectionPool(host='ch-zakaz', port=8123): Max retries exceeded with url: /? (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e746e1d0>: Failed to establish a new connection: [Errno 111] Connection refused')) executing HTTP request attempt 1 (http://ch-zakaz:8123)"}
Traceback (most recent call last):
  File "/usr/local/lib/python3.11/site-packages/urllib3/connection.py", line 198, in _new_conn
    sock = connection.create_connection(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/urllib3/util/connection.py", line 85, in create_connection
    raise err
  File "/usr/local/lib/python3.11/site-packages/urllib3/util/connection.py", line 73, in create_connection
    sock.connect(sa)
ConnectionRefusedError: [Errno 111] Connection refused

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/usr/local/lib/python3.11/site-packages/urllib3/connectionpool.py", line 787, in urlopen
    response = self._make_request(
               ^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/urllib3/connectionpool.py", line 493, in _make_request
    conn.request(
  File "/usr/local/lib/python3.11/site-packages/urllib3/connection.py", line 494, in request
    self.endheaders()
  File "/usr/local/lib/python3.11/http/client.py", line 1298, in endheaders
    self._send_output(message_body, encode_chunked=encode_chunked)
  File "/usr/local/lib/python3.11/http/client.py", line 1058, in _send_output
    self.send(msg)
  File "/usr/local/lib/python3.11/http/client.py", line 996, in send
    self.connect()
  File "/usr/local/lib/python3.11/site-packages/urllib3/connection.py", line 325, in connect
    self.sock = self._new_conn()
                ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/urllib3/connection.py", line 213, in _new_conn
    raise NewConnectionError(
urllib3.exceptions.NewConnectionError: <urllib3.connection.HTTPConnection object at 0x7451e746e1d0>: Failed to establish a new connection: [Errno 111] Connection refused

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/usr/local/lib/python3.11/site-packages/clickhouse_connect/driver/httpclient.py", line 522, in _raw_request
    response = self.http.request(method, url, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/urllib3/_request_methods.py", line 143, in request
    return self.request_encode_body(
           ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/urllib3/_request_methods.py", line 278, in request_encode_body
    return self.urlopen(method, url, **extra_kw)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/urllib3/poolmanager.py", line 459, in urlopen
    response = conn.urlopen(method, u.request_uri, **kw)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/urllib3/connectionpool.py", line 871, in urlopen
    return self.urlopen(
           ^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/urllib3/connectionpool.py", line 841, in urlopen
    retries = retries.increment(
              ^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/urllib3/util/retry.py", line 519, in increment
    raise MaxRetryError(_pool, url, reason) from reason  # type: ignore[arg-type]
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
urllib3.exceptions.MaxRetryError: HTTPConnectionPool(host='ch-zakaz', port=8123): Max retries exceeded with url: /? (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e746e1d0>: Failed to establish a new connection: [Errno 111] Connection refused'))

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/app/integrations/qtickets_api/loader.py", line 110, in main
    ch_client = None if dry_run else get_client_from_config(config)
                                     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/integrations/common/ch.py", line 198, in get_client_from_config
    return ClickHouseClient(
           ^^^^^^^^^^^^^^^^^
  File "/app/integrations/common/ch.py", line 89, in __init__
    self._connect()
  File "/app/integrations/common/ch.py", line 127, in _connect
    raise last_error
  File "/app/integrations/common/ch.py", line 99, in _connect
    self.client = clickhouse_connect.get_client(
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/clickhouse_connect/driver/__init__.py", line 125, in create_client
    return HttpClient(interface, host, port, username, password, database, access_token,
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/clickhouse_connect/driver/httpclient.py", line 174, in __init__
    super().__init__(database=database,
  File "/usr/local/lib/python3.11/site-packages/clickhouse_connect/driver/client.py", line 71, in __init__
    self._init_common_settings(apply_server_timezone)
  File "/usr/local/lib/python3.11/site-packages/clickhouse_connect/driver/client.py", line 76, in _init_common_settings
    tuple(self.command('SELECT version(), timezone()', use_database=False))
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/clickhouse_connect/driver/httpclient.py", line 412, in command
    response = self._raw_request(payload, params, headers, method, fields=fields, server_wait=False)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/clickhouse_connect/driver/httpclient.py", line 534, in _raw_request
    raise OperationalError(f'Error {ex} executing HTTP request attempt {attempts}{err_url}') from ex
clickhouse_connect.driver.exceptions.OperationalError: Error HTTPConnectionPool(host='ch-zakaz', port=8123): Max retries exceeded with url: /? (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e746e1d0>: Failed to establish a new connection: [Errno 111] Connection refused')) executing HTTP request attempt 1 (http://ch-zakaz:8123)
2025-10-29T11:38:19Z urllib3.connectionpool WARNING Retrying (Retry(total=0, connect=None, read=None, redirect=0, status=None)) after connection broken by 'NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e72df950>: Failed to establish a new connection: [Errno 111] Connection refused')': /?
2025-10-29T11:38:19Z clickhouse_connect.driver.httpclient WARNING Unexpected Http Driver Exception
2025-10-29T11:38:19Z integrations.common.ch WARNING ClickHouse connection attempt 1/3 failed: Error HTTPConnectionPool(host='ch-zakaz', port=8123): Max retries exceeded with url: /? (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e7310210>: Failed to establish a new connection: [Errno 111] Connection refused')) executing HTTP request attempt 1 (http://ch-zakaz:8123)
2025-10-29T11:38:20Z urllib3.connectionpool WARNING Retrying (Retry(total=0, connect=None, read=None, redirect=0, status=None)) after connection broken by 'NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e7311110>: Failed to establish a new connection: [Errno 111] Connection refused')': /?
2025-10-29T11:38:20Z clickhouse_connect.driver.httpclient WARNING Unexpected Http Driver Exception
2025-10-29T11:38:20Z integrations.common.ch WARNING ClickHouse connection attempt 2/3 failed: Error HTTPConnectionPool(host='ch-zakaz', port=8123): Max retries exceeded with url: /? (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e7311a10>: Failed to establish a new connection: [Errno 111] Connection refused')) executing HTTP request attempt 1 (http://ch-zakaz:8123)
2025-10-29T11:38:22Z urllib3.connectionpool WARNING Retrying (Retry(total=0, connect=None, read=None, redirect=0, status=None)) after connection broken by 'NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e7312850>: Failed to establish a new connection: [Errno 111] Connection refused')': /?
Unable to record failure in meta_job_runs | metrics={"job": "qtickets_api", "error": "Error HTTPConnectionPool(host='ch-zakaz', port=8123): Max retries exceeded with url: /? (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e746e1d0>: Failed to establish a new connection: [Errno 111] Connection refused')) executing HTTP request attempt 1 (http://ch-zakaz:8123)", "secondary_error": "Error HTTPConnectionPool(host='ch-zakaz', port=8123): Max retries exceeded with url: /? (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e7313210>: Failed to establish a new connection: [Errno 111] Connection refused')) executing HTTP request attempt 1 (http://ch-zakaz:8123)"}
2025-10-29T11:38:22Z clickhouse_connect.driver.httpclient WARNING Unexpected Http Driver Exception
2025-10-29T11:38:22Z integrations.common.ch WARNING ClickHouse connection attempt 3/3 failed: Error HTTPConnectionPool(host='ch-zakaz', port=8123): Max retries exceeded with url: /? (Caused by NewConnectionError('<urllib3.connection.HTTPConnection object at 0x7451e7313210>: Failed to establish a new connection: [Errno 111] Connection refused')) executing HTTP request attempt 1 (http://ch-zakaz:8123)
