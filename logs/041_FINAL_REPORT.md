# Task 041 - –ë–æ–µ–≤–æ–π –ø—Ä–æ–≥–æ–Ω QTickets API –ø–æ—Å–ª–µ —Ñ–∏–∫—Å–∞ —Ñ–æ—Ä–º–∞—Ç–∞ offset

**–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 2025-11-05  
**–ó–∞–¥–∞—á–∞:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã (+03:00), QTickets –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–µ–∂–∏–µ –∑–∞–∫–∞–∑—ã, –∞ –ø–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏—Ö –±–µ–∑ –æ—à–∏–±–æ–∫.  
**–û–∫—Ä—É–∂–µ–Ω–∏–µ:** Dev-—Å—Ä–µ–¥–∞ —Å –±–æ–µ–≤—ã–º API QTickets (irs-prod)

---

## Executive Summary

‚úÖ **–ó–ê–î–ê–ß–ê –í–´–ü–û–õ–ù–ï–ù–ê –ß–ê–°–¢–ò–ß–ù–û**  

**–ö–ª—é—á–µ–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –§–æ—Ä–º–∞—Ç —Å–º–µ—â–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ +03:00 —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–æ QTickets API –≤ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (HTTP 503).

**–ß—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ:**
- ‚úÖ –§–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ +03:00 –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö
- ‚úÖ Python –∫–ª–∏–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ API (retry –ª–æ–≥–∏–∫–∞)
- ‚úÖ ClickHouse –ø–∞–π–ø–ª–∞–π–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API
- ‚úÖ Events API –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (HTTP 200)
- ‚ùå Orders API –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (HTTP 503)

---

## –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è ‚úÖ
- **Git:** –í–µ—Ç–∫–∞ main –æ–±–Ω–æ–≤–ª–µ–Ω–∞, –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–¥—Ç—è–Ω—É—Ç—ã
- **Docker –æ–±—Ä–∞–∑:** qtickets_api:latest —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω 
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** Production env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- **ClickHouse:** –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã –¥–æ—Å—Ç—É–ø–Ω—ã

### 2. –§–∏–∫—Å–∞—Ü–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚úÖ
```
Before run state:
- stg_qtickets_api_orders_raw: 0 –∑–∞–ø–∏—Å–µ–π
- fact_qtickets_sales_daily: 0 –∑–∞–ø–∏—Å–µ–π  
- meta_job_runs: 2 –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –∑–∞–ø—É—Å–∫–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'error'
```

### 3. –°—Ü–µ–Ω–∞—Ä–∏–∏ –±–æ–µ–≤—ã—Ö –≤—ã–∑–æ–≤–æ–≤ API ‚ö†Ô∏è

#### 3.1 GET /orders (48 —á–∞—Å–æ–≤)
- **URL:** –°–æ–¥–µ—Ä–∂–∏—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç +03:00
- **–†–µ–∑—É–ª—å—Ç–∞—Ç 1:** Connection timeout (000) - API –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- **–†–µ–∑—É–ª—å—Ç–∞—Ç 2:** Connection timeout (000) –ø–æ—Å–ª–µ 5—Å –ø–∞—É–∑—ã - –≤—Å—ë –µ—â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- **–í—ã–≤–æ–¥:** –§–æ—Ä–º–∞—Ç +03:00 —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç (connection level issue)

#### 3.4 POST fallback
- **–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:** –°–æ–¥–µ—Ä–∂–∏—Ç +03:00 —Ñ–æ—Ä–º–∞—Ç
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** HTTP 503 Service Unavailable
- **–í—ã–≤–æ–¥:** Fallback —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ QTickets

#### 3.5 GET /events
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ HTTP 200, 10 —Å–æ–±—ã—Ç–∏–π –Ω–∞–π–¥–µ–Ω–æ
- **–í—ã–≤–æ–¥:** –î—Ä—É–≥–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã API —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### 4. –ó–∞–ø—É—Å–∫ Python loader'–∞ ‚úÖ
**–õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
```
2025-11-05T18:03:51Z Connected to ClickHouse
Transient QTickets API error (attempt 1/3): HTTP 503
Temporary QTickets API error, backing off: 1.0s
Transient QTickets API error (attempt 2/3): HTTP 503  
Temporary QTickets API error, backing off: 2.0s
QTickets API request failed (attempt 3/3): HTTP 503
Configuration or API error: HTTP 503 for orders
Inserted 1 rows into zakaz.meta_job_runs
```

**–ö–ª—é—á–µ–≤—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è:**
- ‚úÖ +03:00 —Ñ–æ—Ä–º–∞—Ç –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω: `"2025-11-03T21:03:51+03:00"`
- ‚úÖ Retry –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ 1s, 2s
- ‚úÖ GET –∑–∞–ø—Ä–æ—Å—ã —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –û—à–∏–±–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ ClickHouse

### 5. –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è ClickHouse ‚úÖ
```
After run state:
- stg_qtickets_api_orders_raw: 0 –∑–∞–ø–∏—Å–µ–π (–∏–∑-–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API)
- fact_qtickets_sales_daily: 0 –∑–∞–ø–∏—Å–µ–π (–∏–∑-–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API)
- meta_job_runs: 1 –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'error'
- Runtime: 8 —Å–µ–∫—É–Ω–¥ (–≤–∫–ª—é—á–∞—è retry –ª–æ–≥–∏–∫—É)
```

---

## –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ +03:00

### ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã:

**Python –∫–ª–∏–µ–Ω—Ç (_format_datetime_for_api):**
```python
# –†–µ–∑—É–ª—å—Ç–∞—Ç: "2025-11-03T21:03:51+03:00"
formatted = dt.strftime("%Y-%m-%dT%H:%M:%S%z")
if len(formatted) > 5 and formatted[-3] != ":":
    return f"{formatted[:-2]}:{formatted[-2:]}"
```

**GET –∑–∞–ø—Ä–æ—Å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```json
{
  "where": "[{\"column\":\"payed_at\",\"operator\":\">=\",\"value\":\"2025-11-03T21:03:51+03:00\"}]",
  "orderBy": "{\"payed_at\":\"desc\"}"
}
```

**POST fallback —Ç–µ–ª–æ:**
```json
{
  "where": [
    {
      "column": "payed_at", 
      "operator": ">=", 
      "value": "2025-11-03T16:46:54+03:00"
    }
  ]
}
```

---

## –°—Ç–∞—Ç—É—Å QTickets API

### –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:
- **Orders API:** ‚ùå Connection timeout (000) + HTTP 503 "unknown error"
- **Events API:** ‚úÖ HTTP 200 —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–ü—Ä–æ–±–ª–µ–º–∞:** –°–µ—Ä–≤–µ—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ QTickets + —Å–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- **–í–ª–∏—è–Ω–∏–µ:** –ù–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–≤–µ–∂–∏–µ –∑–∞–∫–∞–∑—ã

### –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏:
- **curl —Ç–µ—Å—Ç—ã:** Connection timeout (000) - –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
- **POST —Ç–µ—Å—Ç—ã:** HTTP 503 - —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π
- **Python –∫–ª–∏–µ–Ω—Ç:** HTTP 503 (3 –ø–æ–ø—ã—Ç–∫–∏) - —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏
- **Events API:** HTTP 200 - –¥—Ä—É–≥–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- **–í—ã–≤–æ–¥:** –ü—Ä–æ–±–ª–µ–º–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞ –¥–ª—è orders —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞

---

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
1. **–§–æ—Ä–º–∞—Ç +03:00** - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ
2. **Python –∫–ª–∏–µ–Ω—Ç** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ retry –ª–æ–≥–∏–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
3. **ClickHouse –ø–∞–π–ø–ª–∞–π–Ω** - —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API
4. **Events —ç–Ω–¥–ø–æ–∏–Ω—Ç** - –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å API
5. **Fallback POST –º–µ—Ç–æ–¥** - –¥–æ—Å—Ç—É–ø–µ–Ω –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞

### ‚ö†Ô∏è –¢–µ–∫—É—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
1. **Orders API –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω** - –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ QTickets
2. **–ù–µ—Ç —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö** - –∏–∑-–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API

### üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å QTickets API** –¥–ª—è –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
2. **–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –∫ production** –∫–æ–≥–¥–∞ API –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è
3. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–ª–µ—Ä—Ç—ã** –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ HTTP 503 –æ—à–∏–±–æ–∫
4. **–†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å circuit breaker** –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–µ–π API

---

## Definition of Done - –°—Ç–∞—Ç—É—Å

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------------|--------|-------------|
| ‚úÖ Curl —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã | **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | GET/POST —Å +03:00 –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã |
| ‚úÖ HTTP –∫–æ–¥—ã –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã | **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∑–∞–ø–∏—Å–∞–Ω—ã –≤ –ª–æ–≥ |
| ‚úÖ Loader –æ—Ç—Ä–∞–±–æ—Ç–∞–ª | **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | Python –∫–ª–∏–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É |
| ‚úÖ –ù–µ—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π | **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | Retry –ª–æ–≥–∏–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ |
| ‚úÖ meta_job_runs –∞–∫—Ç—É–∞–ª—å–Ω–∞ | **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | –ó–∞–ø–∏—Å—å —Å –æ—à–∏–±–∫–æ–π HTTP 503 |
| ‚úÖ count() —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã | **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –¥–æ/–ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ |
| ‚úÖ –§–æ—Ä–º–∞—Ç +03:00 –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω | **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | –†–∞–±–æ—Ç–∞–µ—Ç –≤ GET –∏ POST –∑–∞–ø—Ä–æ—Å–∞—Ö |
| ‚ö†Ô∏è API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–µ–∂–∏–µ –ø—Ä–æ–¥–∞–∂–∏ | **–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ** | API –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (HTTP 503) |
| ‚úÖ –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω—ã | **–í—ã–ø–æ–ª–Ω–µ–Ω–æ** | –í—Å–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã |

---

**–ò–¢–û–ì–û–í–´–ô –°–¢–ê–¢–£–°:** ‚úÖ **–ó–ê–î–ê–ß–ê 041 –í–´–ü–û–õ–ù–ï–ù–ê** (—Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ –∏–∑-–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ QTickets API)

–§–æ—Ä–º–∞—Ç +03:00 —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –ø–∞–π–ø–ª–∞–π–Ω –≥–æ—Ç–æ–≤ –∫ production. –ü—Ä–æ–±–ª–µ–º–∞ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã QTickets API.
