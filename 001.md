# Zakaz_Dashboard Production Readiness Task

## Goal
Deliver a repeatable, production-ready deployment for the Zakaz_Dashboard stack:
ClickHouse schema, Qtickets API integration, and VK Ads service. The result must
bootstrap cleanly on a fresh host and pass end-to-end smoke tests.

---

## Scope Overview

| Area | Objectives |
| --- | --- |
| ClickHouse infrastructure | Ensure all DDLs are idempotent, deterministic, and bootstrap successfully twice in a row on an empty DB. |
| Qtickets integration | Docker build, dry-run smoke test, configuration templates, documentation. |
| VK Ads service | Schema alignment, tests, documentation. |
| CI/CD pipeline | Static validation, unit tests, docker build, optional smoke stage. |
| Documentation | Clear instructions, checklists, audit report. |

---

## Workstreams & Task Breakdown

### 1. ClickHouse Schema & Bootstrap

1.1 **Audit and fix DDL files**
- Files to review: `bootstrap_schema.sql`, `bootstrap_all.sql`, `init.sql`, `init_qtickets_sheets.sql`, and any other schema scripts.
- Guarantee the order: `CREATE TABLE IF NOT EXISTS …` before any `ALTER TABLE …`.
- Replace invalid syntax `ALTER TABLE IF EXISTS …` with a valid sequence:
  - either rely on `CREATE TABLE IF NOT EXISTS …` (and skip the `ALTER`), or
  - issue `ALTER TABLE … ADD COLUMN IF NOT EXISTS …` after verifying the table exists (e.g., via preceding `CREATE`) and without `IF EXISTS`.
- Confirm every required column (`_loaded_at`, `currency`, `_ver`, etc.) is present within the `CREATE` statement itself unless there is a strong reason to add it via `ALTER`.

1.2 **Remove non-deterministic partitioning**
- Ensure all `PARTITION BY` clauses use deterministic expressions (e.g., `_loaded_at`, `event_date`).

1.3 **Double bootstrap test**
- Run `dashboard-mvp/scripts/bootstrap_clickhouse.sh` twice in a row on:
  1. fresh ClickHouse container (empty data directory)
  2. same container without resetting data to confirm idempotency
- Fix any failures encountered.

1.4 **Smoke test integration**
- After bootstrap, run `dashboard-mvp/scripts/smoke_qtickets_dryrun.sh --env-file dashboard-mvp/test_env/.env.template`.
- Confirm exit code `0` and no Tracebacks.

1.5 **Static validation**
- Ensure `scripts/validate_clickhouse_schema.py` reports “Schema validation passed.”
- Extend the script if necessary (e.g., more encoding fallbacks, additional checks).

**Definition of Done (ClickHouse)**
- All DDL scripts are UTF-8, deterministic, and idempotent.
- `bootstrap_clickhouse.sh` succeeds twice consecutively on a clean ClickHouse instance.
- `validate_clickhouse_schema.py` passes without warnings.
- Smoke test completes with exit code 0.
- README (`infra/clickhouse/README.md`) contains exact bootstrap and validation instructions.

---

### 2. Qtickets Integration

2.1 **Docker build & lint**
- `docker build -f integrations/qtickets_api/Dockerfile …` must succeed without warnings.
- Optionally run `docker build --dry-run` or a linter (e.g. `hadolint`) if available.

2.2 **Smoke dry-run**
- Use `dashboard-mvp/scripts/smoke_qtickets_dryrun.sh` with sample env file.
- Ensure the script exits 0 and logs stub mode (no real API calls).

2.3 **Configuration**
- Verify `dashboard-mvp/test_env/.env.template` contains all required variables for dry-run.
- Document env variables in `integrations/qtickets_api` README.

2.4 **Documentation**
- Update `integrations/qtickets_api/README.md` with instructions for:
  - building the image
  - running in dry-run vs production mode
  - environment variable descriptions

**Definition of Done (Qtickets)**
- Docker image builds successfully via CI job.
- Smoke script passes with template env.
- README updated with clear build/run instructions.
- Template env file maintained.

---

### 3. VK Ads Service

3.1 **Schema alignment**
- Validate ClickHouse tables (`dm_vk_ads_daily`, `stg_vk_ads_daily`, etc.) contain `_loaded_at` and match the view definitions (`bi.v_vk_ads_daily`, `bi.v_marketing_roi_daily`).
- The validator should not report missing columns or invalid references.

3.2 **Unit tests**
- `cd dashboard-mvp/vk-python && python -m pytest` must pass.
- If tests require mocks or env variables, provide templates/documentation.

3.3 **Documentation**
- Ensure README (`dashboard-mvp/vk-python/README.md` if exists) explains how to run tests and configure env variables.

**Definition of Done (VK Ads)**
- VDL/DDL validated, consistent with ClickHouse schema.
- Unit tests pass in CI.
- Documentation explains how to run the service/tests.

---

### 4. CI/CD Pipeline Enhancements

4.1 **Mandatory CI stages**
- Validate schema: `python scripts/validate_clickhouse_schema.py`
- Python bytecode: `python -m compileall dashboard-mvp`
- Unit tests: `cd dashboard-mvp/vk-python && python -m pytest`
- Docker build: `docker build --no-cache -f dashboard-mvp/integrations/qtickets_api/Dockerfile …`

4.2 **Optional (recommended)**
- Spin up ClickHouse in CI (24.8) and execute smoke test (`bootstrap_clickhouse.sh` + `smoke_qtickets_dryrun.sh`).
- Once stable, mark stage as required.

4.3 **Security & dependencies (best effort)**
- `pip-audit` for Python dependencies.
- Container scan (Trivy/Clair) on Docker image.

4.4 **Developer checklist**
- Document local steps before pushing:
  - run validator, compileall, pytest
  - docker build (dry-run)
  - smoke test if ClickHouse available

**Definition of Done (CI/CD)**
- `.gitlab-ci.yml`/GitHub Actions updated with mandatory stages.
- Pipeline produces artifacts (pytest results, coverage, logs).
- Smoke stage either runs or clearly documented as optional.
- Developer checklist maintained in repo (README/CONTRIBUTING).

---

### 5. Documentation & Reporting

5.1 **README updates**
- `infra/clickhouse/README.md` contains up-to-date bootstrap & validation steps.
- Integration READMEs (Qtickets/VK) describe build/test instructions and env requirements.

5.2 **Audit report**
- Maintain `ZAKAZ_DASHBOARD_AUDIT_REPORT.md` detailing executed checks, statuses, and known limitations.

5.3 **CI Recommendations**
- Keep `CI_RECOMMENDATIONS.md` aligned with actual pipeline and tooling.

**Definition of Done (Docs)**
- README & docs updated with accurate instructions.
- Audit report reflects most recent test run.
- CI recommendations align with implemented pipeline.

---

## Execution Plan

### Phase 1 – Schema Fixes & Validator
1. Review DDL files, fix `CREATE/ALTER` ordering, remove invalid syntax.
2. Confirm deterministic partitions.
3. Run `bootstrap_clickhouse.sh` twice on clean ClickHouse; fix issues.
4. Execute smoke dry-run (`smoke_qtickets_dryrun.sh`).
5. Run validator script; ensure “Schema validation passed.”

### Phase 2 – Integration Tests
1. Docker build for Qtickets.
2. Pytest for `vk-python`.
3. Document env templates & usage.

### Phase 3 – CI Integration
1. Update pipeline configuration with mandatory stages.
2. Configure optional smoke stage (with ClickHouse service).
3. Document developer checklist.

### Phase 4 – Documentation & Final Audit
1. Update README sections.
2. Refresh audit report.
3. Final end-to-end dry run; gather logs.

---

## Deliverables
- Updated DDL scripts (UTF-8, deterministic, idempotent).
- Working validator script and template env file.
- CI pipeline configuration (yaml/scripts).
- Smoke test logs showing success.
- Updated documentation (`README.md`, `CI_RECOMMENDATIONS.md`, `ZAKAZ_DASHBOARD_AUDIT_REPORT.md`).

---

## Acceptance Criteria (Definition of Done)

| Area | Criteria |
| --- | --- |
| ClickHouse | Scripts bootstrap twice on clean instance; validator passes; smoke test exits 0. |
| Qtickets | Docker build succeeds; smoke script (dry-run) passes; README + env template updated. |
| VK Ads | DDL matches schema; pytest passes; documentation updated. |
| CI/CD | Mandatory jobs run in pipeline; optional smoke stage documented/executed; developer checklist exists. |
| Documentation | All READMEs and audit report current; instructions reproducible. |

Upon completing the above, the Zakaz_Dashboard project should have a robust, reproducible production deployment and automated checks that prevent regressions.
