Задание для кодера: Полное тестирование «с нуля» на свежем окружении

Общая цель
Убедиться, что репозиторий в свежем состоянии поднимает ClickHouse, выполняет DRY и боевой прогон загрузчика, а также готовит DataLens-подключение — всё исключительно на «чистом» окружении без остаточных контейнеров и данных.

Предварительные условия
Иметь доступ к серверу/VM с Docker и docker compose.
Иметь боевые переменные QTickets (токен, org_name).
Никакие контейнеры ch-zakaz или сетки clickhouse_default не должны оставаться запущенными перед стартом.
Шаги
Очистка окружения

Проверить и остановить все контейнеры ClickHouse/qtickets:
docker ps -a
docker stop ch-zakaz || true
docker rm ch-zakaz || true
docker ps -a  # убедиться, что контейнер удалён
Удалить сеть, если осталась:
docker network rm clickhouse_default || true
Очистить данные и логи (если папки есть):
cd /opt/zakaz_dashboard
rm -rf Zakaz_Dashboard
Убедиться, что директория для клонов пустая:
ls /opt/zakaz_dashboard
Свежий git clone

Клонировать репозиторий:
cd /opt/zakaz_dashboard
git clone <REPO_URL> Zakaz_Dashboard
cd Zakaz_Dashboard
git status
Зафиксировать ветку/коммит (git rev-parse HEAD).
Бутстрап ClickHouse

Перейти в инфраструктуру и подготовить .env:
cd dashboard-mvp/infra/clickhouse
cp .env.example .env
Запустить автоматический скрипт:
../../scripts/bootstrap_clickhouse.sh
Сохранить полный лог выполнения.
Проверить, что контейнер здоров:
docker inspect -f '{{.State.Health.Status}}' ch-zakaz
Убедиться, что все таблицы присутствуют (ожидаем 31):
docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "SHOW TABLES FROM zakaz;"
Применить bootstrap_grants.sql:
docker exec -i ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  < bootstrap_grants.sql
Проверить отсутствие ACCESS_DENIED.
Smoke-тест DRY_RUN

Подготовить окружение загрузчика:
cd ../..
mkdir -p secrets
cp configs/.env.qtickets_api.sample secrets/.env.qtickets_api
Убедиться, что в файле DRY_RUN=true, CLICKHOUSE_* указаны корректно (host ch-zakaz, port 8123, admin/admin_pass).
Запустить скрипт:
scripts/smoke_qtickets_dryrun.sh --env-file secrets/.env.qtickets_api
Ожидаемый результат: exit code 0, в логах — stub-сообщения, meta_job_runs не меняется.
Боевой прогон (DRY_RUN=false)

Отредактировать secrets/.env.qtickets_api: DRY_RUN=false, заполнить реальные QTICKETS_TOKEN, ORG_NAME.
Собрать и запустить загрузчик:
docker build -f integrations/qtickets_api/Dockerfile -t qtickets_api:prod .
docker run --rm \
  --network clickhouse_default \
  --env-file secrets/.env.qtickets_api \
  --name qtickets_api_run_$(date +%Y%m%d%H%M%S) \
  qtickets_api:prod
Зафиксировать полный вывод контейнера.
Проверить, что данные записались:
docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "SELECT count() FROM zakaz.stg_qtickets_api_orders_raw"
docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "SELECT job, status, started_at, finished_at, rows_processed, message \
      FROM zakaz.meta_job_runs \
      WHERE job='qtickets_api' ORDER BY started_at DESC LIMIT 1"
Повторить запуск ещё раз (через несколько минут) для проверки идемпотентности и отсутствия дублей.
DataLens проверка

Выполнить локальные тесты:
curl -u datalens_reader:ChangeMe123! http://localhost:8123/?query=SELECT%201
curl -u datalens_reader:ChangeMe123! http://localhost:8123/ --data "SELECT count() FROM system.tables WHERE database='zakaz';"
Сменить пароль datalens_reader (обязательно затем обновить файл и перезапустить ClickHouse):
docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "ALTER USER datalens_reader IDENTIFIED WITH plaintext_password BY 'NewStrongPassword!123'"
Проверить, что новая связка работает через curl и clickhouse-client.
При необходимости открыть порт 8123 во внешнем фаерволе и проверить доступ с внешнего хоста.
Regression checks

Остановить ClickHouse и убедиться, что загрузчик корректно падает:
docker stop ch-zakaz
docker run --rm --network clickhouse_default --env-file secrets/.env.qtickets_api qtickets_api:prod || echo "failed as expected"
docker start ch-zakaz
Восстановить миг тесты (опционально) и запустить python scripts/validate_clickhouse_schema.py.
Definition of Done
ClickHouse после скрипта bootstrap_clickhouse.sh становится healthy, все таблицы задекларированы.
bootstrap_grants.sql выполняется без ошибок ACCESS_DENIED.
Smoke-тест (DRY_RUN=true) завершается успехом, meta_job_runs не пополняется.
Боевой прогон (DRY_RUN=false) с реальными ключами завершился без ошибок, в таблицах появились новые строки, в meta_job_runs — статус ok.
Повторный запуск не создаёт дублей и завершился кодом 0.
Пароль datalens_reader успешно ротирован, curl/tests работают с новым значением.
Отчёт содержит логи всех команд и результаты запросов (до/после).
Отчёт (артефакты)
По завершении предоставить один Markdown-/текстовый файл с разделами:

Среда: версии Docker, Compose, ОС, Commit SHA.
Команды и вывод: последовательность действий, key logs, результаты SHOW TABLES, counts.
Boевой прогон: лог контейнера, meta_job_runs до/после.
DataLens: подтверждение успешной смены пароля, локальных запросов и (опционально) подключение из интерфейса BI.
Регрессионные тесты: остановка ClickHouse, ошибка загрузчика, возобновление.
Вывод: соответствие DoD, обнаруженные проблемы (если были) и их решение.
Пока всё это не будет зафиксировано, задача считается открытой.