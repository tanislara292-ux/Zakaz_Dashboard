# Дашборд: Ops & Data Quality

## Обзор

Дашборд для мониторинга свежести данных и операционной эффективности системы.

## Источники данных

- **Основной датасет:** `ds_ops_freshness`
- **Источник:** `bi.v_ops_freshness`
- **Дополнительный датасет:** `meta.etl_runs` (для истории прогонов)

## Фильтры дашборда

1. **Период (Date Range)**
   - Поле: `d`
   - Тип: Диапазон дат
   - Значение по умолчанию: последние 7 дней
   - Обязательный: Да

## KPI-виджеты

### 1. Freshness Sales
- **Тип:** Текст/индикатор
- **Заголовок:** Свежесть данных Sales
- **Формула:** `LAST(freshness_hours_sales)`
- **Формат:** #,##0.0 ч
- **Цвет:** 
  - Зеленый: ≤ 2 часа
  - Желтый: 2-6 часов
  - Красный: > 6 часов
- **Позиция:** верхний левый

### 2. Freshness VK
- **Тип:** Текст/индикатор
- **Заголовок:** Свежесть данных VK
- **Формула:** `LAST(freshness_hours_vk)`
- **Формат:** #,##0.0 ч
- **Цвет:** 
  - Зеленый: ≤ 3 часа
  - Желтый: 3-8 часов
  - Красный: > 8 часов
- **Позиция:** верхний центр

### 3. Общий статус
- **Тип:** Текст/индикатор
- **Заголовок:** Общий статус
- **Формула:** 
  - Зеленый: оба источника свежие
  - Желтый: один источник устарел
  - Красный: оба источника устарели
- **Позиция:** верхний правый

## Визуализации

### 1. Динамика свежести данных (Линия)
- **Тип:** Линейный график
- **Заголовок:** Свежесть данных за 72 часа
- **Ось X:** `_loaded_at` (время загрузки)
- **Ось Y:** Часы (разница с текущим временем)
- **Серии:** 
  - Sales (синяя линия)
  - VK (красная линия)
- **Источник:** `bi.v_ops_freshness`
- **Период:** последние 72 часа
- **Позиция:** средний левый
- **Размер:** 2x1

### 2. Статус загрузки (Таблица)
- **Тип:** Таблица
- **Заголовок:** Статус загрузки данных
- **Колонки:**
  - `d` (Дата)
  - `source` (Источник)
  - `loaded_at_sales` (Время загрузки Sales)
  - `loaded_at_vk` (Время загрузки VK)
  - `freshness_hours_sales` (Свежесть Sales, часы)
  - `freshness_hours_vk` (Свежесть VK, часы)
  - `freshness_status_sales` (Статус Sales)
  - `freshness_status_vk` (Статус VK)
- **Сортировка:** по дате (убывание)
- **Источник:** `bi.v_ops_freshness`
- **Позиция:** средний правый
- **Размер:** 2x1

### 3. История прогонов ETL (Таблица)
- **Тип:** Таблица
- **Заголовок:** Последние прогоны ETL
- **Источник:** `meta.etl_runs`
- **Колонки:**
  - `started_at` (Время запуска)
  - `job` (Задача)
  - `status` (Статус)
  - `duration` (Длительность, мин)
  - `rows_written` (Записей записано)
  - `from_date` (Начальная дата)
  - `to_date` (Конечная дата)
  - `err_msg` (Ошибка)
- **Сортировка:** по времени запуска (убывание)
- **Фильтр:** последние 50 прогонов
- **Позиция:** средний левый (нижний ряд)
- **Размер:** 4x1

### 4. Алерты (Таблица)
- **Тип:** Таблица
- **Заголовок:** Последние алерты
- **Источник:** `meta.etl_alerts`
- **Колонки:**
  - `ts` (Время)
  - `severity` (Уровень)
  - `job` (Задача)
  - `code` (Код)
  - `message` (Сообщение)
- **Сортировка:** по времени (убывание)
- **Фильтр:** последние 20 алертов
- **Позиция:** средний правый (нижний ряд)
- **Размер:** 4x1

### 5. Статистика по прогонам (Столбцы)
- **Тип:** Столбчатая диаграмма
- **Заголовок:** Количество прогонов по задачам
- **Источник:** `meta.etl_runs`
- **Ось X:** `job`
- **Ось Y:** `COUNT(*)`
- **Фильтр:** последние 7 дней
- **Группировка:** по задачам
- **Цвет:** по статусу (зеленый/красный)
- **Позиция:** нижний левый
- **Размер:** 2x1

### 6. Длительность прогонов (Линия)
- **Тип:** Линейный график
- **Заголовок:** Длительность прогонов по времени
- **Источник:** `meta.etl_runs`
- **Ось X:** `started_at` (время)
- **Ось Y:** `duration` (длительность, мин)
- **Фильтр:** последние 24 часа
- **Серии:** по задачам
- **Позиция:** нижний правый
- **Размер:** 2x1

## Взаимодействия

1. **При выборе периода:**
   - Обновляются все виджеты
   - Фильтруется история прогонов и алертов

2. **При клике на строку в истории прогонов:**
   - Показывается детальная информация о прогоне
   - Связанные алерты (если есть)

3. **При клике на алерт:**
   - Показывается детальная информация об ошибке
   - Связанные прогоны ETL

## Параметры обновления

- **Автообновление:** 5 минут (для мониторинга)
- **Кэширование:** 2 минуты
- **Таймзона:** Europe/Moscow

## Расположение виджетов

```
┌─────────────┬─────────────┬─────────────┐
│ Freshness   │ Freshness   │  Общий      │
│ Sales       │ VK          │  статус     │
│    (1x1)     │    (1x1)     │    (1x1)     │
├─────────────────────────────┤             │
│ Динамика    │ Статус      │             │
│ свежести    │ загрузки    │             │
│   (2x1)      │   (2x1)      │             │
├─────────────────────────────┤             │
│ История     │ Алерты      │             │
│ прогонов    │             │             │
│   (4x1)      │   (4x1)      │             │
├─────────────────────────────┤             │
│ Статистика  │ Длительность│             │
│ по прогонам │ прогонов    │             │
│   (2x1)      │   (2x1)      │             │
└─────────────────────────────┴─────────────┘
```

## Правила алертинга

1. **Критические алерты:**
   - Freshness Sales > 6 часов
   - Freshness VK > 8 часов
   - Ошибки в прогонах ETL

2. **Предупреждения:**
   - Freshness Sales > 2 часа
   - Freshness VK > 3 часа
   - Длительность прогонов > 30 минут

## Экспорт

- **ID дашборда:** (заполняется после создания)
- **JSON экспорт:** `bi/exports/ops_data_quality.json`
- **Последнее обновление:** (заполняется после создания)