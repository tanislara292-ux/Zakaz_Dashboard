# Дашборд: City Performance

## Обзор

Дашборд для анализа эффективности городов по продажам и маркетинговым показателям.

## Источники данных

- **Основной датасет:** `ds_roi_daily`
- **Источник:** `bi.v_marketing_roi_daily`

## Фильтры дашборда

1. **Период (Date Range)**
   - Поле: `d`
   - Тип: Диапазон дат
   - Значение по умолчанию: последние 30 дней
   - Обязательный: Да

2. **Город (Multi-select)**
   - Поле: `city`
   - Тип: Мультиселект
   - Значение по умолчанию: все города
   - Обязательный: Нет

## KPI-виджеты

### 1. Всего городов
- **Тип:** Текст/индикатор
- **Заголовок:** Всего городов
- **Формула:** `COUNT(DISTINCT city)`
- **Формат:** #,##0
- **Цвет:** Синий
- **Позиция:** верхний левый

### 2. Средний ROAS
- **Тип:** Текст/индикатор
- **Заголовок:** Средний ROAS
- **Формула:** `AVG(roas)`
- **Формат:** #,##0.00x
- **Цвет:** Зеленый
- **Позиция:** верхний центр

### 3. Общая выручка
- **Тип:** Текст/индикатор
- **Заголовок:** Общая выручка
- **Формула:** `SUM(revenue)`
- **Формат:** #,##0.00 ₽
- **Цвет:** Оранжевый
- **Позиция:** верхний правый

## Визуализации

### 1. Карта/Heatmap городов (Карта)
- **Тип:** Карта/Heatmap
- **Заголовок:** Выручка по городам
- **Поля:**
  - География: `city`
  - Значение: `SUM(revenue)`
  - Цветовая шкала: от зеленого к красному
- **Позиция:** средний левый
- **Размер:** 2x2
- **Примечание:** Если карта недоступна, использовать Pareto-диаграмму

### 2. Pareto: Revenue vs Spend (Точечная диаграмма)
- **Тип:** Точечная диаграмма
- **Заголовок:** Эффективность городов (Revenue vs Spend)
- **Ось X:** `SUM(spend)`
- **Ось Y:** `SUM(revenue)`
- **Размер точек:** `SUM(tickets_sold)`
- **Цвет точек:** `AVG(roas)` (градиент)
- **Позиция:** средний правый
- **Размер:** 2x2

### 3. Лестница городов по ROAS (Столбцы)
- **Тип:** Столбчатая диаграмма
- **Заголовок:** Топ-10 городов по ROAS
- **Ось X:** `city`
- **Ось Y:** `AVG(roas)`
- **Сортировка:** по убыванию ROAS
- **Лимит:** 10
- **Цвет:** Зеленый
- **Позиция:** средний левый (нижний ряд)
- **Размер:** 2x1

### 4. Худшие города по ROAS (Столбцы)
- **Тип:** Столбчатая диаграмма
- **Заголовок:** Bottom-10 городов по ROAS
- **Ось X:** `city`
- **Ось Y:** `AVG(roas)`
- **Сортировка:** по возрастанию ROAS
- **Лимит:** 10
- **Цвет:** Красный
- **Фильтр:** `spend > 0` (только города с расходами)
- **Позиция:** средний правый (нижний ряд)
- **Размер:** 2x1

### 5. Детализация по городам (Таблица)
- **Тип:** Таблица
- **Заголовок:** Детализация по городам
- **Колонки:**
  - `city` (Город)
  - `revenue` (Выручка)
  - `spend` (Расходы)
  - `roas` (ROAS)
  - `tickets_sold` (Продано билетов)
  - `cpc` (CPC)
  - `cpt` (CPT)
  - `clicks` (Клики)
  - `impressions` (Показы)
- **Сортировка:** по выручке (убывание)
- **Пагинация:** 20 строк
- **Позиция:** нижний
- **Размер:** 4x2

## Взаимодействия

1. **При выборе периода:**
   - Обновляются все виджеты
   - KPI пересчитываются за выбранный период

2. **При выборе города/городов:**
   - Фильтруются все виджеты
   - Подсвечиваются выбранные города на карте/диаграммах

3. **При клике на город в топе/анти-топе:**
   - Фильтруется весь дашборд по выбранному городу
   - Обновляются все виджеты

4. **При клике на точку на диаграмме эффективности:**
   - Фильтруется весь дашборд по выбранному городу
   - Показывается детальная информация по городу

## Параметры обновления

- **Автообновление:** 15 минут
- **Кэширование:** 10 минут
- **Таймзона:** Europe/Moscow

## Расположение виджетов

```
┌─────────────┬─────────────┬─────────────┐
│   Всего     │  Средний    │   Общая     │
│   городов   │   ROAS      │  выручка    │
│    (1x1)     │    (1x1)     │    (1x1)     │
├─────────────────────────────┤             │
│ Карта/Heatmap│ Эффективность│             │
│   городов    │   городов   │             │
│    (2x2)     │    (2x2)     │             │
├─────────────────────────────┤             │
│ Топ-10      │ Bottom-10    │             │
│ по ROAS     │ по ROAS     │             │
│    (2x1)     │    (2x1)     │             │
├─────────────────────────────┤             │
│        Детализация         │             │
│        по городам (4x2)    │             │
└─────────────────────────────┴─────────────┘
```

## Альтернативный вариант (без карты)

Если карта недоступна:

```
┌─────────────┬─────────────┬─────────────┐
│   Всего     │  Средний    │   Общая     │
│   городов   │   ROAS      │  выручка    │
│    (1x1)     │    (1x1)     │    (1x1)     │
├─────────────────────────────┤             │
│   Pareto:   │ Топ-10      │             │
│ Revenue vs  │ по ROAS     │             │
│ Spend (2x2) │   (2x1)     │             │
├─────────────┼─────────────┤             │
│ Bottom-10   │ Распределение│             │
│ по ROAS     │ по доходам  │             │
│    (2x1)     │   (2x1)     │             │
├─────────────────────────────┤             │
│        Детализация         │             │
│        по городам (4x2)    │             │
└─────────────────────────────┴─────────────┘
```

## Экспорт

- **ID дашборда:** (заполняется после создания)
- **JSON экспорт:** `bi/exports/city_performance.json`
- **Последнее обновление:** (заполняется после создания)