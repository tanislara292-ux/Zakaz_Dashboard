
# Протокол работы AI-кодера

## ФАЗА 1 — Ознакомиться (Input & Контекст)

### 1.1. Быстрый аудит репозитория

* Пролистать корень и каталоги:

  * `appscript/` — Apps Script потока QTickets
  * `vk-python/` — пайплайн VK Ads
  * `schemas/sheets/` — YAML-схемы листов
  * `tools/` — CLI для инициализации/валидации Sheets
  * `docs/` и `ops/` — проектные документы, DoR/DoD
* Проверить `README`/`docs/PROJECT_OVERVIEW.md` на актуальность целей и KPI.

### 1.2. Ключевые документы (минимальный пакет для чтения)

1. `docs/ARCHITECTURE.md` — общая схема потоков.
2. `docs/PROJECT_OVERVIEW.md` — цели, артефакты, дорожная карта.
3. `docs/ACCESS_HANDBOOK.md` — секреты/доступы (где брать токены).
4. `schemas/sheets/*.yaml` — контракт столбцов для `QTickets`, `Inventory`, `VK_Ads`, `BI_Central`.
5. `docs/RISK_LOG.md` — риски и известные грабли.
6. (если задача затрагивает визуализацию) модели в `docs/PROJECT_OVERVIEW.md` для DataLens.

### 1.3. Локальная проверка окружения

* Скопировать `.env.sample` → `.env`, проставить ключи (Google/VK).
* Инициализация:

  ```bash
  bash tools/init.sh
  python tools/sheets_init.py
  python tools/sheets_validate.py
  ```
* Прогнать пайплайн VK Ads в dry-run:

  ```bash
  cd vk-python
  python -m vk_ads_pipeline.main --dry-run --verbose
  ```
* Критерий готовности к работе (DoR):

  * Скрипты `tools/*` завершаются без ошибок.
  * Dry-run VK Ads отрабатывает и пишет логи/предпросмотр.
  * Схемы листов соответствуют `schemas/sheets/*.yaml`.

---

## ФАЗА 2 — Спланировать (Декомпозиция и план выполнения)

### 2.1. Принятие задачи

* Сопоставить задачу с Артефактами:

  * Затрагивает ли она **структуру листов** (требует правок `schemas/sheets`)?
  * В каком модуле править код: `appscript/`, `vk-python/`, `tools/`, или нужен **новый модуль** (например, подготовка к ClickHouse)?
  * Необходимы ли изменения в DataLens моделях/датасетах?

### 2.2. Аналитическая записка (короткий ADR-шаблон, положить в `docs/adr/ADR-<issue>.md`)

**Шаблон:**

```
# ADR-<issue>: <краткое название>
Дата: <YYYY-MM-DD>
Контекст: <какую боль/ограничение решаем, какие источники данных затронуты>
Решение: <что делаем в коде/схемах/инфраструктуре>
Контракты данных: <изменения столбцов, типы, маппинги, дедуп-правила>
Риски: <что может пойти не так и как поймем>
Тест-план: <юнит/интеграционные, dry-run, валидации sheets>
Критерии приёмки (DoD): <bullet list>
```

### 2.3. План изменений (Issue/PR чек-лист)

* Создать ветку: `feature/<issue-id>-<slug>`.
* Согласовать перечень файлов:

  * Код: `vk-python/...` / `appscript/...` / `tools/...`
  * Схемы: `schemas/sheets/<table>.yaml`
  * Документация: `docs/adr/`, `docs/ARCHITECTURE.md` (если меняется поток), `docs/PROJECT_OVERVIEW.md` (если меняются артефакты/KPI).
* Определить артефакты проверки: снапшоты данных (CSV), скрин логов, скрины DataLens (если визуализация).

---

## ФАЗА 3 — Реализовать (Код → Тесты → Документация → Отчёт → Коммиты)

### 3.1. Реализация

* Следовать стилю (pre-commit: `black`, `markdownlint`).
* Строго соблюдать **контракты столбцов** из `schemas/sheets/*.yaml`.
* Логирование:

  * В `vk-python`: уровень `INFO` для этапов, `WARN/ERROR` для отклонений.
  * В Apps Script: писать в лист `Logs` (с меткой задачи/коммита).
* Секреты брать только из `.env`/Script Properties — не хардкодить.

### 3.2. Тестирование

* Юнит-тесты (если затронут Python-код): `pytest -q`.
* Интеграционные:

  * `python tools/sheets_validate.py` — схему не ломаем.
  * `vk-python` с `--dry-run` на выборочном диапазоне дат.
  * Если менялись UTM-нормализации/дедуп — приложить выборку «до/после» (CSV в `artifacts/`).
* (если задача про визуализацию) Обновить датасет в DataLens (локально воспроизвести трансформации; шаги описать в отчёте).

### 3.3. Обновление документации

* `docs/adr/ADR-<issue>.md` — финализировать по факту реализации.
* `docs/ARCHITECTURE.md` — если менялась схема потоков/точки автоматизации.
* `docs/PROJECT_OVERVIEW.md` — если появились новые артефакты/метрики.
* `schemas/sheets/*.yaml` — если менялась структура данных (и обновить `tools/sheets_init.py`, если требуется).

### 3.4. Итоговый отчёт (положить в описание PR и в `docs/changelog/CHANGELOG.md`)

**Шаблон отчёта:**

```
Задача: <issue-id / краткое название>
Суть изменений:
- <1-3 пункта что сделано>

Контракты данных:
- Изменения столбцов: <нет/список>
- Правила дедуп/нормализации: <описание>

Проверки:
- Юнит-тесты: <кол-во/ок>
- Интеграционные: <dry-run диапазон, скрин/ссылка на артефакты>
- Валидация схем: <ок/замечания>

Риски и как мониторим:
- <список> (например, рост дублей; таймауты VK API)

Результат:
- <метрика/скрины/объём строк/время выполнения>
```

### 3.5. Коммиты и PR

* Формат commit messages — **Conventional Commits**:

  * `feat(vk-ads): normalize utm_source for promo_*`
  * `fix(appscript): retry on QTickets quota errors`
  * `chore(schemas): add column refund_reason to VK_Ads`
* Один PR — одна логическая задача.
* В PR приложить:

  * ссылку на ADR,
  * артефакты проверки (`artifacts/*.csv`, скрины логов/дашборда),
  * список затронутых таблиц/листов.
* Чек-лист PR (DoD):

  * [ ] pre-commit прошёл
  * [ ] unit/integration тесты зелёные
  * [ ] валидация схем `tools/sheets_validate.py` — ОК
  * [ ] документация обновлена (ADR/ARCHITECTURE/CHANGELOG)
  * [ ] секреты не утекли, `.env` не меняли в репозитории
  * [ ] приложены примеры/скрины результатов

---

## Доп. правила для частных случаев

### Изменения в Google Sheets

* Любое изменение структуры листа → сначала правим `schemas/sheets/<table>.yaml`, затем запускаем:

  ```bash
  python tools/sheets_init.py
  python tools/sheets_validate.py
  ```
* В отчёте указать, какие визуализации DataLens это затрагивает.

### VK Ads пайплайн

* При изменении нормализаций/дедупа — приложить «контрольную выборку» на 2–3 дня (до/после).
* Любая новая метрика VK — добавить маппинг и описание в `docs/PROJECT_OVERVIEW.md`.

### Подготовка к миграции в ClickHouse (если задача затрагивает)

* Создать отдельный ADR «стратегия перехода» с планом зеркалирования данных из Sheets.
* Код для CH складывать в новый каталог (например, `ch-python/` или `infra/`), не ломая текущий MVP.
* Контракты витрин документировать отдельно, не смешивая с `schemas/sheets`.

---

## Короткая памятка (TL;DR)

1. **Ознакомиться:** прочитай 5 файлов (ARCHITECTURE, OVERVIEW, ACCESS, YAML-схемы, RISK_LOG) → проверь окружение `tools/*`, dry-run VK.
2. **Спланировать:** создай ADR + план ветки/файлов + критерии приёмки.
3. **Реализовать:** код по стилю, тесты, валидации, обнови доки и схемы, подготовь отчёт, оформи PR по чек-листу.
