# Инструкция по настройке DataLens

## Подключение к ClickHouse

### 1. Создание подключения

1. Войдите в DataLens: https://datalens.yandex.ru/
2. Перейдите в раздел "Подключения"
3. Нажмите "Создать подключение" → "ClickHouse"
4. Заполните поля:
   - **Хост**: `bi.zakaz-dashboard.ru`
   - **Порт**: `443`
   - **База данных**: `zakaz`
   - **Имя пользователя**: `datalens_reader`
   - **Пароль**: `DataLens2024!Strong#Pass`
   - **Использовать HTTPS**: ✅
5. Нажмите "Проверить подключение" и затем "Создать"
6. Назовите подключение: `ch_zakaz_prod`

### 2. Создание источника данных "Sales"

1. В созданном подключении нажмите "Создать источник" → "SQL"
2. Введите SQL-запрос:
   ```sql
   SELECT
       event_date,
       city,
       event_name,
       tickets_sold,
       revenue,
       refunds_amount,
       (revenue - refunds_amount) AS net_revenue
   FROM zakaz.v_sales_latest
   ```
3. Назовите источник: `src_ch_sales_latest`
4. Нажмите "Создать"

### 3. Создание источника данных "Marketing"

1. В подключении `ch_zakaz_prod` создайте еще один источник
2. Введите SQL-запрос:
   ```sql
   SELECT
       d,
       city,
       spend_total,
       net_revenue,
       romi
   FROM zakaz.v_marketing_daily
   ```
3. Назовите источник: `src_ch_marketing_daily`
4. Нажмите "Создать"

### 4. Создание датасета "Sales"

1. На основе источника `src_ch_sales_latest` создайте датасет
2. Настройте поля:
   - **Dimensions**:
     - `event_date` (Date)
     - `city` (String)
     - `event_name` (String)
   - **Measures**:
     - `tickets_sold` (SUM)
     - `revenue` (SUM)
     - `refunds_amount` (SUM)
     - `net_revenue` (SUM)
3. Назовите датасет: `ds_sales`

### 5. Создание датасета "Marketing"

1. На основе источника `src_ch_marketing_daily` создайте датасет
2. Настройте поля:
   - **Dimensions**:
     - `d` (Date)
     - `city` (String)
   - **Measures**:
     - `spend_total` (SUM)
     - `net_revenue` (SUM)
     - `romi` (AVG)
3. Назовите датасет: `ds_marketing`

## Создание дашборда

### 1. Создание дашборда

1. В DataLens нажмите "Создать" → "Дашборд"
2. Назовите дашборд: "Zakaz: Продажи и Реклама"
3. Добавьте описание: "Аналитика продаж и эффективности рекламы"

### 2. Добавление виджетов

#### Виджет 1: Динамика выручки
1. Нажмите "Добавить чарт" → "Линия"
2. Источник: `ds_sales`
3. X: `event_date`
4. Y: `net_revenue` (SUM)
5. Фильтр: `event_date` за последние 30 дней
6. Заголовок: "Выручка по дням"

#### Виджет 2: ROMI по городам
1. Нажмите "Добавить чарт" → "Столбцы"
2. Источник: `ds_marketing`
3. X: `city`
4. Y: `romi` (AVG)
5. Фильтр: `d` за последние 30 дней
6. Заголовок: "ROMI по городам"
7. Цветовая индикация:
   - > 1.5: зеленый
   - 1-1.5: желтый
   - < 1: красный

#### Виджет 3: Топ городов по выручке
1. Нажмите "Добавить чарт" → "Столбцы"
2. Источник: `ds_sales`
3. X: `city`
4. Y: `revenue` (SUM)
5. Сортировка: по `revenue` убывание
6. Лимит: 20
7. Заголовок: "Топ городов по выручке"

#### Виджет 4: KPI-показатели
1. Нажмите "Добавить показатель" → "Значение"
2. Источник: `ds_sales`
3. Показатель: `SUM(net_revenue)` за последние 7 дней
4. Заголовок: "Выручка за 7 дней"

5. Добавьте еще один показатель:
   - Показатель: `SUM(tickets_sold)` за последние 7 дней
   - Заголовок: "Билетов за 7 дней"

### 3. Добавление фильтров

1. Нажмите "Добавить фильтр" → "Диапазон дат"
2. Поле: `event_date` из `ds_sales`
3. Заголовок: "Период"

4. Добавьте еще один фильтр:
   - Тип: "Список"
   - Поле: `city` из `ds_sales`
   - Заголовок: "Города"

## Настройка доступа

1. Нажмите "Поделиться" в правом верхнем углу
2. Добавьте пользователей:
   - `RomaVXION@yandex.ru` - редактор
   - `ads-irsshow@yandex.ru` - редактор
3. Установите публичный доступ при необходимости

## Проверка работы

1. Убедитесь, что все виджеты отображают данные
2. Проверьте работу фильтров
3. Проверьте обновление данных (должно происходить автоматически каждые 15 минут)

## Оптимизация

Если дашборд загружается медленно:
1. Используйте предагрегированные данные за последние 14 дней
2. Уменьшите количество отображаемых городов в топе
3. Настройте кэширование на 15-30 минут

## Ссылка на дашборд

После завершения настройки скопируйте URL дашборда и добавьте в:
1. `docs/RUNBOOK_DATALENS.md`
2. `ops/HANDOVER_PACKAGE.md`