# Чек-лист передачи DataLens заказчику

## Обзор

Документ содержит контрольный чек-лист для проверки готовности системы аналитики Zakaz Dashboard к передаче заказчику.

## Инфраструктура

### ClickHouse

- [ ] ClickHouse запущен и работает
  ```bash
  docker exec ch-zakaz clickhouse-client -q "SELECT 1"
  ```

- [ ] HTTPS доступ настроен через Caddy
  ```bash
  curl -I https://bi.zakaz-dashboard.ru/?query=SELECT%201
  ```

- [ ] Пользователь datalens_reader создан с правильными правами
  ```sql
  -- Проверка прав
  SHOW GRANTS FOR datalens_reader;
  ```

- [ ] База данных zakaz доступна
  ```sql
  USE zakaz;
  SHOW TABLES;
  ```

### Системные сервисы

- [ ] Systemd таймеры работают
  ```bash
  systemctl list-timers | grep -E 'qtickets|vk_ads|direct|alerts'
  ```

- [ ] Healthcheck сервер доступен
  ```bash
  curl http://localhost:8080/healthz
  ```

- [ ] Алерты работают
  ```bash
  journalctl -u alerts.service -n 20
  ```

- [ ] Бэкапы создаются
  ```bash
  docker exec ch-zakaz clickhouse-client --user=backup_user -q "
  SELECT backup_name, status, ts FROM meta.backup_runs ORDER BY ts DESC LIMIT 5"
  ```

## Данные

### Свежесть данных

- [ ] Данные QTickets свежие (не старше 2 часов)
  ```sql
  SELECT 
      'qtickets' as source,
      max(event_date) as latest_date,
      today() - max(event_date) as days_behind
  FROM zakaz.v_sales_latest;
  ```

- [ ] Данные VK Ads свежие (не старше 24 часов)
  ```sql
  SELECT 
      'vk_ads' as source,
      max(stat_date) as latest_date,
      today() - max(stat_date) as days_behind
  FROM zakaz.fact_vk_ads_daily;
  ```

- [ ] Данные Яндекс.Директ свежие (не старше 24 часов)
  ```sql
  SELECT 
      'direct' as source,
      max(stat_date) as latest_date,
      today() - max(stat_date) as days_behind
  FROM zakaz.fact_direct_daily;
  ```

### Качество данных

- [ ] Нет дубликатов в данных продаж
  ```sql
  SELECT 
      count() - countDistinct(concat(event_date, city, event_name)) as duplicates
  FROM zakaz.v_sales_latest
  WHERE event_date >= today() - 7;
  ```

- [ ] Представления для DataLens работают
  ```sql
  SELECT count() FROM zakaz.v_sales_latest;
  SELECT count() FROM zakaz.v_marketing_daily;
  SELECT count() FROM zakaz.v_sales_14d;
  ```

- [ ] Метаданные о запусках актуальны
  ```sql
  SELECT 
      job,
      started_at,
      status,
      rows_processed
  FROM zakaz.meta_job_runs 
  ORDER BY started_at DESC 
  LIMIT 10;
  ```

## DataLens

### Подключение

- [ ] Подключение ch_zakaz_prod создано
  - Хост: bi.zakaz-dashboard.ru
  - Порт: 443
  - База данных: zakaz
  - Пользователь: datalens_reader
  - HTTPS: включен

- [ ] Тест подключения прошел успешно
  ```sql
  SELECT 1 as test_connection;
  ```

### Источники данных

- [ ] Источник src_ch_sales_latest создан и работает
  ```sql
  SELECT count() FROM zakaz.v_sales_latest LIMIT 1;
  ```

- [ ] Источник src_ch_marketing_daily создан и работает
  ```sql
  SELECT count() FROM zakaz.v_marketing_daily LIMIT 1;
  ```

- [ ] Источник src_ch_sales_14d создан и работает
  ```sql
  SELECT count() FROM zakaz.v_sales_14d LIMIT 1;
  ```

### Датасеты

- [ ] Датасет ds_sales создан
  - Поля настроены правильно
  - Агрегации настроены
  - Вычисляемые поля работают

- [ ] Датасет ds_marketing создан
  - Поля настроены правильно
  - Агрегации настроены
  - Вычисляемые поля работают

- [ ] Датасет ds_sales_14d создан
  - Поля настроены правильно
  - Агрегации настроены

### Дашборды

- [ ] Дашборд "Zakaz: Продажи" создан
  - KPI-виджеты работают
  - Графики строятся
  - Фильтры работают
  - Автообновление настроено

- [ ] Дашборд "Zakaz: Эффективность рекламы" создан
  - KPI-виджеты работают
  - Графики строятся
  - Цветовая индикация ROAS работает
  - Фильтры работают

- [ ] Дашборд "Zakaz: Операционные метрики" создан
  - Метрики свежести данных отображаются
  - Статусы запусков показываются
  - Алерты отображаются

## Производительность

### Скорость загрузки

- [ ] Дашборды загружаются менее 5 секунд
- [ ] Графики строятся менее 10 секунд
- [ ] Фильтры применяются менее 3 секунд

### Оптимизация

- [ ] Используются предагрегированные данные (v_sales_14d)
- [ ] Настроено кэширование
- [ ] Ограничены запросы по времени и результатам

## Тестирование

### Функциональное тестирование

- [ ] Все дашборды отображают данные
- [ ] Фильтры работают корректно
- [ ] KPI пересчитываются при изменении периода
- [ ] Графики обновляются при изменении фильтров

### Нагрузочное тестирование

- [ ] Система работает при одновременном доступе нескольких пользователей
- [ ] Сложные запросы выполняются в допустимое время
- [ ] Система не зависает при больших объемах данных

### Smoke-тестирование

- [ ] Скрипт smoke_test_integrations.py выполнен без ошибок
  ```bash
  python3 ops/smoke_test_integrations.py --verbose
  ```

- [ ] Все тесты пройдены
- [ ] Нет критичных алертов

## Документация

### Техническая документация

- [ ] RUNBOOK_DATALENS.md обновлен
- [ ] DATALENS_TECHNICAL_SPEC.md создан
- [ ] DATALENS_CONNECTION_PLAN.md создан

- [ ] ID дашбордов документированы
- [ ] SQL-запросы источников задокументированы
- [ ] Troubleshooting guide добавлен

### Пользовательская документация

- [ ] CUSTOMER_GUIDE.md создан
- [ ] Инструкции по использованию дашбордов
- [ ] Часто задаваемые вопросы
- [ ] Сценарии использования

### Документация для передачи

- [ ] HANDOVER_PACKAGE.md обновлен
- [ ] Контакты поддержки добавлены
- [ ] Доступы задокументированы
- [ ] Версия системы указана

## Безопасность

### Права доступа

- [ ] Пользователи DataLens созданы
  - RomaVXION@yandex.ru (редактор)
  - ads-irsshow@yandex.ru (редактор)

- [ ] Права доступа настроены корректно
- [ ] Публичный доступ настроен при необходимости

### Безопасность данных

- [ ] Секреты хранятся securely
- [ ] SSL/TLS используется для всех соединений
- [ ] Аудит доступа включен

## Готовность к передаче

### Критерии готовности

- [ ] Все пункты чек-листа выполнены
- [ ] Система стабильно работает 24 часа
- [ ] Все тесты пройдены
- [ ] Документация готова

### Финальная проверка

- [ ] Выполнена полная проверка системы
  ```bash
  bash ops/system_check.sh
  ```

- [ ] Проведена демонстрация заказчику
- [ ] Получено подтверждение готовности

## Передача заказчику

### Доступы

- [ ] Ссылки на дашборды отправлены заказчику
- [ ] Учетные записи созданы и работают
- [ ] Инструкции по доступу предоставлены

### Обучение

- [ ] Проведено обучение заказчика
- [ ] Продемонстрированы все возможности
- [ ] Ответы на вопросы получены

### Поддержка

- [ ] Контакты поддержки предоставлены
- [ ] SLA поддержки определен
- [ ] Процедура обращения в поддержку объяснена

## Пост-передача

### Мониторинг

- [ ] Настроен мониторинг после передачи
- [ ] Алерты о проблемах настроены
- [ ] Логирование обращений в поддержку

### Обратная связь

- [ ] Процедура сбора обратной связи определена
- [ ] Каналы коммуникации установлены
- [ ] План улучшений подготовлен

---

**Дата проверки**: $(date +%Y-%m-%d)
**Проверил**: [Имя проверяющего]
**Статус**: [Готов к передаче / Требуются доработки]