# Чек-лист тестирования бэкапов и восстановления

## Ежедневная проверка

### Автоматическая
- [ ] Полный бэкап выполнен успешно (статус 'ok' в meta.backup_runs)
- [ ] Инкрементальный бэкап выполнен успешно
- [ ] Нет ошибок в логах systemd таймеров

### Ручная
- [ ] Проверка свежести бэкапа (не старше 24 часов)
- [ ] Проверка размера бэкапа (соответствует ожиданиям)

## Еженедельная проверка

### Тестовое восстановление
```bash
# Запуск тестового восстановления
./ops/restore_test.sh

# Проверка результатов
./ops/backup_verify.py --fresh-hours 168
```

- [ ] Тестовое восстановление завершилось успешно
- [ ] Данные в восстановленной базе корректны
- [ ] Все таблицы доступны
- [ ] Количество строк соответствует ожиданиям

### Верификация бэкапов
```bash
# Полная верификация
./ops/backup_verify.py
```

- [ ] Все бэкапы существуют в хранилище
- [ ] Цепочка бэкапов корректна (полные → инкрементальные)
- [ ] Нет отсутствующих бэкапов

## Ежемесячная проверка

### Полное тестирование
- [ ] Восстановление на отдельный сервер/контейнер
- [ ] Проверка всех типов бэкапов (полный, инкрементальный)
- [ ] Проверка производительности восстановленной системы
- [ ] Валидация ключевых бизнес-метрик

### Проверка политик хранения
```bash
# Запуск очистки
./ops/backup_prune.sh

# Проверка результатов
clickhouse-client --query "
    SELECT mode, count() 
    FROM meta.backup_runs 
    WHERE status = 'ok' 
    GROUP BY mode"
```

- [ ] Старые бэкапы удалены согласно политике
- [ ] Золотые бэкапы сохранены
- [ ] Свободного места достаточно

## Квартальная проверка

### Комплексное тестирование
- [ ] Тестирование в условиях стресса (большой объем данных)
- [ ] Тестирование восстановления из разных типов бэкапов
- [ ] Проверка кросс-платформенной совместимости
- [ ] Тестирование Disaster Recovery процедур

### Обновление документации
- [ ] Обновлены runbooks
- [ ] Обновлены контакты
- [ ] Обновлены процедуры
- [ ] Проведено обучение команды

## Проверка после изменений

### После обновления ClickHouse
- [ ] Создан бэкап перед обновлением
- [ ] Бэкап после обновления
- [ ] Тестовое восстановление обоих бэкапов
- [ ] Проверка совместимости версий

### После изменения схемы данных
- [ ] Создан бэкап перед изменением
- [ ] Бэкап после изменения
- [ ] Тестовое восстановление
- [ ] Проверка миграции данных

### После изменения конфигурации бэкапов
- [ ] Тестирование новой конфигурации
- [ ] Проверка совместимости со старыми бэкапами
- [ ] Обновление документации

## Критерии успеха

### Функциональные
- [ ] Все бэкапы создаются по расписанию
- [ ] Все бэкапы успешно восстанавливаются
- [ ] Данные после восстановления корректны
- [ ] Время восстановления соответствует RTO

### Производительность
- [ ] Время создания бэкапа в пределах нормы
- [ ] Время восстановления в пределах нормы
- [ ] Система не деградирует во время бэкапа

### Надежность
- [ ] Нет пропущенных бэкапов
- [ ] Нет ошибок в логах
- [ ] Алерты работают корректно

## Действия при неудачных тестах

### Бэкап не создается
1. Проверить логи: `journalctl -u backup@full.service -n 50`
2. Проверить доступность ClickHouse
3. Проверить права пользователя backup_user
4. Проверить доступность хранилища (S3/local)
5. Создать инцидент и уведомить команду

### Восстановление не работает
1. Проверить целостность бэкапа: `./ops/backup_verify.py --backup-name <name>`
2. Попробовать восстановить другой бэкап
3. Проверить совместимость версий ClickHouse
4. Создать новый полный бэкап
5. Создать инцидент и уведомить команду

### Данные некорректны после восстановления
1. Сравнить данные до и после восстановления
2. Проверить логи восстановления на наличие ошибок
3. Проверить целостность бэкапа
4. Создать новый полный бэкап
5. Создать инцидент и уведомить команду

## Отчетность

### Еженедельный отчет
```
Дата: YYYY-MM-DD
Проверено бэкапов: X
Успешных: X
Неудачных: X
Тестовых восстановлений: X
Успешных: X
Проблемы: [описание]
Действия: [описание]
```

### Ежемесячный отчет
```
Месяц: YYYY-MM
Всего бэкапов: X
Успешных: X%
Среднее время создания: X минут
Среднее время восстановления: X минут
Проблемы: [описание]
Улучшения: [описание]
```

## Контакты

- **Ответственный за бэкапы**: [Имя] - [email] - [телефон]
- **DevOps дежурный**: [Имя] - [email] - [телефон]
- **Инженер данных**: [Имя] - [email] - [телефон]

## Дополнительные ресурсы

- [RUNBOOK_BACKUP_RESTORE.md](../docs/RUNBOOK_BACKUP_RESTORE.md)
- [DISASTER_RUNBOOK.md](../docs/DISASTER_RUNBOOK.md)
- [README_BACKUP.md](./README_BACKUP.md)