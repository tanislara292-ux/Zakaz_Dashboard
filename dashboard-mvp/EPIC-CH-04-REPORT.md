# Отчет о реализации EPIC-CH-04: Оркестрация ETL (systemd + GitHub Actions), мониторинг/алерты и backfill-сценарии

## Обзор

Реализована полная система оркестрации ETL-процессов проекта Zakaz, включая мониторинг выполнения, алерты и backfill-сценарии. Система обеспечивает надежный суточный прогон пайплайнов, централизованные логи выполнения с метриками качества и уведомления при сбоях/аномалиях.

## Реализованные компоненты

### 1. Метаданные и мониторинг в ClickHouse

Добавлены в `infra/clickhouse/init.sql`:

- **База данных `meta`** для хранения метаданных ETL-процессов
- **Таблица `meta.etl_runs`** - реестр прогонов ETL с полями:
  - `job` - название job'а
  - `run_id` - уникальный ID прогона
  - `started_at/finished_at` - время начала/окончания
  - `status` - статус выполнения ('ok' | 'error')
  - `rows_written/rows_read` - количество обработанных строк
  - `err_msg` - сообщение об ошибке
  - `from_date/to_date` - диапазон дат обработки
  - `host` - хост выполнения
  - `version_tag` - версия кода (git commit)

- **Таблица `meta.etl_alerts`** - реестр алертов с полями:
  - `ts` - время алерта
  - `severity` - уровень ('warning' | 'critical')
  - `job` - связанный job
  - `code` - код алерта
  - `message` - сообщение
  - `context_json` - дополнительный контекст

- **Представление `meta.v_quality_last_day`** - быстрые проверки качества данных за последний день

### 2. Единые точки входа (скрипты для запуска job'ов)

Созданы в директории `ops/`:

- **`ops/run_job.sh`** - обёртка исполнения с логированием и записью в `meta.etl_runs`
  - Поддерживаемые job'ы: `vk_fetch`, `build_dm_vk`, `build_dm_sales`, `backfill_all`
  - Автоматическая запись метаданных выполнения
  - Генерация уникального run_id для каждого прогона

- **`ops/alert_notify.py`** - отправка оповещений в Telegram
  - Минималистичная реализация через Telegram Bot API
  - Поддержка переменных окружения `TG_BOT_TOKEN` и `TG_CHAT_ID`

- **`ops/healthcheck.py`** - быстрые SQL-проверки качества данных
  - Проверка наличия данных в витринах за вчера
  - Проверка отсутствия отрицательных значений
  - Код возврата 2 при обнаружении проблем

- **`ops/backfill.py`** - единый скрипт для full backfill за период
  - Последовательный запуск всех этапов пайплайна
  - Поддержка произвольных диапазонов дат

### 3. Оркестрация на сервере (systemd timers)

Созданы в `infra/systemd/`:

- **`etl@.service`** - шаблон сервиса для любой job
  - Type=oneshot для разового выполнения
  - Загрузка переменных из `.env`
  - Таймаут запуска 15 минут

- **`etl@.timer`** - шаблон таймера
  - Расписание по умолчанию: 05:35 MSK
  - Поддержка часовой зоны Europe/Moscow
  - Persistent=true для пропущенных запусков

**Расписание по умолчанию:**
- `vk_fetch` - 05:35 MSK
- `build_dm_vk` - 05:50 MSK
- `build_dm_sales` - 06:05 MSK

### 4. GitHub Actions

Создан `.github/workflows/etl_dispatch.yml`:

- **workflow_dispatch** для ручных запусков
- Поддержка всех job'ов через параметры
- Backfill за указанный период
- Автоматическая установка зависимостей
- Загрузка секретов в переменные окружения
- Отправка алертов при неудачном выполнении

### 5. Алерты и аномалистика

Реализованы следующие типы алертов:

- **RUN_FAILED** - любой ненулевой код завершения job
- **ZERO_ROWS** - отсутствие данных в витринах за предыдущий день
- **ANOMALY** - отрицательные значения денежных показателей

Алерты отправляются в Telegram и записываются в `meta.etl_alerts`.

### 6. Документация

Создан `docs/RUNBOOK_ETL.md` с подробным описанием:

- Компонентов системы и их назначения
- Процедур установки и настройки
- Инструкций по запуску job'ов и backfill
- Поиска и устранения проблем
- Обслуживания и отката изменений

Обновлен `CHANGELOG.md` с информацией о версии 0.6.0.

## Тест-план и проверка

### 1. Инсталляция и расписание
- [x] Шаблоны сервисов и таймеров созданы
- [x] Расписание настроено с учетом часовой зоны Europe/Moscow
- [ ] Таймеры активны и срабатывают по `OnCalendar`

### 2. Запись метаданных
- [x] Таблицы `meta.etl_runs`, `meta.etl_alerts`, `meta.v_quality_last_day` созданы
- [ ] После каждого прогона в `meta.etl_runs` появляется строка со статусом

### 3. Healthcheck
- [x] Скрипт `ops/healthcheck.py` реализован
- [ ] Возвращает `OK` при наличии данных за вчера
- [ ] Код 2 и сообщение при искусственном "обнулении" витрины

### 4. Алерты
- [x] Интеграция с Telegram реализована
- [ ] При проваленном job приходит Telegram-уведомление
- [ ] Запись в `meta.etl_alerts` при срабатывании

### 5. Backfill
- [x] Скрипт `ops/backfill.py` реализован
- [ ] Корректно пересобирает диапазон дат
- [ ] Повторный запуск не меняет суммы (идемпотентность)

### 6. DataLens наблюдение
- [ ] Создан "технический" датасет на `meta.etl_runs`
- [ ] "Светофор" карточка статуса за последние 24/48 ч

## Критерии приёмки (DoD)

- [x] Таблицы `meta.etl_runs`, `meta.etl_alerts` и `view meta.v_quality_last_day` в ClickHouse.
- [x] Скрипты `ops/run_job.sh`, `ops/healthcheck.py`, `ops/alert_notify.py`, `ops/backfill.py`.
- [x] Шаблоны `infra/systemd/etl@.service` и `etl@.timer` созданы.
- [ ] Шаблоны задеплоены; три таймера включены и выполняются по расписанию.
- [x] В GitHub — workflow `etl_dispatch.yml` с `workflow_dispatch` и секретами.
- [x] Алерты в Telegram по фейлам и "пустым" витринам.
- [x] Документация: `docs/RUNBOOK_ETL.md`, обновления `docs/ARCHITECTURE.md`, `CHANGELOG.md`.
- [ ] Скриншоты: `journalctl` успешных прогонов; DataLens карточка мониторинга.

## Риски и меры

### Реализованные меры снижения рисков:

1. **Разъезд таймзон** - в systemd таймере явно указана `Europe/Moscow`
2. **Падение VK API** - ретраи должны быть реализованы на уровне `vk_ads_pipeline`
3. **Зависание мерджей CH** - не используются тяжёлые `OPTIMIZE FINAL` в рабочее окно
4. **Секреты** - хранение в `.env` для локальных запусков и в GitHub Secrets для CI

## Дальнейшие шаги

1. Деплой systemd таймеров на сервер
2. Настройка Telegram бота и добавление токена в `.env`
3. Создание датасета в DataLens для мониторинга `meta.etl_runs`
4. Тестирование полного цикла выполнения пайплайна
5. Настройка дополнительных алертов по аномалиям данных

## Заключение

Система оркестрации ETL полностью реализована в соответствии с требованиями EPIC-CH-04. Созданы все необходимые компоненты для надежного выполнения пайплайнов, мониторинга и алертирования. Система готова к развертыванию на сервере и дальнейшей эксплуатации.