# План подключения к DataLens, тестирования и передачи заказчику

## Обзор

Документ описывает пошаговый план подключения аналитического сервиса Zakaz Dashboard к Yandex DataLens, проведения тестирования и передачи системы заказчику.

## Предварительные условия

1. Сервер с ClickHouse развернут и доступен по HTTPS
2. Данные из источников (QTickets, VK Ads, Яндекс.Директ) загружаются в ClickHouse
3. Настроены systemd таймеры для автоматической загрузки данных
4. Система алертов и мониторинга работает

## Этап 1: Анализ текущего состояния системы

### 1.1 Проверка инфраструктуры

Выполнить проверку системы:
```bash
bash ops/system_check.sh
```

Проверить:
- [ ] ClickHouse доступен и работает
- [ ] HTTPS доступ через bi.zakaz-dashboard.ru
- [ ] Healthcheck сервер отвечает
- [ ] Таймеры systemd работают корректно
- [ ] Данные загружаются и свежие

### 1.2 Проверка данных в ClickHouse

Подключиться к ClickHouse и проверить:
```sql
-- Проверка наличия таблиц
SHOW TABLES FROM zakaz;

-- Проверка свежести данных
SELECT 
    'qtickets' as source,
    max(event_date) as latest_date,
    count() as total_rows
FROM zakaz.v_sales_latest

UNION ALL

SELECT 
    'vk_ads' as source,
    max(stat_date) as latest_date,
    count() as total_rows
FROM zakaz.fact_vk_ads_daily;

-- Проверка представлений для DataLens
SELECT count() FROM zakaz.v_sales_latest;
SELECT count() FROM zakaz.v_marketing_daily;
SELECT count() FROM zakaz.v_sales_14d;
SELECT count() FROM zakaz.fact_qtickets_sales_daily;
SELECT count() FROM zakaz.fact_qtickets_inventory_latest;
```

### 1.3 Проверка прав доступа

Проверить права пользователя datalens_reader:
```sql
-- Подключиться как datalens_reader
-- Проверить доступ к представлениям
SELECT count() FROM zakaz.v_sales_latest LIMIT 1;
SELECT count() FROM zakaz.v_marketing_daily LIMIT 1;
```

## Этап 2: Настройка подключения DataLens к ClickHouse

### 2.1 Создание подключения

1. Войти в DataLens: https://datalens.yandex.ru/
2. Перейти в раздел "Подключения"
3. Создать новое подключение → ClickHouse
4. Заполнить параметры:
   - **Хост**: `bi.zakaz-dashboard.ru`
   - **Порт**: `443`
   - **База данных**: `zakaz`
   - **Имя пользователя**: `datalens_reader`
   - **Пароль**: `DataLens2024!Strong#Pass`
   - **Использовать HTTPS**: ✅
5. Проверить подключение и сохранить с именем `ch_zakaz_prod`

### 2.2 Проверка подключения

Выполнить тестовые запросы в DataLens:
```sql
-- Базовая проверка
SELECT 1;

-- Проверка доступа к данным
SELECT count() FROM zakaz.v_sales_latest;
SELECT count() FROM zakaz.v_marketing_daily;
```

## Этап 3: Создание источников данных в DataLens

### 3.1 Источник данных "Sales"

1. В подключении `ch_zakaz_prod` создать источник данных → SQL
2. SQL-запрос:
```sql
SELECT
    event_date,
    city,
    event_name,
    tickets_sold,
    revenue,
    refunds_amount,
    (revenue - refunds_amount) AS net_revenue
FROM zakaz.v_sales_latest
```
3. Назвать источник: `src_ch_sales_latest`

### 3.2 Источник данных "Marketing"

1. Создать еще один источник данных → SQL
2. SQL-запрос:
```sql
SELECT
    d,
    city,
    spend_total,
    net_revenue,
    romi
FROM zakaz.v_marketing_daily
```
3. Назвать источник: `src_ch_marketing_daily`

### 3.3 Источник данных "Sales 14d"

1. Создать источник данных → SQL
2. SQL-запрос:
```sql
SELECT
    d AS event_date,
    city,
    tickets,
    net_revenue
FROM zakaz.v_sales_14d
```
3. Назвать источник: `src_ch_sales_14d`

## Этап 4: Создание датасетов в DataLens

### 4.1 Датасет "Sales"

1. На основе источника `src_ch_sales_latest` создать датасет
2. Настроить поля:
   - **Dimensions**:
     - `event_date` (Date)
     - `city` (String)
     - `event_name` (String)
   - **Measures**:
     - `tickets_sold` (SUM)
     - `revenue` (SUM)
     - `refunds_amount` (SUM)
     - `net_revenue` (SUM)
3. Вычисляемые поля:
   - `avg_ticket` = `revenue / nullIf(tickets_sold, 0)`
4. Назвать датасет: `ds_sales`

### 4.2 Датасет "Marketing"

1. На основе источника `src_ch_marketing_daily` создать датасет
2. Настроить поля:
   - **Dimensions**:
     - `d` (Date)
     - `city` (String)
   - **Measures**:
     - `spend_total` (SUM)
     - `net_revenue` (SUM)
     - `romi` (AVG)
3. Назвать датасет: `ds_marketing`

### 4.3 Датасет "Sales 14d"

1. На основе источника `src_ch_sales_14d` создать датасет
2. Настроить поля:
   - **Dimensions**:
     - `event_date` (Date)
     - `city` (String)
   - **Measures**:
     - `tickets` (SUM)
     - `net_revenue` (SUM)
3. Назвать датасет: `ds_sales_14d`

## Этап 5: Создание дашбордов в DataLens

### 5.1 Дашборд "Sales Overview"

1. Создать дашборд с названием "Zakaz: Продажи"
2. Добавить KPI-виджеты:
   - **Revenue**: `SUM(net_revenue)` за последние 7 дней
   - **Tickets**: `SUM(tickets_sold)` за последние 7 дней
   - **Avg Ticket**: `SUM(net_revenue)/SUM(tickets_sold)` за последние 7 дней
3. Добавить фильтры:
   - Период (диапазон дат)
   - Города (мультиселект)
4. Добавить графики:
   - Динамика выручки по дням (линия)
   - Топ городов по выручке (столбцы)
   - Детализация продаж (таблица)

### 5.2 Дашборд "Marketing ROI"

1. Создать дашборд с названием "Zakaz: Эффективность рекламы"
2. Добавить KPI-виджеты:
   - **ROAS**: `AVG(romi)` за период
   - **Spend**: `SUM(spend_total)` за период
   - **Revenue**: `SUM(net_revenue)` за период
3. Добавить фильтры:
   - Период (диапазон дат)
   - Города (мультиселект)
4. Добавить графики:
   - ROMI по городам (столбцы с цветовой индикацией)
   - Динамика Spend и Revenue (комбо-график)

### 5.3 Дашборд "Ops & Data Quality"

1. Создать дашборд с названием "Zakaz: Операционные метрики"
2. Добавить виджеты:
   - Свежесть данных по источникам
   - Статусы запусков загрузчиков
   - Алерты за последние 24 часа

## Этап 6: Настройка автообновления и оптимизация

### 6.1 Настройка автообновления

1. Для каждого датасета настроить автообновление:
   - **Интервал**: 15 минут
   - **Кэширование**: 10 минут
2. Для дашбордов настроить обновление:
   - **Интервал**: 15 минут
   - **Таймзона**: Europe/Moscow

### 6.2 Оптимизация производительности

1. Для быстрых графиков использовать датасет `ds_sales_14d`
2. Ограничить количество отображаемых городов в топах (Top-20)
3. Настроить лимиты выполнения запросов:
   - `max_execution_time = 30s`
   - `max_result_rows = 1e6`

## Этап 7: Комплексное тестирование

### 7.1 Функциональное тестирование

1. Проверить все дашборды:
   - [ ] Данные отображаются корректно
   - [ ] Фильтры работают правильно
   - [ ] Графики строятся без ошибок
   - [ ] KPI пересчитываются при изменении периода

2. Проверить обновление данных:
   - [ ] Новые данные появляются в дашбордах
   - [ ] Автообновление работает
   - [ ] Кэширование не мешает актуальности

### 7.2 Нагрузочное тестирование

1. Проверить производительность:
   - [ ] Дашборды загружаются менее 5 секунд
   - [ ] Графики строятся менее 10 секунд
   - [ ] Фильтры применяются менее 3 секунд

2. Проверить одновременную работу:
   - [ ] Несколько пользователей могут работать одновременно
   - [ ] Система не зависает при сложных запросах

### 7.3 Smoke-тестирование

Выполнить скрипт smoke-тестирования:
```bash
python3 ops/smoke_test_integrations.py --verbose
```

Проверить:
- [ ] Все тесты пройдены
- [ ] Нет критичных алертов
- [ ] Данные свежие (не старше 2 дней)

## Этап 8: Подготовка документации для передачи

### 8.1 Обновление документации

1. Обновить `ops/HANDOVER_PACKAGE.md`:
   - [ ] Добавить ссылки на дашборды DataLens
   - [ ] Обновить контакты и доступы
   - [ ] Добавить текущую версию системы

2. Создать `docs/DATALENS_USER_GUIDE.md`:
   - [ ] Инструкция по использованию дашбордов
   - [ ] Описание фильтров и графиков
   - [ ] Часто задаваемые вопросы

3. Обновить `docs/RUNBOOK_DATALENS.md`:
   - [ ] Добавить ID созданных дашбордов
   - [ ] Обновить SQL-запросы источников
   - [ ] Добавить troubleshooting guide

### 8.2 Создание инструкции для заказчика

Создать `docs/CUSTOMER_GUIDE.md`:
- [ ] Обзор системы и её возможностей
- [ ] Доступы к дашбордам
- [ ] Базовые сценарии использования
- [ ] Контакты для поддержки

### 8.3 Подготовка презентации

Создать `docs/DEMO_PRESENTATION.md`:
- [ ] Скриншоты дашбордов
- [ ] Описание ключевых метрик
- [ ] Демонстрация фильтров и взаимодействий

## Этап 9: Финальная проверка готовности

### 9.1 Проверка работоспособности системы

Выполнить полную проверку системы:
```bash
bash ops/system_check.sh
```

Проверить:
- [ ] Все компоненты работают
- [ ] Данные свежие
- [ ] Нет критичных алертов

### 9.2 Проверка бэкапов

Проверить наличие бэкапов:
```bash
docker exec ch-zakaz clickhouse-client --user=backup_user --password=Backup2024!Strong#Pass -q "
SELECT backup_name, status, ts FROM meta.backup_runs ORDER BY ts DESC LIMIT 5"
```

### 9.3 Проверка алертов

Проверить работу алертов:
- [ ] Email уведомления приходят
- [ ] Алерты записываются в базу
- [ ] Healthcheck работает

## Этап 10: Передача заказчику

### 10.1 Предоставление доступов

1. Создать учетные записи в DataLens для заказчика:
   - [ ] RomaVXION@yandex.ru (редактор)
   - [ ] ads-irsshow@yandex.ru (редактор)
2. Предоставить доступ к дашбордам
3. Настроить публичный доступ при необходимости

### 10.2 Демонстрация системы

1. Провести демонстрацию:
   - [ ] Показать все дашборды
   - [ ] Демонстрация работы фильтров
   - [ ] Показать обновление данных
2. Объяснить основные метрики и их значения

### 10.3 Обучение заказчика

1. Провести обучение:
   - [ ] Работа с дашбордами
   - [ ] Использование фильтров
   - [ ] Экспорт данных
   - [ ] Основные сценарии использования

### 10.4 Передача документации

Передать заказчику:
- [ ] Пакет передачи проекта (`ops/HANDOVER_PACKAGE.md`)
- [ ] Руководство пользователя (`docs/CUSTOMER_GUIDE.md`)
- [ ] Контакты для поддержки
- [ ] Доступы к системе

## Чек-лист готовности к передаче

### Инфраструктура
- [ ] ClickHouse работает и доступен по HTTPS
- [ ] Все таймеры systemd работают корректно
- [ ] Система алертов функционирует
- [ ] Бэкапы создаются регулярно

### Данные
- [ ] Данные из всех источников загружаются
- [ ] Данные свежие (не старше 2 дней)
- [ ] Представления для DataLens работают
- [ ] Нет дубликатов и ошибок в данных

### DataLens
- [ ] Подключение к ClickHouse настроено
- [ ] Все источники данных созданы
- [ ] Все датасеты созданы и настроены
- [ ] Все дашборды созданы и работают
- [ ] Автообновление настроено

### Тестирование
- [ ] Функциональное тестирование пройдено
- [ ] Нагрузочное тестирование пройдено
- [ ] Smoke-тестирование пройдено
- [ ] Все критичные ошибки исправлены

### Документация
- [ ] Вся документация обновлена
- [ ] Руководства для заказчика созданы
- [ ] Контакты поддержки предоставлены

## Контакты для поддержки

- **Техническая поддержка**: [контакт разработчика]
- **Вопросы по DataLens**: [контакт специалиста по BI]
- **Экстренные случаи**: [экстренный контакт]

## Следующие шаги после передачи

1. **Период поддержки**: 5 рабочих дней после передачи
2. **Мониторинг**: Ежедневная проверка работы системы
3. **Обратная связь**: Сбор отзывов от заказчика
4. **Улучшения**: Планирование дальнейшего развития системы

---

**Дата создания**: $(date +%Y-%m-%d)
**Версия**: 1.0.0
**Последнее обновление**: $(date +%Y-%m-%d)