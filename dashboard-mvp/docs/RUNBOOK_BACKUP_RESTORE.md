# RUNBOOK: Резервное копирование и восстановление ClickHouse

## Обзор

Этот документ описывает систему резервного копирования и восстановления ClickHouse, реализованную в рамках EPIC-CH-07.

## Архитектура бэкапов

### Типы бэкапов

1. **Полные бэкапы (full)**
   - Содержат все базы данных: zakaz, bi, meta
   - Выполняются ежедневно в 02:30 МСК
   - Хранятся 4 недели (28 дней)
   - Квартальные бэкапы хранятся 1 год

2. **Инкрементальные бэкапы (incr)**
   - Содержат только изменения с последнего полного бэкапа
   - Выполняются каждые 4 часа (00:30, 04:30, 08:30, 12:30, 16:30, 20:30 МСК)
   - Хранятся 7 дней

### Хранилища бэкапов

1. **S3-совместимое хранилище** (рекомендуется)
   - Надежное хранилище с георепликацией
   - Автоматическое управление жизненным циклом
   - Переменные окружения: `S3_BUCKET`, `S3_ACCESS_KEY`, `S3_SECRET_KEY`

2. **Локальное хранилище** (резервный вариант)
   - Директория: `/opt/clickhouse/backups`
   - Требует мониторинга свободного места
   - Переменная окружения: `BACKUP_DIR`

## Компоненты системы бэкапов

### Скрипты

1. **backup_full.sh** - создание полного бэкапа
2. **backup_incr.sh** - создание инкрементального бэкапа
3. **restore_test.sh** - тестовое восстановление
4. **backup_prune.sh** - очистка старых бэкапов
5. **backup_verify.py** - верификация бэкапов

### Systemd таймеры

1. **backup@full.timer** - ежедневный запуск полного бэкапа
2. **backup@incr.timer** - запуск инкрементальных бэкапов
3. **backup@prune.timer** - ежедневная очистка старых бэкапов

### Метаданные

1. **meta.backup_runs** - таблица с информацией о всех бэкапах
   - Имя бэкапа, тип, статус, размер, длительность
   - Используется для мониторинга и анализа

## Процедуры

### 1. Создание бэкапов

#### Полный бэкап вручную
```bash
# S3 режим
./ops/backup_full.sh s3

# Локальный режим
./ops/backup_full.sh local
```

#### Инкрементальный бэкап вручную
```bash
# S3 режим
./ops/backup_incr.sh s3

# Локальный режим
./ops/backup_incr.sh local
```

#### Проверка статуса бэкапов
```sql
-- Последние бэкапы
SELECT 
    backup_name,
    mode,
    status,
    bytes / 1024 / 1024 as size_mb,
    duration_ms / 1000 as duration_sec,
    ts
FROM meta.backup_runs
ORDER BY ts DESC
LIMIT 10;
```

### 2. Восстановление

#### Тестовое восстановление
```bash
# Восстановление последнего бэкапа
./ops/restore_test.sh

# Восстановление конкретного бэкапа
./ops/restore_test.sh chbk_20251011_023000_full s3
```

#### Полное восстановление (аварийный случай)
```bash
# Остановка ClickHouse
docker-compose stop clickhouse

# Очистка данных (ВНИМАНИЕ: все данные будут удалены)
rm -rf /opt/clickhouse/data/*

# Запуск ClickHouse
docker-compose start clickhouse

# Восстановление из бэкапа
docker exec ch-zakaz clickhouse-client --query "
    RESTORE DATABASE zakaz, DATABASE bi, DATABASE meta 
    FROM S3('bucket', 'access_key', 'secret_key', 'prefix=clickhouse-backups/') 
    AS 'chbk_20251011_023000_full'
"
```

### 3. Верификация бэкапов

#### Проверка всех бэкапов
```bash
# Полная верификация
./ops/backup_verify.py

# Проверка в формате JSON
./ops/backup_verify.py --json

# Проверка свежести (24 часа)
./ops/backup_verify.py --fresh-hours 24
```

#### Ручная проверка
```sql
-- Проверка наличия бэкапов за последние 7 дней
SELECT 
    mode,
    count() as backup_count,
    sum(bytes) / 1024 / 1024 as total_size_mb
FROM meta.backup_runs
WHERE status = 'ok'
  AND ts >= now() - INTERVAL 7 DAY
GROUP BY mode;
```

### 4. Очистка старых бэкапов

#### Ручная очистка
```bash
# S3 режим
./ops/backup_prune.sh s3

# Локальный режим
./ops/backup_prune.sh local
```

#### Настройка политики хранения
```bash
# В .env файле
FULL_RETENTION_DAYS=28      # Полные бэкапы: 4 недели
INCR_RETENTION_DAYS=7       # Инкрементальные: 7 дней
GOLDEN_RETENTION_MONTHS=12  # Золотые бэкапы: 1 год
```

## Мониторинг

### Метрики

1. **Свежесть бэкапов**
   - Время последнего успешного бэкапа
   - Пропущенные бэкапы

2. **Размер бэкапов**
   - Размер полных бэкапов
   - Размер инкрементальных бэкапов
   - Тенденции роста

3. **Длительность**
   - Время создания бэкапа
   - Время восстановления

### Алерты

1. **Отсутствие бэкапов**
   - Нет успешного полного бэкапа за 24 часа
   - Нет успешного инкрементального бэкапа за 6 часов

2. **Ошибки бэкапов**
   - Последний бэкап завершился с ошибкой
   - Много последовательных ошибок

3. **Проблемы с хранилищем**
   - Мало свободного места (локальное хранилище)
   - Проблемы с доступом к S3

### Дашборд в DataLens

1. **Статус бэкапов**
   - График успешных/неудачных бэкапов
   - Время последнего бэкапа

2. **Размеры и длительность**
   - График размеров бэкапов
   - График времени выполнения

3. **Проблемы**
   - Таблица с ошибками
   - Статистика по ошибкам

## Тестирование

### Еженедельное тестирование
```bash
# Автоматический тест восстановления
./ops/restore_test.sh

# Проверка результатов
./ops/backup_verify.py
```

### Ежемесячное тестирование
1. Полное восстановление на тестовый стенд
2. проверка данных после восстановления
3. Тестирование производительности
4. Обновление документации

### Квартальное тестирование
1. Тестирование восстановления из S3
2. Тестирование восстановления из локального хранилища
3. Проверка цепочки бэкапов
4. Тестирование в условиях стресса

## Устранение проблем

### Проблема: Бэкап не создается

#### Симптомы
- В логах ошибка создания бэкапа
- Статус 'fail' в meta.backup_runs

#### Диагностика
```bash
# Проверка логов
journalctl -u backup@full.service -n 50

# Проверка статуса
clickhouse-client --query "SELECT * FROM meta.backup_runs WHERE status = 'fail' ORDER BY ts DESC LIMIT 5"
```

#### Решения
1. **Недостаточно места**
   - Очистить старые бэкапы
   - Увеличить хранилище

2. **Проблемы с доступом**
   - Проверить учетные данные S3
   - Проверить права доступа

3. **Проблемы с ClickHouse**
   - Проверить доступность ClickHouse
   - Проверить права пользователя backup_user

### Проблема: Восстановление не работает

#### Симптомы
- Ошибка при восстановлении
- Неполные данные после восстановления

#### Диагностика
```bash
# Проверка целостности бэкапа
./ops/backup_verify.py --backup-name chbk_20251011_023000_full

# Тестовое восстановление
./ops/restore_test.sh chbk_20251011_023000_full
```

#### Решения
1. **Поврежденный бэкап**
   - Использовать предыдущий бэкап
   - Создать новый полный бэкап

2. **Проблемы с версией ClickHouse**
   - Использовать совместимую версию
   - Обновить ClickHouse

### Проблема: Медленные бэкапы

#### Симптомы
- Бэкапы выполняются дольше обычного
- Таймауты при создании бэкапа

#### Диагностика
```sql
-- Анализ производительности
SELECT 
    backup_name,
    duration_ms / 1000 as duration_sec,
    bytes / 1024 / 1024 as size_mb,
    bytes / duration_ms * 1000 as throughput_bytes_sec
FROM meta.backup_runs
ORDER BY ts DESC
LIMIT 10;
```

#### Решения
1. **Нагрузка на систему**
   - Перенести бэкапы на время меньшей нагрузки
   - Увеличить ресурсы

2. **Большой объем данных**
   - Использовать инкрементальные бэкапы
   - Оптимизировать структуру данных

## План аварийного восстановления

### RPO/RTO
- **RPO (Recovery Point Objective)**: ≤ 1 час
- **RTO (Recovery Time Objective)**: ≤ 2 часа

### Шаги восстановления

1. **Оценка ситуации** (5 минут)
   - Определить масштаб проблемы
   - Выбрать стратегию восстановления

2. **Подготовка к восстановлению** (15 минут)
   - Остановить приложение
   - Подготовить окружение

3. **Восстановление данных** (60-90 минут)
   - Восстановить из последнего бэкапа
   - Проверить целостность данных

4. **Тестирование** (15-30 минут)
   - Подключиться к данным
   - Проверить функциональность

5. **Запуск приложения** (5 минут)
   - Запустить сервисы
   - Мониторить работу

### Контакты в экстренной ситуации
- **DevOps дежурный**: +7-XXX-XXX-XX-XX
- **Инженер данных**: +7-XXX-XXX-XX-XX
- **Руководитель проекта**: +7-XXX-XXX-XX-XX

## Обновление системы

### Плановые обновления
1. Обновление скриптов бэкапа
2. Изменение политики хранения
3. Обновление конфигурации ClickHouse
4. Тестирование после обновления

### Процедура обновления
1. Создать бэкап перед обновлением
2. Применить изменения
3. Протестировать функциональность
4. Обновить документацию

## Заключение

Система резервного копирования и восстановления обеспечивает надежную защиту данных и позволяет быстро восстановить работоспособность системы в случае сбоя. Регулярное тестирование и мониторинг гарантируют readiness процедуры восстановления.