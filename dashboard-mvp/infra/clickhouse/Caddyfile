{
    email {$CADDY_EMAIL:-ops@example.com}
}

# Redirect plain HTTP requests for the production hostname to HTTPS.
{$CADDY_DOMAIN:-bi.localhost} {
    redir https://{$CADDY_DOMAIN:-bi.localhost}{uri}
}

# Forward HTTPS traffic to the ClickHouse HTTP endpoint.
{$CADDY_DOMAIN:-bi.localhost}:443 {
    reverse_proxy clickhouse:8123 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Local development HTTP endpoint (no TLS).
localhost:8080 {
    reverse_proxy clickhouse:8123 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
    }
}

# Local development HTTPS endpoint using the internal CA.
localhost:8443 {
    tls internal
    reverse_proxy clickhouse:8123 {
        header_up Host {host}
        header_up X-Real-IP {remote}
        header_up X-Forwarded-For {remote}
        header_up X-Forwarded-Proto {scheme}
    }
}
