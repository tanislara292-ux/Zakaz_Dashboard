# Инструкции по выполнению E2E тестирования QTickets API на сервере museshow

## Обзор

Все необходимые файлы для E2E тестирования QTickets API подготовлены и зафиксированы в git. Теперь нужно выполнить тестирование на сервере museshow.

## Что было сделано

1. ✅ Создан скрипт автоматического тестирования `e2e_qtickets_api_test.sh`
2. ✅ Подготовлена подробная инструкция `E2E_QTICKETS_API_INSTRUCTIONS.md`
3. ✅ Создан шаблон отчёта `TASK-QT-API-E2E-REPORT.md`
4. ✅ Добавлен README с описанием процесса `README_E2E_QTICKETS_API.md`
5. ✅ Обновлён healthcheck для поддержки командной строки
6. ✅ Все изменения зафиксированы в git

## План выполнения на сервере

### Шаг 1. Подключение к серверу

```bash
ssh etl@museshow
# или
ssh root@museshow
```

### Шаг 2. Обновление кода

```bash
cd /opt/zakaz_dashboard/dashboard-mvp
git pull origin main
```

### Шаг 3. Запуск E2E тестирования

```bash
chmod +x e2e_qtickets_api_test.sh
./e2e_qtickets_api_test.sh
```

### Шаг 4. Анализ результатов

После выполнения скрипта будет создан отчёт `TASK-QT-API-E2E-REPORT.md` с результатами тестирования.

## Ожидаемые результаты

Если тестирование пройдёт успешно, отчёт будет содержать:

- ✅ Миграция применена без ошибок
- ✅ Лоадер успешно загрузил данные из QTickets API
- ✅ Данные присутствуют в ClickHouse таблицах
- ✅ Healthcheck показывает статус `ok`
- ✅ Systemd сервис корректно настроен и работает
- ✅ Smoke-проверки качества данных пройдены

## Возможные проблемы и решения

### Проблема: Ошибка прав доступа

**Симптом:** `ACCESS_DENIED: User etl_writer doesn't have permission`

**Решение:** Скрипт автоматически предоставит необходимые права, но если проблема осталась:
```sql
GRANT INSERT ON zakaz.* TO etl_writer
```

### Проблема: Контейнеры не запущены

**Симптом:** Статус контейнеров не `Up`

**Решение:** Скрипт автоматически запустит контейнеры, но если нужно вручную:
```bash
cd /opt/zakaz_dashboard/dashboard-mvp/infra/clickhouse
docker compose up -d
```

### Проблема: Ошибки в витрине v_sales_latest

**Симптом:** SQL ошибка при запросе к витрине

**Решение:** Проверить синтаксис CREATE VIEW в миграции и при необходимости исправить:
```sql
DROP VIEW IF EXISTS zakaz.v_sales_latest;
-- Исправленный CREATE VIEW...
```

## Критерии готовности к выкладке

Пайплайн считается готовым к выкладке если:

1. Миграция применена без ошибок
2. Лоадер успешно загрузил данные из QTickets API
3. Данные присутствуют в ClickHouse таблицах
4. Healthcheck показывает статус `ok`
5. Systemd сервис корректно настроен и работает
6. Smoke-проверки качества данных пройдены

## Следующие шаги после успешного тестирования

1. Зафиксировать результаты в git:
   ```bash
   git add TASK-QT-API-E2E-REPORT.md
   git commit -m "feat: E2E тестирование QTickets API пройдено успешно"
   ```

2. Подготовить план развертывания на сервере заказчика

3. Выполнить развертывание на проде заказчика

## Контакты для поддержки

При возникновении проблем:
1. Проверьте логи выполнения скрипта
2. Ознакомьтесь с разделом "Возможные проблемы" в `E2E_QTICKETS_API_INSTRUCTIONS.md`
3. Обратитесь к документации в `docs/`
4. Проверьте актуальные требования в `PROTOCOL.md`

---
**Важно:** Все файлы подготовлены и готовы к выполнению на сервере. Скрипт `e2e_qtickets_api_test.sh` выполнит все необходимые шаги автоматически и сгенерирует подробный отчёт о результатах.