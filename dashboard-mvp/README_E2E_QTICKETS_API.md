# E2E Тестирование QTickets API

## Обзор

Этот документ описывает подготовку и выполнение сквозного тестирования пайплайна QTickets API перед выкладкой на прод клиента.

## Структура файлов

### Основные файлы

1. **`e2e_qtickets_api_test.sh`** - Основной скрипт автоматического тестирования
   - Выполняет все шаги E2E тестирования
   - Генерирует подробный отчёт о результатах
   - Проверяет готовность пайплайна к выкладке

2. **`E2E_QTICKETS_API_INSTRUCTIONS.md`** - Подробная инструкция по запуску
   - Описание каждого шага тестирования
   - Команды для ручного выполнения
   - Решение возможных проблем

3. **`TASK-QT-API-E2E-REPORT.md`** - Шаблон отчёта о результатах тестирования
   - Заполняется автоматически скриптом
   - Содержит все результаты проверок
   - Включает финальное заключение о готовности

### Компоненты пайплайна

1. **Интеграция QTickets API**
   - `integrations/qtickets_api/loader.py` - Основной лоадер
   - `integrations/qtickets_api/client.py` - Клиент API
   - `integrations/qtickets_api/config.py` - Конфигурация

2. **Миграции ClickHouse**
   - `infra/clickhouse/migrations/2025-qtickets-api.sql` - Создание таблиц

3. **Проверки качества данных**
   - `infra/clickhouse/smoke_checks_qtickets_api.sql` - Smoke-проверки

4. **Мониторинг**
   - `ops/healthcheck_integrations.py` - Healthcheck с поддержкой qtickets_api
   - `ops/systemd/qtickets_api.service` - Systemd сервис
   - `ops/systemd/qtickets_api.timer` - Systemd таймер

## Быстрый старт

Для запуска полного E2E тестирования на сервере museshow:

```bash
# Подключение к серверу
ssh etl@museshow

# Переход в директорию проекта
cd /opt/zakaz_dashboard/dashboard-mvp

# Запуск тестирования
chmod +x e2e_qtickets_api_test.sh
./e2e_qtickets_api_test.sh
```

После выполнения будет создан отчёт `TASK-QT-API-E2E-REPORT.md` с результатами.

## Что проверяет E2E тестирование

### 1. Окружение
- Статус контейнеров ClickHouse
- Доступность необходимых портов

### 2. База данных
- Применение миграции без ошибок
- Создание всех необходимых таблиц
- Права доступа для пользователя etl_writer

### 3. Загрузка данных
- Подключение к QTickets API
- Получение реальных данных о продажах
- Загрузка данных в ClickHouse

### 4. Качество данных
- Наличие данных в staging таблицах
- Корректность агрегации в fact таблицах
- Работоспособность витрин

### 5. Метаданные
- Запись информации о запусках в meta_job_runs
- Корректность статусов и метрик

### 6. Мониторинг
- Работоспособность healthcheck
- Корректность определения свежести данных

### 7. Автоматизация
- Настройка systemd сервисов
- Корректная работа таймеров
- Проверка логов выполнения

### 8. Smoke-проверки
- Отсутствие отрицательных значений
- Свежесть данных
- Целостность таблиц

## Критерии успеха

Пайплайн считается готовым к выкладке если:

1. ✅ Миграция применена без ошибок
2. ✅ Лоадер успешно загрузил данные из QTickets API
3. ✅ Данные присутствуют в ClickHouse таблицах
4. ✅ Healthcheck показывает статус `ok`
5. ✅ Systemd сервис корректно настроен и работает
6. ✅ Smoke-проверки качества данных пройдены

## Возможные проблемы

### Ошибки прав доступа
```
ACCESS_DENIED: User etl_writer doesn't have permission
```
**Решение:** Предоставить права на вставку в таблицы:
```sql
GRANT INSERT ON zakaz.* TO etl_writer
```

### Ошибки в витринах
```
Code: 62. DB::Exception: Missing columns
```
**Решение:** Проверить и исправить CREATE VIEW в миграции

### Проблемы с API
```
ConnectionError: Failed to establish connection
```
**Решение:** Проверить токен и доступность QTickets API

## Следующие шаги после успешного тестирования

1. Зафиксировать результаты в git
2. Подготовить план развертывания у заказчика
3. Выполнить развертывание на проде
4. Настроить мониторинг в проде

## Поддержка

При возникновении проблем:
1. Проверьте логи выполнения скрипта
2. Ознакомьтесь с разделом "Возможные проблемы"
3. Обратитесь к документации в `docs/`
4. Проверьте актуальные требования в `PROTOCOL.md`