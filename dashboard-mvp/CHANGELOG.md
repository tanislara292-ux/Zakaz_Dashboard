# Changelog

## [1.0.0] - 2025-10-12
### EPIC-INT-ALL: Сквозная интеграция (Gmail/QTickets/VK/Direct → ClickHouse → DataLens) + запуск по расписанию
- Реализована полнофункциональная сквозная интеграция всех источников данных.
- Создан единый модуль `integrations/common/` с утилитами для всех загрузчиков.
- Реализованы загрузчики для QTickets API, VK Ads API, Яндекс.Директ API.
- Обновлен Gmail инжестор как резервный канал для QTickets.
- Созданы systemd таймеры для автоматического запуска всех загрузчиков.
- Настроена система мониторинга и алертинга с email уведомлениями.
- Создан HTTP healthcheck сервер для внешнего мониторинга.
- Реализована нормализация UTM-меток формата `<city>_<dd>_<mm>`.
- Обеспечена идемпотентность всех загрузчиков через `ReplacingMergeTree`.
- Созданы smoke-проверки для контроля качества данных интеграций.
- Обновлена архитектура и документация для отражения новой структуры.

### Added
- `integrations/` - единый каталог для всех загрузчиков данных:
  - `integrations/common/` - общие утилиты (CH, время, UTM, логирование)
  - `integrations/qtickets/` - загрузчик QTickets API
  - `integrations/vk_ads/` - загрузчик VK Ads API
  - `integrations/direct/` - загрузчик Яндекс.Директ API
  - `integrations/gmail/` - резервный канал Gmail
- `integrations/common/ch.py` - клиент ClickHouse с retry и TLS
- `integrations/common/time.py` - утилиты для работы с таймзоной MSK
- `integrations/common/utm.py` - парсер UTM-меток формата `<city>_<dd>_<mm>`
- `integrations/common/logging.py` - структурированное логирование с метриками
- `infra/clickhouse/init_integrations.sql` - DDL для таблиц интеграций и витрин
- `infra/clickhouse/smoke_checks_integrations.sql` - проверки качества данных интеграций
- `ops/alerts/notify.py` - система алертов с email уведомлениями
- `ops/healthcheck_integrations.py` - HTTP healthcheck сервер
- `ops/systemd/` - systemd таймеры для всех загрузчиков и алертов
- `configs/.env.*.sample` - шаблоны конфигурационных файлов
- `docs/RUNBOOK_INTEGRATIONS.md` - руководство по управлению интеграциями

### Changed
- Полностью переработана архитектура системы интеграций.
- Унифицированы все загрузчики под общую структуру и интерфейсы.
- Обновлены DDL для оптимизации хранения и анализа данных.
- Улучшена обработка UTM-меток с автоматическим парсингом города.
- Обновлена система мониторинга с healthcheck эндпоинтами.
- Усилена система алертов с сохранением в БД.

### Fixed
- Исправлены проблемы с дубликатами данных через `ReplacingMergeTree`.
- Устранены проблемы с обработкой временных зон (MSK по умолчанию).
- Улучшена обработка ошибок во всех загрузчиках.

### Security
- Все секреты вынесены в отдельный каталог `secrets/` (в .gitignore).
- Переменные окружения загружаются из защищенных файлов.
- Усилено логирование без вывода конфиденциальной информации.
- Настроены ролевые права доступа к ClickHouse.

## [0.9.0] - 2025-10-11
- Полная декомиссия Google Sheets и переход на ClickHouse как единственное хранилище данных.
- Система резервного копирования ClickHouse с полными и инкрементальными бэкапами.
- Автоматическая очистка старых бэкапов с политикой хранения (4 недели для полных, 7 дней для инкрементальных).
- Тестовое восстановление бэкапов в изолированном контейнере с верификацией данных.
- Усиление безопасности ClickHouse: RBAC, сетевой периметр, аудит, логирование.
- Systemd таймеры для автоматического запуска бэкапов (полные ежедневно в 02:30, инкрементальные каждые 4 часа).
- Disaster Runbook с процедурами восстановления и планом аварийного восстановления (RPO ≤ 1 час, RTO ≤ 2 часа).
- Таблица `meta.backup_runs` для логирования всех операций бэкапа.
- Документация: `DECOMMISSION_SHEETS.md`, `RUNBOOK_HARDENING.md`, `RUNBOOK_BACKUP_RESTORE.md`, `DISASTER_RUNBOOK.md`.
- Обновлена архитектура: удалены все зависимости от Google Sheets.

### Changed
- Полный переход на ClickHouse как единственное хранилище данных.
- Обновлена архитектура и все runbooks для отражения новой архитектуры.
- Улучшена производительность и надежность системы.

### Deprecated
- Все компоненты Google Sheets (перемещены в `archive/`).

### Removed
- `appscript/` - Apps Script для QTickets API.
- `schemas/sheets/` - схемы листов Google Sheets.
- `tools/sheets_init.py` и `tools/sheets_validate.py` - утилиты для Google Sheets.
- `ch-python/loader/sheets_to_ch.py` - загрузчик из Sheets в ClickHouse.
- `vk-python/src/vk_ads_pipeline/sheets.py` - запись в Google Sheets.
- Все переменные окружения для Google Sheets.

### Security
- Введена ролевая модель доступа (RBAC) с пользователями: admin, etl_writer, datalens_reader, backup_user.
- Ограничен сетевой доступ к ClickHouse: только localhost для прямых подключений.
- Включен аудит и логирование всех запросов с ретеншеном 30 дней.
- Усилены требования к паролям (минимум 12 символов, сложность).
- Настроены квоты и лимиты ресурсов для разных ролей.

## [0.8.0] - 2025-10-11
### EPIC-CH-05: DataLens BI-пакет на ClickHouse
- Создан BI-слой в новой схеме `bi` с оптимизированными представлениями для DataLens.
- Добавлены представления:
  - `bi.v_sales_daily` - продажи с канонизацией городов
  - `bi.v_vk_ads_daily` - маркетинговые метрики по городам/дате
  - `bi.v_marketing_roi_daily` - join продаж и расходов (ROAS, CPC, CPT)
  - `bi.v_ops_freshness` - свежесть и последние прогонки из `meta.*`
- Создана структура репозитория `bi/` для BI-пакета:
  - `datasets/` - спецификации полей/калькуляций (yaml)
  - `dashboards/` - макеты и описания виджетов (md)
  - `exports/` - выгрузки из DataLens (json, id)
- Подготовлены спецификации датасетов:
  - `ds_sales_daily.yaml` - продажи с вычисляемыми полями
  - `ds_vk_ads_daily.yaml` - маркетинговые метрики с CTR, CPC, CPM
  - `ds_roi_daily.yaml` - ROI метрики с прибылью и конверсией
  - `ds_ops_freshness.yaml` - мониторинг свежести данных
- Созданы макеты 4 дашбордов:
  - `sales_overview.md` - обзор продаж с фильтрами и KPI
  - `marketing_roi.md` - анализ эффективности маркетинга
  - `city_performance.md` - производительность по городам
  - `ops_data_quality.md` - мониторинг качества данных
- Обновлен `docs/RUNBOOK_DATALENS.md` с разделом "BI-Package".
- Настроены права доступа для BI-слоя: `GRANT SELECT ON bi.* TO datalens_reader`.
- Оптимизированы запросы без `FINAL` для быстрой работы в DataLens.
- Фиксирована таймзона MSK для всех визуализаций.

## [0.7.0] - 2025-10-11
- Реализованы инкрементальные CDC-загрузки из QTickets и VK Ads API.
- Добавлены near-real-time обновления витрин `dm_sales_daily` и `dm_vk_ads_daily`.
- Созданы водяные знаки (watermarks) для отслеживания прогресса загрузки в `meta.watermarks`.
- Добавлены стейджинг-таблицы `stg_sales_events` и `stg_vk_ads_daily` с `ReplacingMergeTree`.
- Реализованы инкрементальные билдеры `build_dm_sales_incr.py` и `build_dm_vk_incr.py`.
- Создан SLI/SLO мониторинг качества данных в реальном времени.
- Добавлены systemd таймеры для NRT-циклов с интервалом 10 минут.
- Реализованы алерты в Telegram при нарушении SLO через `slo_guard.py`.
- Создана таблица `meta.sli_daily` для хранения SLI показателей.
- Добавлено представление `meta.v_sli_latest` для мониторинга.
- Создан RUNBOOK для CDC/NRT (`docs/RUNBOOK_CDC_NRT.md`).
- Обеспечена идемпотентность операций через `_ver` и `ReplacingMergeTree`.
- Обеспечена корректная обработка UPSERT/DELETE операций.
- Расширены переменные окружения для NRT настроек.

## [0.6.0] - 2025-10-11
- Реализована оркестрация ETL-процессов через systemd таймеры с шаблонами сервисов.
- Добавлен реестр прогонов `meta.etl_runs` и реестр алертов `meta.etl_alerts` в ClickHouse.
- Созданы единые точки входа для запуска job'ов: `ops/run_job.sh`, `ops/alert_notify.py`, `ops/healthcheck.py`.
- Реализован backfill-сценарий `ops/backfill.py` для пересборки данных за произвольный период.
- Настроен GitHub Actions workflow `etl_dispatch.yml` для ручных запусков и резервного выполнения.
- Добавлена система алертов в Telegram при сбоях и аномалиях в данных.
- Создана подробная документация `docs/RUNBOOK_ETL.md` по оркестрации и мониторингу.

## [0.5.0] - 2025-10-11
- Реализованы материализованные витрины `dm_sales_daily` и `dm_vk_ads_daily` для улучшения производительности запросов.
- Добавлен справочник `dim_city_alias` для канонизации названий городов.
- Создано сводное представление `v_marketing_roi_daily` с метриками ROAS, CPC, CPT.
- Реализована интеграция VK Ads → ClickHouse с поддержкой параметра `--sink clickhouse`.
- Добавлены команды CLI `build-dm-sales` и `build-dm-vk` для построения витрин.
- Обновлена документация RUNBOOK_DATALENS.md с инструкциями по переходу на материализованные витрины.
- Добавлены smoke-проверки для контроля качества данных в новых витринах.

## [0.4.0] - 2025-10-11
- Настроен HTTPS-доступ к ClickHouse через реверс-прокси Caddy для подключения DataLens.
- Созданы представления `v_sales_latest` и `v_sales_14d` для BI-слоя без дубликатов данных.
- Добавлен Caddyfile для автоматической настройки TLS с Let's Encrypt.
- Обновлены права доступа для пользователя `datalens_reader` с опциональным ограничением только к BI-слою.
- Создана подробная документация RUNBOOK_DATALENS.md с инструкциями по подключению и настройке.
- Подготовлена инфраструктура для создания датасета Sales и MVP-дашборда в DataLens.

## [0.3.0] - 2025-10-11
- Добавлена инфраструктура ClickHouse (single-node) через Docker Compose.
- Созданы таблицы `stg_qtickets_sales`, `stg_vk_ads_daily`, `core_sales_fct` с движками ReplacingMergeTree/MergeTree.
- Реализован Python-лоадер для загрузки данных из Google Sheets в ClickHouse с дедупликацией.
- Добавлены пользователи `etl_writer` (INSERT/SELECT) и `datalens_reader` (SELECT) с разграничением прав.
- Созданы smoke-проверки SQL для контроля качества данных.
- Обновлена архитектура и документация с описанием потоков данных в ClickHouse.
- Добавлен ADR-0001 с описанием стратегии перехода на ClickHouse.

## [0.2.0] - 2025-10-05
- Добавлен Python-сервис `vk-ads-pipeline` (интеграция VK Ads → Google Sheets) с CLI и юнит-тестами.
- Расширена документация: архитектура, коммуникации, scope/contract, риски, доступы.
- Обновлён README, добавлено описание структуры проекта и инструкций.
- Актуализирован чек-лист DoR/DoD, шаблоны писем и кик-офф.

## [0.1.0] - 2025-09-30
- Инициализация репозитория и базовых шаблонов.
