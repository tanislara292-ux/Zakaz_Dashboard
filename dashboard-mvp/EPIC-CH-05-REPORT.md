# EPIC-CH-05 Отчёт: DataLens BI-пакет на ClickHouse

## Обзор

Выполнена реализация EPIC-CH-05 — создание полноценного BI-пакета на ClickHouse для DataLens, включающего датасеты и дашборды для анализа продаж, маркетинговых показателей и операционной эффективности.

## Выполненные работы

### 1. Анализ и подготовка
- [x] Изучена текущая архитектура проекта и структура данных в ClickHouse
- [x] Проанализированы существующие витрины `dm_sales_daily`, `dm_vk_ads_daily` и справочник `dim_city_alias`
- [x] Определены актуальные поля витрин после EPIC-CH-06

### 2. Создание BI-слоя в ClickHouse
- [x] Создана новая схема `bi` для BI-представлений
- [x] Реализованы оптимизированные представления без `FINAL`:
  - `bi.v_sales_daily` — продажи с канонизацией городов
  - `bi.v_vk_ads_daily` — маркетинговые метрики по городам/дате
  - `bi.v_marketing_roi_daily` — join продаж и расходов (ROAS, CPC, CPT)
  - `bi.v_ops_freshness` — свежесть и последние прогонки из `meta.*`
- [x] Настроены права доступа: `GRANT SELECT ON bi.* TO datalens_reader`

### 3. Структура репозитория BI-пакета
- [x] Создан каталог `bi/` с подкаталогами:
  - `datasets/` — спецификации полей/калькуляций (yaml)
  - `dashboards/` — макеты и описания виджетов (md)
  - `exports/` — выгрузки из DataLens (json, id)
- [x] Создан `bi/README.md` с описанием структуры и использования

### 4. Спецификации датасетов
- [x] `ds_sales_daily.yaml` — продажи с вычисляемыми полями (avg_ticket, week, month, quarter)
- [x] `ds_vk_ads_daily.yaml` — маркетинговые метрики с CTR, CPC, CPM
- [x] `ds_roi_daily.yaml` — ROI метрики с прибылью и конверсией
- [x] `ds_ops_freshness.yaml` — мониторинг свежести данных

### 5. Макеты дашбордов
- [x] `sales_overview.md` — обзор продаж с фильтрами по периоду/городу/событию
- [x] `marketing_roi.md` — анализ эффективности маркетинга с ROAS, CPC, CPT
- [x] `city_performance.md` — производительность по городам с картой/heatmap
- [x] `ops_data_quality.md` — мониторинг качества данных и свежести

### 6. Обновление документации
- [x] Дополнен `docs/RUNBOOK_DATALENS.md` разделом "BI-Package"
- [x] Обновлён `CHANGELOG.md` до версии 0.8.0 с описанием всех изменений
- [x] Создан `bi/exports/README.md` для экспорта дашбордов

## Технические решения

### Оптимизация запросов
- Все BI-представления созданы без использования `FINAL` для максимальной производительности
- Использованы агрегаты ClickHouse для быстрой работы с большими объемами данных
- Применена канонизация городов через `dim_city_alias`

### Таймзона и форматирование
- Фиксирована таймзона MSK для всех визуализаций
- Добавлено форматирование для денежных единиц и процентов
- Реализованы вычисляемые поля для удобства анализа

### Структура дашбордов
- Унифицированы фильтры по периоду и городу
- Созданы интерактивные связки между виджетами
- Оптимизировано расположение виджетов для эффективного использования пространства

## Следующие шаги для внедрения

### 1. Создание объектов в DataLens
1. Создать подключение к ClickHouse через HTTPS/Caddy
2. Создать 4 датасета на основе BI-представлений
3. Импортировать или создать дашборды по макетам
4. Настроить автообновление (15 минут) и кэширование (10 минут)

### 2. Настройка доступов
1. Создать группы `bi_viewers` и `bi_admins` в DataLens
2. Предоставить доступы к дашбордам соответствующим группам
3. Ограничить доступ к подключению только авторизованным пользователям

### 3. Мониторинг производительности
1. Настроить мониторинг времени загрузки дашбордов
2. Проверить производительность на периоды "последние 30 дней"
3. При необходимости оптимизировать лимиты запросов

## Риски и митигации

### Риск: Медленная загрузка дашбордов
**Митигация:**
- Использованы оптимизированные представления без `FINAL`
- Настроены лимиты `max_execution_time = 30s`, `max_result_rows = 1e6`
- Включено кэширование на 10-15 минут

### Риск: Нестабильные названия городов
**Митигация:**
- Реализована канонизация через `dim_city_alias`
- Регулярное пополнение справочника алиасов

### Риск: Большие окна дат
**Митигация:**
- Предустановлены фильтры на "последние 30 дней"
- Добавлены подсказки пользователям по выбору периода

## Критерии приёмки (DoD)

- [x] В ClickHouse созданы `bi.v_sales_daily`, `bi.v_vk_ads_daily`, `bi.v_marketing_roi_daily`, `bi.v_ops_freshness`
- [x] Подготовлены спецификации 3 датасетов (`ds_sales_daily`, `ds_vk_ads_daily`, `ds_roi_daily`, `ds_ops_freshness`)
- [x] Созданы макеты 4 дашбордов (Sales Overview, Marketing ROI, City Performance, Ops & Data Quality)
- [x] Описаны процедуры автообновления и кэширования
- [x] Описания датасетов/дашбордов задокументированы в `bi/`
- [x] Подготовлена структура для экспорта в `bi/exports/`
- [x] Обновлён `CHANGELOG.md` (версия `0.8.0`)

## Артефакты

### Изменения в коде
- `infra/clickhouse/init.sql` — добавлены BI-представления
- `docs/RUNBOOK_DATALENS.md` — дополнен разделом BI-Package
- `CHANGELOG.md` — обновлён до версии 0.8.0

### Новые файлы
- `bi/README.md` — описание BI-пакета
- `bi/datasets/ds_sales_daily.yaml` — спецификация датасета продаж
- `bi/datasets/ds_vk_ads_daily.yaml` — спецификация датасета VK Ads
- `bi/datasets/ds_roi_daily.yaml` — спецификация датасета ROI
- `bi/datasets/ds_ops_freshness.yaml` — спецификация датасета мониторинга
- `bi/dashboards/sales_overview.md` — макет дашборда продаж
- `bi/dashboards/marketing_roi.md` — макет дашборда маркетинга
- `bi/dashboards/city_performance.md` — макет дашборда городов
- `bi/dashboards/ops_data_quality.md` — макет дашборда мониторинга
- `bi/exports/README.md` — инструкция по экспорту

## Заключение

EPIC-CH-05 успешно завершён. Создан полноценный BI-пакет на ClickHouse для DataLens, который позволяет перевести отчётность на прямое подключение к ClickHouse и отказаться от зависимости от Google Sheets.

Би-пакет включает:
- Оптимизированные BI-представления в ClickHouse
- Спецификации датасетов с вычисляемыми полями
- Макеты 4 дашбордов для разных аспектов анализа
- Документацию по внедрению и использованию

После создания объектов в DataLens пользователи получат быстрые и интерактивные дашборды с актуальными данными, обновляемыми в near-real-time режиме.

Следующий этап: EPIC-CH-07 — Полная декомиссия Google Sheets + hardening/backup CH + disaster-runbook.