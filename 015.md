Задача: Починить автоматическое развёртывание ClickHouse + DataLens

Проблема / симптомы

Базовый сценарий bootstrap_clickhouse.sh поднимает контейнер, но ClickHouse падает в healthcheck со статусом unhealthy.
В логах: Code: 36. DB::Exception: You can't specify grantees in query using config file — при разборе users.d/datalens-user.xml.
При попытке docker exec … clickhouse-client -q "GRANT SELECT ON zakaz.* TO datalens_reader" получаем ACCESS_DENIED, потому что bundled-админ работает с <access_management>0.
В каталоге users.d/ две конкурирующие секции datalens_reader: одна в datalens-user.xml, другая в 10-users.xml, с разными паролями и сетевыми ограничениями.
bootstrap_grants.sql содержит CREATE USER и большой список GRANT-ов, которые не могут выполниться с текущими правами.
Цель

После git clone → cp .env.example .env → scripts/bootstrap_clickhouse.sh ClickHouse должен стартовать (healthy), табличная схема должна быть в полном объёме.
Администратор по умолчанию (admin/admin_pass) должен уметь выполнять GRANT SELECT ON zakaz.* TO datalens_reader без дополнительных правок.
DataLens‑учётка должна создаваться автоматически, без конфликтов, и иметь read-only доступ к zakaz.* после единственного GRANT-а.
Документация и шаблонные скрипты должны описывать рабочий процесс как “копипасту”, без ручного редактирования XML на клиентском сервере.
Требования к решению

Конфигурация пользователей ClickHouse

В dashboard-mvp/infra/clickhouse/users.d/default-user.xml установить <access_management>1</access_management> для admin.
dashboard-mvp/infra/clickhouse/users.d/datalens-user.xml привести к валидному виду:
оставить только блок <password> / <profile> / <quota> / <networks>.
добавить комментарий о необходимости смены пароля через ALTER USER ….
Удалить дубль datalens_reader из dashboard-mvp/infra/clickhouse/users.d/10-users.xml (или перенести весь файл из боевой инфраструктуры за пределы MVP; оставить только реально нужное).
Проверить, что в users.d/ отсутствуют другие конфликтующие определения (etl_writer, backup_user — по необходимости, но без пересечений по именам).
Скрипт bootstrap_grants.sql

Очистить от CREATE USER и других команд, которые не подразумеваются к запуску обычным админом.
Оставить минимальный набор GRANT … для datalens_reader, etl_writer, backup_user (если эти пользователи остаются), который действительно выполняется штатным admin-ом.
Протестировать, что docker exec -i ch-zakaz … < bootstrap_grants.sql успешно отрабатывает после bootstrap_clickhouse.sh.
Автоматический скрипт bootstrap_clickhouse.sh

Убедиться, что после правок скрипт проходит end-to-end:
контейнер стартует и переходит в healthy (healthcheck не падает),
схема накатывается,
проверка обязательных таблиц проходит.
При необходимости добавить валидацию на наличие дублирующихся users-конфигов или вывод предупреждений.
README и верхнеуровневый гайд

Обновить dashboard-mvp/infra/clickhouse/README.md и основной dashboard-mvp/README.md:
описать единый сценарий развёртывания без “ручных nano-правок”,
явно указать, где лежит DataLens user, как поменять пароль, как применить bootstrap_grants.sql,
привести копипаст‑готовый набор команд (bootstrap → smoke → GRANT → curl).
Проверить, что все команды из README выполняются без ошибок на чистой машине.
Smoke-тест

Запустить scripts/smoke_qtickets_dryrun.sh на чистом окружении после bootstrap. Скрипт должен отработать (контейнер успешно завершится, без записей в meta_job_runs).
Зафиксировать, что docker exec … --user=datalens_reader … "SELECT count()" возвращает корректное число таблиц.
Через curl проверить HTTP-доступ к ClickHouse (127.0.0.1 и публичный IP – по инструкции).
Верификация и отчёт

Приложить к задаче:
вывод docker inspect -f '{{.State.Health.Status}}' ch-zakaz → healthy;
логи docker exec … SHOW TABLES FROM zakaz;
результат docker exec … GRANT SELECT … (без ошибок);
результат docker exec … SELECT count() … под datalens_reader;
curl -u datalens_reader:… "http://127.0.0.1:8123/?query=SELECT%201" и (при открытом порте) curl на публичный IP;
вывод scripts/smoke_qtickets_dryrun.sh.
Обновить changelog/аудит, если используется.
Ожидаемый итог

Репозиторий на чистой машине поднимает ClickHouse и DataLens-доступ без ручных модификаций XML или SQL.
Админ и DataLens учётки работают согласно документации.
Все инструкции в README соответствуют реально работающему процессу.
Клиентская команда может повторить git pull → cp .env.example → scripts/bootstrap_clickhouse.sh → scripts/smoke_qtickets_dryrun.sh → (опционально) docker exec … bootstrap_grants.sql и сразу переходить к настройке DataLens в UI.
Перед закрытием задачи разработчик должен предоставить логи/скрины, подтверждающие прохождение всех шагов.