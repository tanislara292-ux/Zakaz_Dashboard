# ПОЛНОЕ РУКОВОДСТВО ПО ПОДКЛЮЧЕНИЮ YANAS DETALENS

## Обзор

Данное руководство описывает пошаговый процесс подключения Yandex DataLens к развернутой системе Zakaz Dashboard. Включает создание подключения, источников данных, датасетов и дашбордов.

## Предварительные требования

### Требования к системе

- ✅ **ClickHouse** развернут и доступен по HTTPS
- ✅ **Данные** загружаются в базу данных
- ✅ **Пользователь datalens_reader** создан и имеет права
- ✅ **HTTPS доступ** настроен через домен

### Проверка готовности

```bash
# Проверка доступности ClickHouse
curl -k -u "datalens_reader:ChangeMe123!" \
     "https://bi.zakaz-dashboard.ru/?query=SELECT%201"

# Проверка наличия данных
curl -k -u "datalens_reader:ChangeMe123!" \
     "https://bi.zakaz-dashboard.ru/?query=SELECT%20count()%20FROM%20zakaz.v_qtickets_sales_latest"
```

---

## ЭТАП 1: СОЗДАНИЕ ПОДКЛЮЧЕНИЯ В DATALENS

### 1.1 Вход в DataLens

1. Откройте браузер и перейдите: https://datalens.yandex.ru/
2. Войдите с помощью Яндекс ID
3. Если у вас нет рабочей области, создайте новую

### 1.2 Создание подключения к ClickHouse

1. В левом меню выберите **"Подключения"**
2. Нажмите **"Создать подключение"**
3. Выберите **"ClickHouse"** из списка

### 1.3 Настройка параметров подключения

Заполните форму следующими параметрами:

| Параметр | Значение | Описание |
|-----------|----------|----------|
| **Хост** | `bi.zakaz-dashboard.ru` | Ваш домен |
| **Порт** | `443` | HTTPS порт |
| **База данных** | `zakaz` | Имя БД |
| **Имя пользователя** | `datalens_reader` | Пользователь для чтения |
| **Пароль** | `ChangeMe123!` | Пароль пользователя |
| **Использовать HTTPS** | ✅ | Обязательно |
| **HTTP-метод** | `POST` | Рекомендуется |

### 1.4 Проверка подключения

1. Нажмите **"Проверить подключение"**
2. Должно появиться сообщение **"Подключение успешно"**
3. Нажмите **"Создать"** и сохраните подключение с именем `ch_zakaz_prod`

---

## ЭТАП 2: СОЗДАНИЕ ИСТОЧНИКОВ ДАННЫХ

### 2.1 Источник данных "Продажи QTickets"

1. В созданном подключении `ch_zakaz_prod` нажмите **"Создать источник"**
2. Выберите **"SQL"**
3. Введите SQL-запрос:

```sql
SELECT
    event_date,
    city,
    event_id,
    event_name,
    tickets_sold,
    revenue,
    refunds_amount,
    (revenue - refunds_amount) AS net_revenue,
    currency
FROM zakaz.v_qtickets_sales_latest
WHERE event_date >= today() - INTERVAL 90 DAY
ORDER BY event_date DESC
```

4. Нажмите **"Проверить"** - должно показать количество строк
5. Сохраните источник с именем `src_qtickets_sales`

### 2.2 Источник данных "Маркетинг"

1. Создайте еще один источник на основе того же подключения
2. SQL-запрос:

```sql
SELECT
    d AS event_date,
    city,
    spend_total,
    net_revenue,
    romi,
    CASE 
        WHEN romi > 1.5 THEN 'Отлично'
        WHEN romi >= 1 AND romi <= 1.5 THEN 'Хорошо'
        WHEN romi < 1 THEN 'Плохо'
    END AS romi_status
FROM zakaz.v_marketing_daily
WHERE d >= today() - INTERVAL 90 DAY
ORDER BY d DESC
```

3. Сохраните источник с именем `src_marketing_daily`

### 2.3 Источник данных "Инвентарь"

1. Создайте источник для данных инвентаря
2. SQL-запрос:

```sql
SELECT
    event_id,
    event_name,
    city,
    tickets_total,
    tickets_left,
    (tickets_total - tickets_left) AS tickets_sold,
    ROUND((tickets_total - tickets_left) * 100.0 / tickets_total, 2) AS sold_percentage
FROM zakaz.v_qtickets_inventory
WHERE tickets_total > 0
ORDER BY event_name, city
```

3. Сохраните источник с именем `src_inventory`

### 2.4 Источник данных "Свежесть данных"

1. Создайте источник для мониторинга свежести данных
2. SQL-запрос:

```sql
SELECT
    source,
    table_name,
    latest_date,
    days_behind,
    total_rows,
    CASE 
        WHEN days_behind <= 1 THEN '✅ Свежие'
        WHEN days_behind <= 3 THEN '⚠️ Устаревают'
        ELSE '❌ Устарели'
    END AS status
FROM zakaz.v_qtickets_freshness
ORDER BY days_behind ASC
```

3. Сохраните источник с именем `src_data_freshness`

---

## ЭТАП 3: СОЗДАНИЕ ДАТАСЕТОВ

### 3.1 Датасет "Продажи"

1. На основе источника `src_qtickets_sales` создайте датасет
2. Настройте поля:

#### Измерения (Dimensions)
- `event_date` (тип: Дата, формат: ГГГГ-ММ-ДД)
- `city` (тип: Строка)
- `event_name` (тип: Строка)
- `currency` (тип: Строка)

#### Метрики (Measures)
- `tickets_sold` (агрегация: SUM)
- `revenue` (агрегация: SUM)
- `refunds_amount` (агрегация: SUM)
- `net_revenue` (агрегация: SUM)

#### Вычисляемые поля
```sql
avg_ticket = revenue / tickets_sold
refund_rate = refunds_amount / revenue * 100
```

3. Сохраните датасет с именем `ds_sales`

### 3.2 Датасет "Маркетинг"

1. На основе источника `src_marketing_daily` создайте датасет
2. Настройте поля:

#### Измерения
- `event_date` (тип: Дата)
- `city` (тип: Строка)
- `romi_status` (тип: Строка)

#### Метрики
- `spend_total` (агрегация: SUM)
- `net_revenue` (агрегация: SUM)
- `romi` (агрегация: AVG)

3. Сохраните датасет с именем `ds_marketing`

### 3.3 Датасет "Инвентарь"

1. На основе источника `src_inventory` создайте датасет
2. Настройте поля:

#### Измерения
- `event_id` (тип: Строка)
- `event_name` (тип: Строка)
- `city` (тип: Строка)

#### Метрики
- `tickets_total` (агрегация: SUM)
- `tickets_left` (агрегация: SUM)
- `tickets_sold` (агрегация: SUM)
- `sold_percentage` (агрегация: AVG)

3. Сохраните датасет с именем `ds_inventory`

---

## ЭТАП 4: СОЗДАНИЕ ДАШБОРДОВ

### 4.1 Дашборд "Обзор продаж"

1. Создайте новый дашборд с названием **"Zakaz: Продажи"**
2. Добавьте виджеты:

#### KPI-виджеты (верхний ряд)
- **Выручка за период**: `SUM(net_revenue)` из `ds_sales`
- **Билетов продано**: `SUM(tickets_sold)` из `ds_sales`
- **Средний чек**: `SUM(net_revenue) / SUM(tickets_sold)` из `ds_sales`
- **Возвратов**: `SUM(refunds_amount)` из `ds_sales`

#### График "Динамика продаж"
- Тип: **Линейный график**
- X: `event_date` из `ds_sales`
- Y: `net_revenue` из `ds_sales`
- Группировка: По дням
- Фильтр: Последние 30 дней

#### График "Продажи по городам"
- Тип: **Столбчатая диаграмма**
- X: `city` из `ds_sales`
- Y: `net_revenue` из `ds_sales`
- Сортировка: По убыванию выручки
- Лимит: Топ-10 городов

#### Таблица "Детализация продаж"
- Поля: `event_date`, `event_name`, `city`, `tickets_sold`, `net_revenue`
- Сортировка: По дате убывания
- Пагинация: 20 строк

#### Фильтры
- **Период**: Диапазон дат (по умолчанию: последние 30 дней)
- **Города**: Мультиселект
- **Мероприятия**: Мультиселект

### 4.2 Дашборд "Эффективность маркетинга"

1. Создайте дашборд **"Zakaz: ROMI и реклама"**
2. Добавьте виджеты:

#### KPI-виджеты
- **Общий ROMI**: `AVG(romi)` из `ds_marketing`
- **Расходы на рекламу**: `SUM(spend_total)` из `ds_marketing`
- **Доход с рекламы**: `SUM(net_revenue)` из `ds_marketing`
- **ROAS**: `SUM(net_revenue) / SUM(spend_total)` из `ds_marketing`

#### График "ROMI по городам"
- Тип: **Столбчатая диаграмма с цветовой индикацией**
- X: `city` из `ds_marketing`
- Y: `romi` из `ds_marketing`
- Цвет: По полю `romi_status`
- Пороги: <1 (красный), 1-1.5 (желтый), >1.5 (зеленый)

#### График "Динамика расходов и доходов"
- Тип: **Комбо-график**
- X: `event_date` из `ds_marketing`
- Y1: `spend_total` (столбцы)
- Y2: `net_revenue` (линия)
- Период: Последние 60 дней

#### Таблица "Эффективность по городам"
- Поля: `city`, `spend_total`, `net_revenue`, `romi`, `romi_status`
- Сортировка: По ROMI убыванию

### 4.3 Дашборд "Инвентарь и доступность"

1. Создайте дашборд **"Zakaz: Инвентарь"**
2. Добавьте виджеты:

#### KPI-виджеты
- **Всего мероприятий**: `COUNT(DISTINCT event_id)` из `ds_inventory`
- **Всего билетов**: `SUM(tickets_total)` из `ds_inventory`
- **Продано билетов**: `SUM(tickets_sold)` из `ds_inventory`
- **Осталось билетов**: `SUM(tickets_left)` из `ds_inventory`

#### График "Заполненность по городам"
- Тип: **Круговая диаграмма**
- Измерение: `city` из `ds_inventory`
- Метрика: `tickets_sold` из `ds_inventory`

#### Таблица "Статус мероприятий"
- Поля: `event_name`, `city`, `tickets_total`, `tickets_left`, `sold_percentage`
- Условное форматирование: `sold_percentage`
  - >80%: зеленый
  - 50-80%: желтый
  - <50%: красный

### 4.4 Дашборд "Операционный мониторинг"

1. Создайте дашборд **"Zakaz: Мониторинг системы"**
2. Добавьте виджеты:

#### Таблица "Свежесть данных"
- Источник: `src_data_freshness`
- Поля: `source`, `table_name`, `latest_date`, `days_behind`, `status`
- Условное форматирование: `status`

#### Индикатор "Статус системы"
- Тип: **Индикатор**
- Логика: Если все источники свежие → "Зеленый", иначе "Красный"

---

## ЭТАП 5: НАСТРОЙКА АВТООБНОВЛЕНИЯ

### 5.1 Настройка обновления датасетов

1. Откройте каждый датасет (`ds_sales`, `ds_marketing`, `ds_inventory`)
2. Перейдите в **"Настройки"** → **"Обновление"**
3. Установите параметры:
   - **Интервал обновления**: 15 минут
   - **Кэширование**: 10 минут
   - **Часовой пояс**: Europe/Moscow

### 5.2 Настройка обновления дашбордов

1. Откройте каждый дашборд
2. Нажмите **"Настройки дашборда"**
3. Установите автообновление:
   - **Интервал**: 15 минут
   - **Включить**: ✅

---

## ЭТАП 6: НАСТРОЙКА ДОСТУПОВ

### 6.1 Предоставление доступа команде

1. В DataLens перейдите в **"Рабочая область"** → **"Участники"**
2. Добавьте пользователей:
   - `RomaVXION@yandex.ru` (редактор)
   - `ads-irsshow@yandex.ru` (редактор)

### 6.2 Настройка прав доступа

Для каждого пользователя установите права:
- **Просмотр**: Все дашборды
- **Редактирование**: Дашборды продаж и маркетинга
- **Администрирование**: Только для технического специалиста

### 6.3 Публичный доступ (опционально)

1. Откройте дашборд
2. Нажмите **"Поделиться"** → **"Публичная ссылка"**
3. Установите права: **"Только просмотр"**
4. Скопируйте ссылку для передачи заказчику

---

## ЭТАП 7: ТЕСТИРОВАНИЕ И ПРОВЕРКА

### 7.1 Функциональное тестирование

```bash
# Проверка загрузки новых данных
docker exec ch-zakaz clickhouse-client --user=admin --password='ВАШ_ПАРОЛЬ' -q "
INSERT INTO zakaz.stg_qtickets_api_orders_raw 
VALUES 
    ('test_order_001', 'event_001', 'moscow', now(), 5, 2500.0, 'RUB', 1, 'test_key', now())"

# Проверка появления в DataLens (через 15 минут)
```

### 7.2 Проверка производительности

1. Откройте каждый дашборд
2. Замерьте время загрузки:
   - Дашборд должен загружаться < 5 секунд
   - Графики должны строиться < 10 секунд
   - Фильтры должны применяться < 3 секунд

### 7.3 Нагрузочное тестирование

1. Откройте несколько дашбордов в разных вкладках
2. Примените фильтры одновременно
3. Проверьте, что система не зависает

---

## ТРАБЛШУТИНГ

### Проблема: "Ошибка подключения к ClickHouse"

**Решение**:
1. Проверьте доступность домена:
   ```bash
   curl -k https://bi.zakaz-dashboard.ru/?query=SELECT%201
   ```

2. Проверьте права пользователя:
   ```bash
   docker exec ch-zakaz clickhouse-client --user=admin --password='ВАШ_ПАРОЛЬ' -q "
   SHOW GRANTS FOR datalens_reader"
   ```

3. Проверьте сетевой доступ:
   ```bash
   telnet bi.zakaz-dashboard.ru 443
   ```

### Проблема: "Данные не обновляются"

**Решение**:
1. Проверьте свежесть данных в ClickHouse
2. Проверьте настройки автообновления датасета
3. Проверьте, что таймеры работают:
   ```bash
   systemctl list-timers | grep zakaz
   ```

### Проблема: "Медленная загрузка дашбордов"

**Решение**:
1. Оптимизируйте SQL-запросы источников
2. Уменьшите период по умолчанию
3. Используйте агрегированные данные для быстрых графиков

### Проблема: "Некорректные данные в графиках"

**Решение**:
1. Проверьте SQL-запросы источников
2. Проверьте типы полей в датасетах
3. Проверьте фильтры и группировку

---

## ОПТИМИЗАЦИЯ

### Рекомендации по производительности

1. **Используйте ограничения** в SQL-запросах:
   ```sql
   WHERE event_date >= today() - INTERVAL 90 DAY
   ```

2. **Оптимизируйте типы данных**:
   - Используйте `LowCardinality(String)` для строк с малым количеством уникальных значений
   - Используйте `Date` вместо `DateTime` когда точность до секунд не нужна

3. **Настройте индексы** в ClickHouse для часто используемых полей

### Мониторинг производительности

```sql
-- Запросы с наибольшим временем выполнения
SELECT 
    query,
    execution_time,
    read_rows,
    result_rows
FROM system.query_log 
WHERE query LIKE '%zakaz.%' 
  AND event_date >= today() - INTERVAL 1 DAY
ORDER BY execution_time DESC 
LIMIT 10
```

---

## БЕЗОПАСНОСТЬ

### Рекомендации по безопасности

1. **Используйте HTTPS** для всех подключений
2. **Ограничьте права** пользователя datalens_reader только на чтение
3. **Регулярно обновляйте** пароли
4. **Используйте VPN** для доступа к административным функциям

### Аудит доступа

```sql
-- Проверка запросов к DataLens
SELECT 
    user,
    query,
    execution_time,
    read_rows
FROM system.query_log 
WHERE user = 'datalens_reader' 
  AND event_date >= today() - INTERVAL 7 DAY
ORDER BY event_time DESC
```

---

## ЗАВЕРШЕНИЕ НАСТРОЙКИ

После выполнения всех шагов:

1. ✅ **Подключение** к ClickHouse создано и работает
2. ✅ **Источники данных** созданы с корректными SQL-запросами
3. ✅ **Датасеты** настроены с правильными типами полей
4. ✅ **Дашборды** созданы и отображают данные
5. ✅ **Автообновление** настроено и работает
6. ✅ **Доступы** предоставлены команде

### Передача заказчику

1. Предоставьте ссылки на дашборды
2. Проведите обучение работе с системой
3. Передайте документацию
4. Настройте поддержку

---

## КОНТАКТЫ ПОДДЕРЖКИ

- **Техническая поддержка**: [контакт разработчика]
- **Вопросы по DataLens**: [контакт специалиста по BI]
- **Экстренные случаи**: [экстренный контакт]

---

**Версия документа**: 1.0.0  
**Дата создания**: $(date +%Y-%m-%d)  
**Последнее обновление**: $(date +%Y-%m-%d)