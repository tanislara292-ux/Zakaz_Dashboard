# Task 003 – Привести ClickHouse схему к рабочему состоянию (dim_events + freshness view)

## Повод
При повторном bootstrap на сервере возникает ошибка:
Code: 47. DB::Exception: Unknown expression or function identifier 'start_date' …
CREATE OR REPLACE VIEW zakaz.v_qtickets_freshness AS …


Причина — представление `zakaz.v_qtickets_freshness` обращается к полям `start_date`/`end_date`,
которые не созданы в `zakaz.dim_events` в используемом SQL-файле (аналогично нужно проверить
`fact_qtickets_inventory`).

## Цель
Синхронизировать таблицы и вьюхи так, чтобы bootstrap схема проходил без ошибок, а smoke-тесты
Qtickets/VK по-прежнему проходили.

## Подзадачи

| № | Что сделать | Детали / Команды |
|---|-------------|------------------|
| 1 | **Проанализировать текущие определения таблиц** | `bootstrap_schema.sql`, `bootstrap_all.sql`, `init.sql`. Убедиться, что `dim_events` и `fact_qtickets_inventory` содержат все поля, на которые ссылаются вьюхи (`start_date`, `end_date`, `_loaded_at` и т.д.). |
| 2 | **Привести DDL к единой схеме** | Обновить `CREATE TABLE` блоки: добавить отсутствующие поля; убрать дубли. Все изменения внести во все исполненные файлы (schema/all/init). |
| 3 | **Согласовать вьюхи** | Проверить `v_qtickets_freshness`, `v_qtickets_sales_dashboard`, `bi.*` и т.п. Исправить SELECT так, чтобы все поля реально существовали. |
| 4 | **Повторно прогнать bootstrap дважды** | `dashboard-mvp/scripts/bootstrap_clickhouse.sh` на свежем контейнере → повторный запуск на том же контейнере. Должно пройти без ошибок. |
| 5 | **Smoke-тест Qtickets** | `dashboard-mvp/scripts/smoke_qtickets_dryrun.sh --env-file dashboard-mvp/test_env/.env.template` |
| 6 | **Проверка VK** | `cd dashboard-mvp/vk-python && python -m pytest` |
| 7 | **Запустить CI-пайплайн локально или в GitHub Actions** | Убедиться, что все стадии из `.github/workflows/ci.yml` проходят. |
| 8 | **Обновить документацию и отчёт** | README (`infra/clickhouse`), `ZAKAZ_DASHBOARD_AUDIT_REPORT.md` — зафиксировать успешный результат. |

## Definition of Done

- Все `CREATE TABLE …` содержат необходимые поля; вьюхи не обращаются к несуществующим колонкам.
- `bootstrap_clickhouse.sh` проходит дважды подряд на чистом ClickHouse 24.8.
- Smoke Qtickets (`DRY_RUN`) завершился успешно.
- `python -m pytest` в `vk-python` зелёный.
- `scripts/validate_clickhouse_schema.py` → “Schema validation passed”.
- CI Workflow (`.github/workflows/ci.yml`) зелёный.
- Документация и `ZAKAZ_DASHBOARD_AUDIT_REPORT.md` обновлены.

## Контрольные команды

```bash
python scripts/validate_clickhouse_schema.py
dashboard-mvp/scripts/bootstrap_clickhouse.sh
dashboard-mvp/scripts/bootstrap_clickhouse.sh   # второй запуск
dashboard-mvp/scripts/smoke_qtickets_dryrun.sh --env-file dashboard-mvp/test_env/.env.template
cd dashboard-mvp/vk-python && python -m pytest
По итогам — один (или серия) коммитов, которые синхронизируют схему и подтверждают прохождение всех проверок.
