# Task 002 – Завершение подготовки Zakaz_Dashboard к production

## Цель
Довести инфраструктуру и интеграции до состояния, когда проект:
1. Успешно bootstrap-ится и перезапускается без ошибок.
2. Проходит smoke-тесты (ClickHouse + Qtickets).
3. Имеет проверяемые в CI сборки/тесты.
4. Документирован и не содержит «серых зон».

## Основные блоки работ

### 1. ClickHouse schema & скрипты
- Удалить дублирование таблицы `zakaz.stg_vk_ads_daily` в `bootstrap_schema.sql`/`bootstrap_all.sql`.
- Проверить, что каждая таблица создаётся **один раз** и `ALTER` выполняются только после `CREATE`.
- Регулярно протестировать двойной запуск `scripts/bootstrap_clickhouse.sh` (на пустом инстансе и без сброса данных).
- Завершить smoke-тест (`smoke_qtickets_dryrun.sh`).

**DoD (ClickHouse)**
- Все DDL файлы создают таблицы ровно один раз.
- `bootstrap_clickhouse.sh` отрабатывает дважды подряд без ошибок.
- Smoke-тест завершается кодом 0.
- `scripts/validate_clickhouse_schema.py` → «Schema validation passed».

### 2. Qtickets integration
- Выполнить `docker build` для Qtickets.
- Запустить smoke dry-run со свежим `.env` из `dashboard-mvp/test_env/.env.template`.
- Обновить README по интеграции.

**DoD (Qtickets)**
- Docker build успешен.
- Smoke dry-run (с шаблонным env) завершается без ошибок.
- README описывает сборку, запуск (DRY_RUN / prod) и переменные окружения.

### 3. VK Ads
- `python -m pytest` в `dashboard-mvp/vk-python` должен пройти.
- При необходимости добавить шаблоны env/mocks.
- Сверить, что DDL соответствует коду (`_loaded_at`, `currency`, прочие поля).

**DoD (VK)**
- Pytest зелёный.
- DDL ↔ код ↔ вьюхи синхронизированы.
- Документация по запуску тестов и конфигурации обновлена.

### 4. CI/CD pipeline
- Добавить стадии в CI (GitLab/GitHub):
  1. `validate_clickhouse_schema.py`
  2. `python -m compileall dashboard-mvp`
  3. `cd dashboard-mvp/vk-python && python -m pytest`
  4. `docker build --no-cache ...`
  5. (Опционально) smoke stage с ClickHouse 24.8
- Завести разработческий чеклист (в README/CONTRIBUTING).

**DoD (CI)**
- Пайплайн включает обязательные стадии и публикацию артефактов.
- Smoke stage задокументирован и, по возможности, выполняется.
- Чеклист разработчика описан в репозитории.

### 5. Документация и отчётность
- Обновить `infra/clickhouse/README.md`, `CI_RECOMMENDATIONS.md`.
- Поддерживать `ZAKAZ_DASHBOARD_AUDIT_REPORT.md` актуальным (отразить запуск smoke).
- Обновить `dashboard-mvp/test_env/.env.template`, если появились новые переменные.

**DoD (Docs)**
- Все README отражают реальные инструкции.
- Аудит-отчёт содержит свежие результаты.
- Env-шаблоны и рекомендации актуальны и проверены.

## Последовательность действий
1. **Schema Fix** – устранение дублирующихся `CREATE`, финальный double-bootstrap + smoke.
2. **Tests** – Docker build, `pytest`, smoke dry-run.
3. **CI** – конфигурация стадий, чеклист.
4. **Документация** – README, отчёты, шаблоны env.
5. Финальный прогон и фиксация результатов в `ZAKAZ_DASHBOARD_AUDIT_REPORT.md`.

## Приёмка
Работа принята, когда:
- В CI есть стадии: validator, compileall, pytest, docker, (smoke/optional).
- CLI-скрипты (`bootstrap_clickhouse.sh`, `smoke_qtickets_dryrun.sh`) выполняются без ошибок.
- Документация и отчёт обновлены.
- Все шаги отражены в финальном аудите.

