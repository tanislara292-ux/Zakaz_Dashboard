Task 010 — Production Run Evidence Bundle
Цель
Собрать полный пакет доказательств, что боевой прогон qtickets_api отрабатывает штатно: собрать и заархивировать логи, сохранить ключевые выводы команд, зафиксировать результаты в changelog и итоговом отчёте.

Что нужно сделать (пошагово)
1. Подготовить каталог для артефактов
Перейти в корень репозитория:
cd /opt/zakaz_dashboard/Zakaz_Dashboard
Создать папку для этой задачи (например, logs/task010):
mkdir -p logs/task010
2. Собрать сырые логи ClickHouse
Сохранить серверные логи:

docker exec ch-zakaz tail -n 500 /var/log/clickhouse-server/clickhouse-server.log \
  > logs/task010/clickhouse-server.log

docker exec ch-zakaz tail -n 200 /var/log/clickhouse-server/clickhouse-server.err.log \
  > logs/task010/clickhouse-server.err.log
Сохранить текстовый лог (ошибки):

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT event_time, logger_name, level, message
    FROM system.text_log
    WHERE event_time >= now() - INTERVAL 30 MINUTE
    ORDER BY event_time DESC
    LIMIT 200
    FORMAT Vertical;
  " > logs/task010/clickhouse_text_log.txt
Сохранить query_log (только последние записи):

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT event_time, type, query, exception_code, exception
    FROM system.query_log
    WHERE event_time >= now() - INTERVAL 30 MINUTE
    ORDER BY event_time DESC
    LIMIT 200
    FORMAT Vertical;
  " > logs/task010/clickhouse_query_log.txt
3. Собрать логи запуска qtickets_api
Запустить ingestion (если нужно) и сохранить вывод:

docker run --rm \
  --network clickhouse_default \
  --env-file /opt/zakaz_dashboard/secrets/.env.qtickets_api \
  --name qtickets_api_run_$(date +%Y%m%d%H%M%S) \
  qtickets_api:prod | tee logs/task010/qtickets_run.log
Если лог уже был, можно копировать его из docker logs:

docker logs qtickets_api_run_<timestamp> > logs/task010/qtickets_run.log
4. Сохранить результаты проверочных запросов
Максимальная дата/количество заказов:

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT max(sale_ts) AS last_order_ts,
           count() AS orders_loaded
    FROM zakaz.stg_qtickets_api_orders_raw;
  " > logs/task010/orders_check.txt
Логи job runs:

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT job, status, started_at, finished_at, rows_processed, message
    FROM zakaz.meta_job_runs
    WHERE job = 'qtickets_api'
    ORDER BY started_at DESC
    LIMIT 10;
  " > logs/task010/meta_job_runs.txt
(Опционально) Проверить агрегаты:

docker exec ch-zakaz clickhouse-client \
  --user=admin --password=admin_pass \
  -q "
    SELECT max(snapshot_ts) AS last_inventory_ts,
           count() AS inventory_rows
    FROM zakaz.stg_qtickets_api_inventory_raw;
  " > logs/task010/inventory_check.txt
5. Финальная проверка HTTP подключения
Сохранить команды, подтверждающие доступ HTTP:

curl -s -u admin:admin_pass "http://127.0.0.1:8123/?query=SELECT%201" \
  > logs/task010/http_check_host.txt

docker run --rm --network clickhouse_default curlimages/curl:8.4.0 \
  curl -sS -u admin:admin_pass "http://ch-zakaz:8123/?query=SELECT%201" \
  > logs/task010/http_check_docker.txt
6. Подготовить наружный отчёт
Создать docs/changelog/CHANGELOG-010.md (или дополнить CHANGELOG-009.md, если договорено):

Краткое описание задаче: что было сделано, какие логи и проверки приложены.
Шаги и результаты (со ссылками на файлы в logs/task010).
Зафиксировать найденные проблемы (если есть) и их статус.
Обновить ZAKAZ_DASHBOARD_AUDIT_REPORT.md:

Добавить раздел “Task 010 — Production Run Evidence” с перечислением команд и путей к логам.
Подготовить краткий summary (консоль или отдельный файл) с ключевыми выводами:

HTTP доступ: OK/FAIL
Запуск ingestion: OK/FAIL
Количество загруженных заказов
meta_job_runs статус
Список логов.
7. Архив и git
При необходимости упаковать всё в архив:

tar -czf logs/task010_bundle.tgz logs/task010
Проверить git status, убедиться, что новые файлы (logs/task010/*, CHANGELOG-010.md, обновления отчёта) добавлены.

Закоммитить:

git add logs/task010 CHANGELOG-010.md ZAKAZ_DASHBOARD_AUDIT_REPORT.md
git commit -m "Task 010: production run evidence bundle"
Definition of Done
Папка logs/task010 содержит все перечисленные материалы.
В CHANGELOG-010.md и ZAKAZ_DASHBOARD_AUDIT_REPORT.md документированы шаги, ключевые результаты и ссылки на логи.
Подтверждено: HTTP интерфейс работает и из host, и из Docker; ingestion прошёл; данные в staging и meta_job_runs.
Изменения закоммичены (или подготовлены для PR).
После выполнения задачи предоставить ссылку на changelog/отчёт + перечень логов (каталог logs/task010).