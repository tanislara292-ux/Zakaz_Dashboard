Task 005 — ClickHouse & Integrations Production Hardening

Goal
Deliver a single, deterministic ClickHouse schema and aligned integration stack (Qtickets, VK) that bootstraps cleanly, passes smoke/tests, and has reproducible documentation/CI support.

Background
Recent bootstrap runs still fail (Unknown expression 'start_date') because multiple CREATE TABLE definitions for zakaz.dim_events and related objects coexist across SQL files. Old schemas (with event_date) continue to override the new canonical structure (start_date, end_date, _loaded_at, _ver). Task 004 was reported complete, but repository state proves otherwise; production deploy remains unsafe.

Current Findings
dashboard-mvp/infra/clickhouse/bootstrap_schema.sql contains several CREATE TABLE IF NOT EXISTS zakaz.dim_events blocks with conflicting schemas.
Similar duplicates exist in bootstrap_all.sql, init.sql, init_qtickets_sheets.sql, and dated migrations.
Some dependent tables/views (fact_qtickets_inventory, fact_qtickets_inventory_latest, stg_vk_ads_daily, v_qtickets_freshness, etc.) still reference old column sets.
Bootstrap script fails before schema finishes; smoke tests and validator were not rerun on the latest code.
Documentation (ADR, changelog) claims success not reflected in code.
Tasks
1. Canonicalize ClickHouse Schema
1.1 Identify all DDL locations (bootstrap_schema.sql, bootstrap_all.sql, init*.sql, migrations/*, other SQL scripts).
1.2 For each object (dim_events, stg_vk_ads_daily, fact_qtickets_inventory, fact_qtickets_inventory_latest, views/materialized views, dictionaries):

Retain exactly one canonical CREATE definition aligned with the latest domain model (start_date, end_date, _loaded_at, _ver, LowCardinality types, TTL, etc.).
Remove/replace obsolete or conflicting definitions.
Where recreation is required, insert DROP TABLE/VIEW IF EXISTS … before the canonical CREATE to guarantee correct structure on bootstrap.
1.3 Ensure CREATE blocks include all necessary columns so that no immediate ALTER commands are required post-creation. Reserve ALTER only for optional evolution and ensure target objects exist before altering.
2. Align Dependent Objects
2.1 Update all views/materialized views using canonical columns (v_qtickets_freshness, v_qtickets_sales_dashboard, vt/bi views, etc.).
2.2 Verify downstream objects (aggregation tables, dictionaries, dictionary sources) still compile after schema changes.
2.3 Confirm all TTL, PARTITION BY, ORDER BY clauses are deterministic.

3. Clean Supporting Scripts
3.1 Update bootstrap scripts (bootstrap_schema.sql, bootstrap_all.sql, init*.sql) to reference only canonical definitions.
3.2 Ensure .sql files remain UTF-8 without BOM and contain idempotent statements.
3.3 Check scripts/bootstrap_clickhouse.sh still functions with the updated schema; adjust messaging if object list changes.

4. Run Full Validation Suite
4.1 Fresh bootstrap: wipe ClickHouse volumes, run scripts/bootstrap_clickhouse.sh; capture output.
4.2 Repeat bootstrap without wiping data; confirm idempotency.
4.3 Execute scripts/smoke_qtickets_dryrun.sh --env-file <path>; ensure exit code 0 and no entries in zakaz.meta_job_runs.
4.4 Run python -m pytest under dashboard-mvp/vk-python.
4.5 Run python scripts/validate_clickhouse_schema.py.
4.6 Review .github/workflows/ci.yml (or equivalent) to ensure pipeline covers validator, compileall, pytest, docker build, smoke (if enabled). Update if schema changes require adjustments.

5. Documentation & Reporting
5.1 Update relevant docs (infra/clickhouse/README.md, integrations/qtickets_api/README.md, dashboard-mvp/CONTRIBUTING.md, whichever mention schema).
5.2 Record outcomes and evidence (commands + status) in ZAKAZ_DASHBOARD_AUDIT_REPORT.md.
5.3 Create or update changelog entry (e.g., docs/changelog/CHANGELOG-004.md).
5.4 If architectural decision differs from previous ADRs, create/update ADR (e.g., docs/adr/ADR-005.md).

Definition of Done
Only one canonical definition per ClickHouse object across all SQL sources.
bootstrap_clickhouse.sh succeeds twice consecutively (fresh + reapply).
scripts/smoke_qtickets_dryrun.sh succeeds with exit code 0; zakaz.meta_job_runs remains empty in DRY_RUN.
python -m pytest (vk-python) passes.
python scripts/validate_clickhouse_schema.py reports success.
CI workflow updated (if needed) and runs successfully (local dry run acceptable if CI not accessible).
Documentation, audit report, and changelog reflect new state with command outputs/links.
No residual TODOs or unaddressed duplicates remain.
Deliverables
Cleaned SQL files in dashboard-mvp/infra/clickhouse/ and related directories.
Updated scripts (bootstrap_clickhouse.sh, smoke script if necessary).
Updated documentation (README, changelog, ADR, audit report).
Log snippets or summarized results from required validations/tests.
Notes
Coordinate with data consumers before dropping/recreating production tables. Provide migration steps if data backfill is required.
If certain historical migrations are obsolete, consider archiving them but ensure they don’t run during bootstrap.
Maintain consistent env variable names (CLICKHOUSE_*) across scripts, docs, and sample env files.
Share final test logs with the team prior to deployment approval.