Задача: Привести ClickHouse-инфраструктуру и документацию к сдачному виду (готово к DataLens)

Входные данные / текущие проблемы

dashboard-mvp/infra/clickhouse/users.d/default-user.xml (и связанное 10-users.xml) содержат две разные версии пользователя admin_min. Пароли разные, сети разные, access_management в одном файле 0, в другом 1. Итог: ClickHouse не поднимается стабильно, инструкции в README не соответствуют факту, admin/admin_pass исчез.
users.d/datalens-user.xml жёстко задаёт пароль ChangeMe123!, но базируется на профиле и роли, объявленных в 10-users.xml. Если этот файл убрать или изменить – DataLens-учётка ломается. README при этом обещает готовые SELECT на zakaz.*, чего нет.
bootstrap_grants.sql по-прежнему делает GRANT-ы, которые не выполнятся при текущих правах, и содержит избыточные строки.
README (корневой и infra/clickhouse) расходятся с реальным содержимым файлов: перечисляют пользователей, пароли и шаги, которых в конфигурации теперь нет.
Нет гарантии, что на чистой машине bootstrap_clickhouse.sh + smoke_qtickets_dryrun.sh проходят без ручного редактирования конфигов.
Нужна финальная инструкция, где клиент делает git clone → bootstrap → smoke → grants → curl → подключение DataLens, и всё работает из коробки.
Цель

Подготовить репозиторий так, чтобы:

После git clone и запуска штатных скриптов (bootstrap_clickhouse.sh, smoke_qtickets_dryrun.sh) ClickHouse поднимается healthy, схема развёрнута, DataLens-учётка готова, и документация соответствует реальности.
Один источник правды для каждого пользователя (admin, datalens_reader, etl_writer и т.д.), без конфликтующих определений.
Админ, описанный в README, реально существует с указанными логинами/паролями и может выполнять GRANT ….
DataLens-инструкция рабочая: пользователь datalens_reader имеет READ на нужные объекты и не падает от конфигурации.
Шаги для разработчика

Определиться с перечнем пользователей и их правами

Зафиксировать целевой набор аккаунтов:
admin (или другое имя, но согласовать с README) — полный доступ + access_management=1.
datalens_reader — read-only на zakaz.* (и другие needed objects).
etl_writer, backup_user — если нужны для пайплайна.
Решить, какие файлы должны их содержать (один xml-файл на пользователя или группировать, но без дублей).
Удалить противоречащие определения (на текущий момент users.d/default-user.xml + users.d/10-users.xml должны быть пересмотрены).
Привести XML-конфиги в порядок

users.d/default-user.xml:
Восстановить пользователя admin (или выбранное имя) с password, profile, networks, access_management=1.
Оставить только одно определение этого пользователя во всех файлах.
users.d/datalens-user.xml:
Оставить только необходимые блоки (password, profile или ссылка на существующий readonly_profile, networks).
Никаких <grants> внутри — ClickHouse это запрещает.
Если используем роли, роль должна быть объявлена в одном месте и загружаться до пользователя.
Placeholder-пароль снабдить комментарием и инструкцией по замене в README.
users.d/10-users.xml:
Либо удалить, либо привести к нужному состоянию (без дублей пользователей).
Если именно здесь хотите держать роли/квоты/профили — убедитесь, что нет повторов с другими файлами и что порядок загрузки валиден.
После правок локально убедиться, что docker compose up -d → контейнер стартует healthy.
Настроить bootstrap_grants.sql

Оставить только GRANT-ы, которые действительно нужны и выполняются штатным admin (у которого теперь access_management=1).
Не создавать пользователей внутри SQL — они идут через XML.
Минимальный набор: GRANT SELECT ON zakaz.* TO datalens_reader; плюс конкретика для etl_writer и других аккаунтов, если нужно.
Проверить выполнение: docker exec -i ch-zakaz … < bootstrap_grants.sql не должен возвращать ошибок.
Скрипты и автоматизация

Прогнать dashboard-mvp/scripts/bootstrap_clickhouse.sh на локальной/чистой машине: он должен:
создать директории,
поднять контейнер, дождаться healthy,
применить bootstrap_schema.sql,
вывести список таблиц, убедиться, что stg_qtickets_api_*, fact_*, meta_job_runs, v_qtickets_* в наличии.
Убедиться, что скрипт указывает корректные пользователи/пароли (берёт из .env). Если .env.example изменялся — синхронизировать.
Прогнать dashboard-mvp/scripts/smoke_qtickets_dryrun.sh:
Проверить, что DRY_RUN не пишет в meta_job_runs;
Контейнер завершается с кодом 0;
Скрипт сообщает об успехе.
Если обнаружатся зависимости на старые переменные (например, CLICKHOUSE_DATABASE vs CLICKHOUSE_DB) — привести к одному стандарту.
Документация

Обновить dashboard-mvp/infra/clickhouse/README.md и dashboard-mvp/README.md:
Описать текущих пользователей с их паролями-плейсхолдерами и правами.
Привести последовательность команд “копипастой”:
cd …/infra/clickhouse && cp .env.example .env
../../scripts/bootstrap_clickhouse.sh
(Опционально) docker exec … < bootstrap_grants.sql
cd .. && ./scripts/smoke_qtickets_dryrun.sh
Проверки curl и clickhouse-client под datalens_reader.
Инструкция по смене пароля и подключению DataLens.
Обязательно указать, что нужно перезапустить контейнер после смены пароля в XML.
Держать README и реальную конфигурацию в полном соответствии. Любая команда из документации должна выполняться без правок.
Финальная проверка

Задокументировать (можно в комментарии к задаче) логи всех ключевых шагов на чистой машине/обнулённом volume:
docker inspect -f '{{.State.Health.Status}}' ch-zakaz → healthy.
docker exec ch-zakaz clickhouse-client --user=admin … -q "GRANT SELECT …" → успешный вывод.
docker exec ch-zakaz clickhouse-client --user=datalens_reader … -q "SELECT count() FROM system.tables WHERE database='zakaz';" → реальное число.
curl -u datalens_reader:… http://localhost:8123/?query=SELECT%201 → 1.
Скрин/лог DataLens подключения (можно по записи).
Логи smoke_qtickets_dryrun.sh.
Changelog/Аудит (если ведёте)

Внесите запись о том, что добавлены правки с ссылкой на конкретные файлы и инструкцию.
Критерии приёмки

Контейнер ch-zakaz после bootstrap_clickhouse.sh становится healthy без ручного редактирования XML.
README-шаги выполняются “копипастой” на чистой машине, нет несоответствий имен/паролей.
datalens_reader создаётся автоматически и проходит проверки curl/clickhouse-client.
admin (из README) умеет делать GRANT без изменения конфигов.
smoke_qtickets_dryrun.sh заканчивается успехом, meta_job_runs не пополняется.
В репозитории нет дублирующихся определений пользователей и конфликтующих паролей.
Задача сопровождается логами/выводами команд, подтверждающими готовность.
Только после выполнения всех пунктов репозиторий считается готовым к повторному развёртыванию у заказчика и подключению к Yandex DataLens.